<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sourcing Analyst & Reporting</title>
  <meta name="description" content="ACM + Sourcing Analyst + Performance (Client/Area/Jobtype) dengan filter Tahun (kolom AK) + fix dropdown Provinsi + grafik bulanan valid/buffer akurat." />

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --brand:#1d4ed8;
      --brand2:#2563eb;
      --brand-soft:#e8f0ff;
      --line:#e5e7eb;
      --radius:18px;
      --shadow:0 18px 50px rgba(15,23,42,.10);
      --shadow2:0 10px 28px rgba(15,23,42,.10);
      --ok:#059669;
      --warn:#f97316;
      --bad:#dc2626;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:Montserrat, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 700px at 10% -10%, rgba(37,99,235,.18), transparent 60%),
        radial-gradient(900px 600px at 80% 0%, rgba(29,78,216,.12), transparent 55%),
        radial-gradient(1000px 700px at 60% 120%, rgba(5,150,105,.10), transparent 55%),
        var(--bg);
    }
    a{ color:inherit; text-decoration:none; }

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      background: rgba(245,247,251,.72);
      border-bottom:1px solid rgba(229,231,235,.8);
    }
    .topbar::before{
      content:"";
      position:absolute; inset:-60px 0 auto 0;
      height:60px;
      background: linear-gradient(to bottom, rgba(245,247,251,1), rgba(245,247,251,0));
      pointer-events:none;
    }
    .topbar-inner{
      position:relative;
      max-width:1200px; margin:0 auto;
      padding:14px 18px;
      display:flex; align-items:center; justify-content:space-between;
      gap:14px;
    }
    .brand{
      display:flex; align-items:center; gap:10px; min-width:220px;
    }
    .logo{
      width:40px; height:40px; border-radius:14px;
      background: linear-gradient(135deg, rgba(29,78,216,1), rgba(37,99,235,1));
      box-shadow: 0 12px 28px rgba(29,78,216,.25);
      display:grid; place-items:center;
      color:#fff; font-weight:800;
      letter-spacing:.5px;
    }
    .brand-title{
      line-height:1.05;
    }
    .brand-title b{ display:block; font-size:14px; }
    .brand-title span{ font-size:12px; color:var(--muted); }

    .tabs{
      display:flex; align-items:center; gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .tab{
      border:1px solid rgba(229,231,235,.9);
      background:rgba(255,255,255,.7);
      padding:9px 12px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      transition:.18s ease;
      box-shadow: 0 10px 22px rgba(15,23,42,.05);
      user-select:none;
    }
    .tab:hover{ transform: translateY(-1px); }
    .tab.active{
      color:var(--brand);
      border-color: rgba(37,99,235,.35);
      background: rgba(232,240,255,.8);
      box-shadow: 0 12px 26px rgba(29,78,216,.12);
      font-weight:700;
    }

    /* Layout */
    .wrap{ max-width:1200px; margin:0 auto; padding:18px; }
    .page{ display:none; }
    .page.active{ display:block; }

    .hero{
      display:flex; align-items:flex-end; justify-content:space-between;
      gap:14px;
      margin-top:6px;
      margin-bottom:12px;
    }
    .hero h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .hero p{ margin:6px 0 0 0; color:var(--muted); font-size:12px; }
    .hero .right{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;
    }

    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.75);
      border:1px solid rgba(229,231,235,.9);
      box-shadow: 0 10px 22px rgba(15,23,42,.05);
      font-size:12px; color:var(--muted);
    }
    .chip b{ color:var(--ink); }

    .card{
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(229,231,235,.9);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 16px;
      border-bottom:1px solid rgba(229,231,235,.7);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .card .hd .title{ font-weight:800; font-size:13px; }
    .card .hd .sub{ font-size:12px; color:var(--muted); }
    .card .bd{ padding:14px 16px; }

    .grid-3{ display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:12px; }
    .grid-2{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px; }
    .grid-4{ display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px; }
    @media (max-width: 980px){
      .grid-3,.grid-4,.grid-2{ grid-template-columns:1fr; }
      .brand{ min-width:auto; }
      .tabs{ justify-content:flex-start; }
    }

    .kpi{
      padding:14px;
      border-radius:16px;
      background: rgba(255,255,255,.86);
      border:1px solid rgba(229,231,235,.9);
      box-shadow: var(--shadow2);
      min-height:76px;
    }
    .kpi .label{ font-size:12px; color:var(--muted); }
    .kpi .value{ margin-top:6px; font-size:22px; font-weight:900; letter-spacing:.2px; }
    .kpi .hint{ margin-top:4px; font-size:11px; color:var(--muted); }

    /* Filters */
    .filters, .sa-filters, .perf-filters{
      display:grid;
      gap:12px;
      align-items:end;
    }
    .filters{ grid-template-columns: repeat(6, minmax(0,1fr)); }     /* + Tahun */
    .sa-filters{ grid-template-columns: repeat(5, minmax(0,1fr)); }  /* + Tahun */
    .perf-filters{ grid-template-columns: repeat(4, minmax(0,1fr)); }/* + Tahun */
    @media (max-width: 980px){
      .filters, .sa-filters, .perf-filters{ grid-template-columns:1fr; }
    }

    .filter-group{ display:flex; flex-direction:column; gap:6px; }
    .filter-label{ font-size:12px; color:var(--muted); font-weight:700; }
    .select, .perf-select{
      appearance:none;
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(229,231,235,.95);
      background: rgba(255,255,255,.88);
      font-family:inherit;
      font-size:12px;
      outline:none;
      box-shadow: 0 10px 22px rgba(15,23,42,.05);
    }

    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      gap:10px;
      border:1px solid rgba(37,99,235,.25);
      background: rgba(232,240,255,.85);
      color: var(--brand);
      padding:10px 12px;
      border-radius:14px;
      font-size:12px;
      font-weight:800;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 12px 26px rgba(29,78,216,.10);
      transition:.18s ease;
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn.ghost{
      border:1px solid rgba(229,231,235,.95);
      background: rgba(255,255,255,.78);
      color: var(--muted);
      box-shadow: 0 10px 22px rgba(15,23,42,.05);
      font-weight:800;
    }

    /* Multi-select */
    .ms{ position:relative; }
    .ms-toggle{
      width:100%;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(229,231,235,.95);
      background: rgba(255,255,255,.88);
      font-family:inherit;
      font-size:12px;
      outline:none;
      box-shadow: 0 10px 22px rgba(15,23,42,.05);
      cursor:pointer;
    }
    .ms-placeholder{ color:var(--ink); font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .ms-counter{ color:var(--muted); font-weight:700; margin-left:auto; }
    .ms-arrow{ color:var(--muted); font-weight:900; }

    .ms-panel{
      position:absolute; left:0; right:0; top:calc(100% + 8px);
      border-radius:16px;
      border:1px solid rgba(229,231,235,.95);
      background: rgba(255,255,255,.92);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:none;
      z-index:40;
    }
    .ms.open .ms-panel{ display:block; }
    .ms-search{
      width:100%;
      border:0;
      border-bottom:1px solid rgba(229,231,235,.7);
      padding:10px 12px;
      font-family:inherit;
      font-size:12px;
      outline:none;
      background: rgba(255,255,255,.85);
    }
    .ms-options{
      max-height:220px;
      overflow:auto;
      padding:8px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .ms-opt{
      display:flex; align-items:center; gap:10px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(229,231,235,.7);
      background: rgba(255,255,255,.85);
      cursor:pointer;
      user-select:none;
    }
    .ms-opt:hover{ border-color: rgba(37,99,235,.25); background: rgba(232,240,255,.55); }
    .ms-opt input{ margin:0; }
    .ms-opt span{ font-size:12px; }
    .ms-empty{
      display:none;
      padding:12px;
      font-size:12px;
      color:var(--muted);
      text-align:center;
    }

    /* Tables */
    table{ width:100%; border-collapse:separate; border-spacing:0; }
    th,td{ padding:10px 10px; border-bottom:1px solid rgba(229,231,235,.7); font-size:12px; }
    th{ text-align:left; color:var(--muted); font-weight:800; background: rgba(255,255,255,.65); position:sticky; top:0; z-index:1; }
    tr:hover td{ background: rgba(232,240,255,.35); }
    .nowrap{ white-space:nowrap; }
    .right{ text-align:right; }
    .muted{ color:var(--muted); }

    /* Chart */
    .chart{
      width:100%;
      height:260px;
      border-radius:16px;
      border:1px solid rgba(229,231,235,.9);
      background: rgba(255,255,255,.86);
      box-shadow: var(--shadow2);
      padding:12px;
      overflow:hidden;
    }
    .bars{
      display:flex; gap:6px; align-items:flex-end;
      height:100%;
      padding:4px 2px 22px 2px;
    }
    .bar-col{
      flex:1;
      display:flex;
      flex-direction:column;
      justify-content:flex-end;
      gap:4px;
      min-width:0;
    }
    .bar{
      width:100%;
      border-radius:10px 10px 10px 10px;
      background: rgba(29,78,216,.25);
      border: 1px solid rgba(29,78,216,.25);
      min-height:2px;
    }
    .bar2{
      background: rgba(5,150,105,.22);
      border:1px solid rgba(5,150,105,.22);
    }
    .bar-label{
      position:relative;
      top:18px;
      font-size:10px;
      color:var(--muted);
      text-align:center;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Skeleton */
    .skeleton{
      border-radius:16px;
      border:1px solid rgba(229,231,235,.9);
      background: rgba(255,255,255,.78);
      box-shadow: var(--shadow2);
      overflow:hidden;
      position:relative;
      min-height: 86px;
    }
    .skeleton::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(229,231,235,.0), rgba(229,231,235,.55), rgba(229,231,235,.0));
      transform: translateX(-100%);
      animation: shimmer 1.2s infinite;
    }
    @keyframes shimmer{
      0%{ transform: translateX(-100%); }
      100%{ transform: translateX(100%); }
    }

    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      padding:10px 12px; border-radius:999px;
      background: rgba(15,23,42,.88);
      color:#fff;
      font-size:12px;
      box-shadow: 0 18px 40px rgba(15,23,42,.35);
      display:none;
      z-index:80;
    }
    .toast.show{ display:block; }

    .note{
      font-size:12px;
      color:var(--muted);
      margin-top:10px;
      line-height:1.6;
    }
    .dot{
      width:8px; height:8px; border-radius:999px; display:inline-block;
      background: rgba(29,78,216,.9);
      box-shadow: 0 8px 18px rgba(29,78,216,.25);
    }
    .dot.g{ background: rgba(5,150,105,.95); box-shadow: 0 8px 18px rgba(5,150,105,.25); }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">SI</div>
        <div class="brand-title">
          <b>Sourcing Analyst & Reporting</b>
          <span>ACM · Sourcing Analyst · Performance</span>
        </div>
      </div>

      <div class="tabs" id="tabs">
        <div class="tab active" data-page="acm">ACM</div>
        <div class="tab" data-page="sa">Sourcing Analyst</div>
        <div class="tab" data-page="pc">Performance Client</div>
        <div class="tab" data-page="pa">Performance Area</div>
        <div class="tab" data-page="pj">Performance Jobtype</div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- PAGE: ACM -->
    <section class="page active" id="page-acm">
      <div class="hero">
        <div>
          <h1>Applicant Cycle Management (ACM)</h1>
          <p>Filter Provinsi tidak kosong + grafik bulanan valid/buffer akurat + filter Tahun (kolom AK).</p>
        </div>
        <div class="right">
          <span class="chip"><span class="dot"></span> <b>Valid</b></span>
          <span class="chip"><span class="dot g"></span> <b>Buffer</b></span>
          <button class="btn ghost" id="btn-reload">Reload Data</button>
          <button class="btn" id="btn-clear-acm">Clear Filter</button>
        </div>
      </div>

      <div class="card" style="margin-bottom:12px;">
        <div class="hd">
          <div>
            <div class="title">Filter</div>
            <div class="sub" id="acm-status">Memuat data...</div>
          </div>
        </div>
        <div class="bd">
          <div class="filters">
            <div class="filter-group">
              <label class="filter-label">Periode Pelamar</label>
              <div class="ms" id="ms-periode">
                <button type="button" class="ms-toggle">
                  <span class="ms-placeholder">Semua Periode</span>
                  <span class="ms-counter"></span><span class="ms-arrow">▾</span>
                </button>
                <div class="ms-panel">
                  <input class="ms-search" type="text" placeholder="Cari periode..." />
                  <div class="ms-options"></div><div class="ms-empty">Tidak ada periode</div>
                </div>
              </div>
            </div>

            <div class="filter-group">
              <label class="filter-label">Tahun</label>
              <div class="ms" id="ms-year">
                <button type="button" class="ms-toggle">
                  <span class="ms-placeholder">Semua Tahun</span>
                  <span class="ms-counter"></span><span class="ms-arrow">▾</span>
                </button>
                <div class="ms-panel">
                  <input class="ms-search" type="text" placeholder="Cari tahun..." />
                  <div class="ms-options"></div><div class="ms-empty">Tidak ada tahun</div>
                </div>
              </div>
            </div>

            <div class="filter-group">
              <label class="filter-label">Industry</label>
              <select id="f-industry" class="select"></select>
            </div>

            <div class="filter-group">
              <label class="filter-label">Client</label>
              <select id="f-client" class="select"></select>
            </div>

            <div class="filter-group">
              <label class="filter-label">Provinsi</label>
              <select id="f-prov" class="select"></select>
            </div>

            <div class="filter-group">
              <label class="filter-label">Kota</label>
              <select id="f-kota" class="select"></select>
            </div>
          </div>

          <div style="height:10px;"></div>

          <div class="filters">
            <div class="filter-group">
              <label class="filter-label">Job Parent</label>
              <select id="f-jobparent" class="select"></select>
            </div>

            <div class="filter-group">
              <label class="filter-label">Job Type</label>
              <select id="f-jobtype" class="select"></select>
            </div>

            <div class="filter-group">
              <label class="filter-label">Kategori</label>
              <select id="f-kategori" class="select"></select>
            </div>

            <div class="filter-group">
              <label class="filter-label">Qualified (Yes/No)</label>
              <select id="f-qualified" class="select"></select>
            </div>

            <div class="filter-group" style="grid-column: span 2;">
              <label class="filter-label">Catatan</label>
              <div class="chip" style="width:100%; justify-content:space-between;">
                <span class="muted">Buffer = Qualified Yes <b>dan bukan</b> kategori valid</span>
                <span class="muted">· Tahun dari kolom AK</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid-4" style="margin-bottom:12px;">
        <div class="kpi">
          <div class="label">Total Rows</div>
          <div class="value" id="kpi-total">—</div>
          <div class="hint" id="kpi-total-h">Setelah filter</div>
        </div>
        <div class="kpi">
          <div class="label">Aplikan Valid</div>
          <div class="value" id="kpi-valid">—</div>
          <div class="hint">Kategori valid</div>
        </div>
        <div class="kpi">
          <div class="label">Buffer</div>
          <div class="value" id="kpi-buffer">—</div>
          <div class="hint">Qualified Yes & bukan valid</div>
        </div>
        <div class="kpi">
          <div class="label">Qualified Yes</div>
          <div class="value" id="kpi-qyes">—</div>
          <div class="hint">Semua yang qualified</div>
        </div>
      </div>

      <div class="grid-2">
        <div class="card">
          <div class="hd">
            <div>
              <div class="title">Grafik Bulanan (Jan–Des)</div>
              <div class="sub">Valid (biru) vs Buffer (hijau)</div>
            </div>
          </div>
          <div class="bd">
            <div class="chart" id="chart-acm"></div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <div>
              <div class="title">Ringkasan by Kategori</div>
              <div class="sub">Top 10 kategori berdasarkan jumlah</div>
            </div>
          </div>
          <div class="bd">
            <div style="max-height:320px; overflow:auto;">
              <table>
                <thead>
                  <tr>
                    <th>Kategori</th>
                    <th class="right">Count</th>
                  </tr>
                </thead>
                <tbody id="tbl-kategori"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: SA -->
    <section class="page" id="page-sa">
      <div class="hero">
        <div>
          <h1>Sourcing Analyst</h1>
          <p>Analisis distribusi Job Parent, filter Tahun + dependent options (Industry/Client/Area/Job Parent).</p>
        </div>
        <div class="right">
          <button class="btn" id="btn-clear-sa">Clear Filter</button>
        </div>
      </div>

      <div class="card" style="margin-bottom:12px;">
        <div class="hd">
          <div>
            <div class="title">Filter Sourcing Analyst</div>
            <div class="sub" id="sa-status">Menunggu data ACM...</div>
          </div>
        </div>
        <div class="bd">
          <div class="sa-filters">
            <div class="filter-group">
              <label class="filter-label">Tahun</label>
              <div class="ms" id="sa-ms-year">
                <button type="button" class="ms-toggle">
                  <span class="ms-placeholder">Semua Tahun</span>
                  <span class="ms-counter"></span><span class="ms-arrow">▾</span>
                </button>
                <div class="ms-panel">
                  <input class="ms-search" type="text" placeholder="Cari tahun..." />
                  <div class="ms-options"></div><div class="ms-empty">Tidak ada tahun</div>
                </div>
              </div>
            </div>

            <div class="filter-group">
              <label class="filter-label">Industry</label>
              <select id="sa-industry" class="select"></select>
            </div>

            <div class="filter-group">
              <label class="filter-label">Client</label>
              <select id="sa-client" class="select"></select>
            </div>

            <div class="filter-group">
              <label class="filter-label">Area</label>
              <select id="sa-area" class="select"></select>
            </div>

            <div class="filter-group">
              <label class="filter-label">Job Parent</label>
              <select id="sa-jobparent" class="select"></select>
            </div>
          </div>
        </div>
      </div>

      <div class="grid-3" style="margin-bottom:12px;">
        <div class="kpi">
          <div class="label">Rows (filtered)</div>
          <div class="value" id="sa-kpi-rows">—</div>
          <div class="hint" id="sa-kpi-hint">Semua tahun</div>
        </div>
        <div class="kpi">
          <div class="label">Valid</div>
          <div class="value" id="sa-kpi-valid">—</div>
          <div class="hint">Kategori valid</div>
        </div>
        <div class="kpi">
          <div class="label">Buffer</div>
          <div class="value" id="sa-kpi-buffer">—</div>
          <div class="hint">Qualified Yes & bukan valid</div>
        </div>
      </div>

      <div class="grid-2">
        <div class="card">
          <div class="hd">
            <div>
              <div class="title">Top Job Parent</div>
              <div class="sub">Berdasarkan jumlah rows</div>
            </div>
          </div>
          <div class="bd">
            <div style="max-height:340px; overflow:auto;">
              <table>
                <thead>
                  <tr>
                    <th>Job Parent</th>
                    <th class="right">Rows</th>
                    <th class="right">Valid</th>
                    <th class="right">Buffer</th>
                  </tr>
                </thead>
                <tbody id="sa-tbl"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <div>
              <div class="title">Grafik Bulanan (Jan–Des)</div>
              <div class="sub">Valid vs Buffer (setelah filter)</div>
            </div>
          </div>
          <div class="bd">
            <div class="chart" id="chart-sa"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: Performance Client -->
    <section class="page" id="page-pc">
      <div class="hero">
        <div>
          <h1>Performance Client</h1>
          <p>Filter Tahun + Industry + Client. Grafik bulanan valid/buffer.</p>
        </div>
        <div class="right">
          <button class="btn" id="btn-clear-pc">Clear Filter</button>
        </div>
      </div>

      <div class="card" style="margin-bottom:12px;">
        <div class="hd">
          <div>
            <div class="title">Filter Performance Client</div>
            <div class="sub" id="pc-status-text">Memuat data...</div>
          </div>
        </div>
        <div class="bd">
          <div class="perf-filters">
            <div class="filter-group">
              <label class="filter-label">Tahun</label>
              <select id="pc-year" class="perf-select">
                <option value="">Semua Tahun</option>
              </select>
            </div>

            <div class="filter-group">
              <label class="filter-label">Industry</label>
              <select id="pc-industry" class="perf-select"></select>
            </div>

            <div class="filter-group">
              <label class="filter-label">Client</label>
              <select id="pc-client" class="perf-select"></select>
            </div>

            <div class="filter-group">
              <label class="filter-label">Keterangan</label>
              <div class="chip" style="width:100%; justify-content:space-between;">
                <span class="muted">Data source: Performance Client CSV</span>
                <span class="muted">· Tahun kolom AK</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid-2">
        <div class="card">
          <div class="hd">
            <div>
              <div class="title">Grafik Bulanan</div>
              <div class="sub">Valid vs Buffer</div>
            </div>
          </div>
          <div class="bd"><div class="chart" id="chart-pc"></div></div>
        </div>

        <div class="card">
          <div class="hd">
            <div>
              <div class="title">Ringkasan</div>
              <div class="sub">KPI setelah filter</div>
            </div>
          </div>
          <div class="bd">
            <div class="grid-2">
              <div class="kpi">
                <div class="label">Rows</div>
                <div class="value" id="pc-kpi-rows">—</div>
                <div class="hint" id="pc-kpi-h">Filtered</div>
              </div>
              <div class="kpi">
                <div class="label">Valid</div>
                <div class="value" id="pc-kpi-valid">—</div>
                <div class="hint">Kategori valid</div>
              </div>
              <div class="kpi">
                <div class="label">Buffer</div>
                <div class="value" id="pc-kpi-buffer">—</div>
                <div class="hint">Qualified Yes & bukan valid</div>
              </div>
              <div class="kpi">
                <div class="label">Qualified Yes</div>
                <div class="value" id="pc-kpi-qyes">—</div>
                <div class="hint">Semua qualified</div>
              </div>
            </div>
            <div class="note">Catatan: definisi buffer dibuat <b>mutually exclusive</b> terhadap valid agar grafik tidak dobel hitung.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: Performance Area -->
    <section class="page" id="page-pa">
      <div class="hero">
        <div>
          <h1>Performance Area</h1>
          <p>Filter Tahun + Group + Area. Grafik bulanan valid/buffer.</p>
        </div>
        <div class="right">
          <button class="btn" id="btn-clear-pa">Clear Filter</button>
        </div>
      </div>

      <div class="card" style="margin-bottom:12px;">
        <div class="hd">
          <div>
            <div class="title">Filter Performance Area</div>
            <div class="sub" id="pa-status-text">Memuat data...</div>
          </div>
        </div>
        <div class="bd">
          <div class="perf-filters">
            <div class="filter-group">
              <label class="filter-label">Tahun</label>
              <select id="pa-year" class="perf-select">
                <option value="">Semua Tahun</option>
              </select>
            </div>

            <div class="filter-group">
              <label class="filter-label">Group</label>
              <select id="pa-group" class="perf-select"></select>
            </div>

            <div class="filter-group">
              <label class="filter-label">Area</label>
              <select id="pa-area" class="perf-select"></select>
            </div>

            <div class="filter-group">
              <label class="filter-label">Keterangan</label>
              <div class="chip" style="width:100%; justify-content:space-between;">
                <span class="muted">Data source: Performance Area CSV</span>
                <span class="muted">· Tahun kolom AK</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid-2">
        <div class="card">
          <div class="hd">
            <div>
              <div class="title">Grafik Bulanan</div>
              <div class="sub">Valid vs Buffer</div>
            </div>
          </div>
          <div class="bd"><div class="chart" id="chart-pa"></div></div>
        </div>

        <div class="card">
          <div class="hd">
            <div>
              <div class="title">Ringkasan</div>
              <div class="sub">KPI setelah filter</div>
            </div>
          </div>
          <div class="bd">
            <div class="grid-2">
              <div class="kpi">
                <div class="label">Rows</div>
                <div class="value" id="pa-kpi-rows">—</div>
                <div class="hint">Filtered</div>
              </div>
              <div class="kpi">
                <div class="label">Valid</div>
                <div class="value" id="pa-kpi-valid">—</div>
                <div class="hint">Kategori valid</div>
              </div>
              <div class="kpi">
                <div class="label">Buffer</div>
                <div class="value" id="pa-kpi-buffer">—</div>
                <div class="hint">Qualified Yes & bukan valid</div>
              </div>
              <div class="kpi">
                <div class="label">Qualified Yes</div>
                <div class="value" id="pa-kpi-qyes">—</div>
                <div class="hint">Semua qualified</div>
              </div>
            </div>
            <div class="note">Group biasanya = Industry/Cluster. Area biasanya lokasi/region.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: Performance Jobtype -->
    <section class="page" id="page-pj">
      <div class="hero">
        <div>
          <h1>Performance Jobtype</h1>
          <p>Filter Tahun + Job Parent + Area + Job Type. Grafik bulanan valid/buffer.</p>
        </div>
        <div class="right">
          <button class="btn" id="btn-clear-pj">Clear Filter</button>
        </div>
      </div>

      <div class="card" style="margin-bottom:12px;">
        <div class="hd">
          <div>
            <div class="title">Filter Performance Jobtype</div>
            <div class="sub" id="pj-status-text">Memuat data...</div>
          </div>
        </div>
        <div class="bd">
          <div class="perf-filters">
            <div class="filter-group">
              <label class="filter-label">Tahun</label>
              <select id="pj-year" class="perf-select">
                <option value="">Semua Tahun</option>
              </select>
            </div>

            <div class="filter-group">
              <label class="filter-label">Job Parent</label>
              <select id="pj-parent" class="perf-select"></select>
            </div>

            <div class="filter-group">
              <label class="filter-label">Area</label>
              <select id="pj-area" class="perf-select"></select>
            </div>

            <div class="filter-group">
              <label class="filter-label">Job Type</label>
              <select id="pj-type" class="perf-select"></select>
            </div>
          </div>
        </div>
      </div>

      <div class="grid-2">
        <div class="card">
          <div class="hd">
            <div>
              <div class="title">Grafik Bulanan</div>
              <div class="sub">Valid vs Buffer</div>
            </div>
          </div>
          <div class="bd"><div class="chart" id="chart-pj"></div></div>
        </div>

        <div class="card">
          <div class="hd">
            <div>
              <div class="title">Ringkasan</div>
              <div class="sub">KPI setelah filter</div>
            </div>
          </div>
          <div class="bd">
            <div class="grid-2">
              <div class="kpi">
                <div class="label">Rows</div>
                <div class="value" id="pj-kpi-rows">—</div>
                <div class="hint">Filtered</div>
              </div>
              <div class="kpi">
                <div class="label">Valid</div>
                <div class="value" id="pj-kpi-valid">—</div>
                <div class="hint">Kategori valid</div>
              </div>
              <div class="kpi">
                <div class="label">Buffer</div>
                <div class="value" id="pj-kpi-buffer">—</div>
                <div class="hint">Qualified Yes & bukan valid</div>
              </div>
              <div class="kpi">
                <div class="label">Qualified Yes</div>
                <div class="value" id="pj-kpi-qyes">—</div>
                <div class="hint">Semua qualified</div>
              </div>
            </div>
            <div class="note">Tip: kalau chart masih “aneh”, biasanya karena kolom Periode kosong → mapping bulan gagal.</div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /******************************************************************
     * CONFIG — ganti URL CSV sesuai sheet kamu
     ******************************************************************/
    const CONFIG = {
      // ACM + Sourcing Analyst (biasanya dari "Responses")
      ACM_CSV_URL: "PASTE_YOUR_ACM_CSV_URL_HERE",

      // Performance pages (kalau pakai sheet berbeda, isi URL berbeda)
      PERF_CLIENT_CSV_URL: "PASTE_YOUR_PERF_CLIENT_CSV_URL_HERE",
      PERF_AREA_CSV_URL: "PASTE_YOUR_PERF_AREA_CSV_URL_HERE",
      PERF_JOBTYPE_CSV_URL: "PASTE_YOUR_PERF_JOBTYPE_CSV_URL_HERE",
    };

    /******************************************************************
     * DOM helpers
     ******************************************************************/
    const $ = (id)=>document.getElementById(id);
    const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
    const trimStr = (v)=>String(v ?? "").trim();

    function toast(msg){
      const el = $("toast");
      el.textContent = msg;
      el.classList.add("show");
      setTimeout(()=>el.classList.remove("show"), 2200);
    }

    function uniqueSorted(arr){
      const s = new Set();
      arr.forEach(v=>{
        const t = trimStr(v);
        if(t) s.add(t);
      });
      return Array.from(s).sort((a,b)=>a.localeCompare(b, "id"));
    }

    function safeNum(n){ const x = Number(n); return Number.isFinite(x) ? x : 0; }

    /******************************************************************
     * MultiSelect (search + checkbox)
     ******************************************************************/
    function createMultiSelect(rootId, options, placeholder="Pilih", defaultAll=false, onChange=null){
      const root = $(rootId);
      if(!root) return null;

      const toggle = root.querySelector(".ms-toggle");
      const panel = root.querySelector(".ms-panel");
      const search = root.querySelector(".ms-search");
      const optWrap = root.querySelector(".ms-options");
      const empty = root.querySelector(".ms-empty");
      const ph = root.querySelector(".ms-placeholder");
      const counter = root.querySelector(".ms-counter");

      let stateOptions = (options || []).map(v=>trimStr(v)).filter(Boolean);
      let selected = new Set();

      const closeAll = ()=>{
        $$(".ms.open").forEach(x=>x.classList.remove("open"));
      };

      const render = ()=>{
        const q = trimStr(search.value).toLowerCase();
        optWrap.innerHTML = "";

        const filtered = stateOptions.filter(v=>v.toLowerCase().includes(q));
        empty.style.display = filtered.length ? "none" : "block";

        filtered.forEach(v=>{
          const row = document.createElement("div");
          row.className = "ms-opt";
          row.innerHTML = `
            <input type="checkbox" ${selected.has(v) ? "checked": ""} />
            <span title="${escapeHtml(v)}">${escapeHtml(v)}</span>
          `;
          row.addEventListener("click", (e)=>{
            e.preventDefault();
            if(selected.has(v)) selected.delete(v);
            else selected.add(v);
            renderHeader();
            render(); // refresh checkboxes
            onChange && onChange();
          });
          optWrap.appendChild(row);
        });

        renderHeader();
      };

      const renderHeader = ()=>{
        const c = selected.size;
        counter.textContent = c ? `(${c})` : "";
        ph.textContent = c ? `${c} dipilih` : placeholder;
      };

      const setOptions = (newOptions)=>{
        stateOptions = (newOptions || []).map(v=>trimStr(v)).filter(Boolean);
        // keep selection if still exists
        const nextSel = new Set();
        selected.forEach(v=>{ if(stateOptions.includes(v)) nextSel.add(v); });
        selected = nextSel;
        if(defaultAll && !selected.size){
          stateOptions.forEach(v=>selected.add(v));
        }
        render();
      };

      const getSelected = ()=>Array.from(selected);

      const clear = ()=>{
        selected.clear();
        render();
        onChange && onChange();
      };

      if(defaultAll){
        stateOptions.forEach(v=>selected.add(v));
      }

      toggle.addEventListener("click",(e)=>{
        e.preventDefault();
        const isOpen = root.classList.contains("open");
        closeAll();
        if(!isOpen) root.classList.add("open");
      });
      document.addEventListener("click",(e)=>{
        if(!root.contains(e.target)) root.classList.remove("open");
      });
      search.addEventListener("input", render);

      render();

      return { setOptions, getSelected, clear };
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /******************************************************************
     * CSV loader (PapaParse)
     ******************************************************************/
    function loadCsv(url){
      return new Promise((resolve, reject)=>{
        if(!url || url.includes("PASTE_YOUR")) {
          reject(new Error("URL CSV belum diisi di CONFIG."));
          return;
        }
        Papa.parse(url, {
          download:true,
          header:true,
          skipEmptyLines:true,
          dynamicTyping:false,
          complete: (res)=>{
            if(res.errors && res.errors.length){
              console.warn("CSV parse errors:", res.errors);
            }
            resolve({ rows: res.data || [], fields: res.meta?.fields || [] });
          },
          error: (err)=>reject(err)
        });
      });
    }

    /******************************************************************
     * Column utilities
     ******************************************************************/
    function findField(fields, candidates){
      const fset = new Set(fields.map(f=>trimStr(f).toUpperCase()));
      for(const c of candidates){
        const key = String(c).trim().toUpperCase();
        if(fset.has(key)){
          // return original cased name
          return fields.find(x=>trimStr(x).toUpperCase()===key);
        }
      }
      // fuzzy contains
      for(const c of candidates){
        const key = String(c).trim().toUpperCase();
        const hit = fields.find(x=>trimStr(x).toUpperCase().includes(key));
        if(hit) return hit;
      }
      return null;
    }

    function colLetterToIndex(col){
      // A->0, B->1, ..., Z->25, AA->26 ...
      const s = String(col).trim().toUpperCase();
      let n = 0;
      for(let i=0;i<s.length;i++){
        const code = s.charCodeAt(i);
        if(code<65 || code>90) continue;
        n = n*26 + (code-64);
      }
      return n-1;
    }

    /******************************************************************
     * Date / Month / Year helpers
     ******************************************************************/
    function parseYearFromText(txt){
      const s = String(txt ?? "");
      const m = s.match(/\b(19\d{2}|20\d{2})\b/);
      return m ? m[1] : "";
    }

    function parseMonthIndexFromText(txt){
      // return 0..11 or -1
      const s = String(txt ?? "").trim();
      if(!s) return -1;

      // Try ISO / date-like
      const d = new Date(s);
      if(!isNaN(d.getTime())) return d.getMonth();

      // Try "Jan", "Feb", "Maret", "Mar", etc.
      const low = s.toLowerCase();
      const map = [
        ["jan",0],["janu",0],
        ["feb",1],["febr",1],
        ["mar",2],["maret",2],["march",2],
        ["apr",3],["apri",3],
        ["mei",4],["may",4],
        ["jun",5],["juni",5],
        ["jul",6],["juli",6],
        ["agu",7],["ags",7],["aug",7],["agustus",7],
        ["sep",8],["sept",8],["september",8],
        ["okt",9],["oct",9],["oktober",9],
        ["nov",10],["november",10],
        ["des",11],["dec",11],["desember",11],
      ];
      for(const [k,idx] of map){
        if(low.includes(k)) return idx;
      }

      // Try numeric month: "2026-02", "02/2026", "2-2026", etc.
      const m1 = low.match(/\b(0?[1-9]|1[0-2])\b/);
      if(m1) {
        const mm = parseInt(m1[1],10);
        if(mm>=1 && mm<=12) return mm-1;
      }
      return -1;
    }

    /******************************************************************
     * DEFINITIONS — valid/buffer/qualified logic
     ******************************************************************/
    function isYes(v){
      const s = trimStr(v).toLowerCase();
      return ["yes","ya","y","true","1"].includes(s);
    }

    // Kategori valid: kamu bisa tambah keyword lain di sini bila perlu
    function isKategoriValid(row){
      const k = trimStr(row?.[COL_KATEGORI]).toLowerCase();
      if(!k) return false;
      // aturan default: kategori mengandung "valid"
      // (kalau kamu pakai label lain seperti "CTC 1", tambahin di bawah)
      if(k.includes("valid")) return true;
      if(k.includes("ctc 1")) return true;
      if(k.includes("aplikan valid")) return true;
      return false;
    }

    function isQualifiedYes(row){
      return isYes(row?.[COL_QUALIFIED]);
    }

    function getValidFlag(row){ return isKategoriValid(row) ? 1 : 0; }

    // ✅ Buffer = qualified yes tapi bukan valid (mutually exclusive)
    function getBufferFlag(row){
      return (isQualifiedYes(row) && !isKategoriValid(row)) ? 1 : 0;
    }

    /******************************************************************
     * ACM GLOBALS
     ******************************************************************/
    let acmRows = [];
    let acmFields = [];
    let provKotaMap = new Map();

    // Columns (auto-detected)
    let COL_PERIODE = "PERIODE";
    let COL_YEAR = "TAHUN";
    let COL_INDUSTRY = "INDUSTRY";
    let COL_CLIENT = "CLIENT";
    let COL_PROV = "PROVINSI";
    let COL_KOTA = "KOTA";
    let COL_AREA = "AREA";
    let COL_JOBPARENT = "JOB PARENT";
    let COL_JOBTYPE = "JOB TYPE";
    let COL_KATEGORI = "KATEGORI";
    let COL_QUALIFIED = "QUALIFIED";

    // MultiSelect
    let msPeriode = null;
    let msYear = null;

    let GLOBAL_YEAR_OPTIONS = [];

    function detectACMColumns(fields){
      // Periode / Timestamp
      COL_PERIODE = findField(fields, ["PERIODE PELAMAR","PERIODE","TIMESTAMP","WAKTU"]) || fields[0] || "PERIODE";

      // Tahun (prefer header "TAHUN/YEAR", fallback kolom AK)
      const year = findField(fields, ["TAHUN","YEAR"]);
      const akField = fields[colLetterToIndex("AK")]; // kolom AK dari sheet Responses
      if(year) COL_YEAR = year;
      else if(akField) COL_YEAR = akField;

      COL_INDUSTRY = findField(fields, ["INDUSTRY","INDUSTRI","GROUP"]) || "INDUSTRY";
      COL_CLIENT = findField(fields, ["CLIENT","KLIEN","COMPANY","PERUSAHAAN"]) || "CLIENT";
      COL_PROV = findField(fields, ["PROVINSI","PROVINCE"]) || "PROVINSI";
      COL_KOTA = findField(fields, ["KOTA","CITY","KABUPATEN","KAB/KOTA"]) || "KOTA";
      COL_AREA = findField(fields, ["AREA","REGION","CABANG","BRANCH"]) || "AREA";
      COL_JOBPARENT = findField(fields, ["JOB PARENT","JOBPARENT","PARENT"]) || "JOB PARENT";
      COL_JOBTYPE = findField(fields, ["JOB TYPE","JOBTYPE","TYPE","JENIS"]) || "JOB TYPE";
      COL_KATEGORI = findField(fields, ["KATEGORI","CATEGORY","STATUS"]) || "KATEGORI";
      COL_QUALIFIED = findField(fields, ["QUALIFIED","QUALIFIED?","KUALIFIKASI","QUALIFIED YES/NO"]) || "QUALIFIED";
    }

    function getYearVal(row){
      const y1 = trimStr(row?.[COL_YEAR]);
      if(y1) return y1;
      return parseYearFromText(row?.[COL_PERIODE]) || "";
    }

    function buildProvKotaMap(){
      provKotaMap.clear();
      acmRows.forEach(r=>{
        const p = trimStr(r[COL_PROV]);
        const k = trimStr(r[COL_KOTA]);

        // ✅ provinsi masuk map walau kota kosong
        if(!p) return;
        if(!provKotaMap.has(p)) provKotaMap.set(p, new Set());
        if(k) provKotaMap.get(p).add(k);
      });
    }

    function setSelectOptions(selectId, values, placeholder="Semua"){
      const el = $(selectId);
      if(!el) return;
      const opts = [`<option value="">${escapeHtml(placeholder)}</option>`]
        .concat(values.map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`));
      el.innerHTML = opts.join("");
    }

    function setYearSelectOptions(selectId, years){
      const el = $(selectId);
      if(!el) return;
      const ys = (years && years.length) ? years : (GLOBAL_YEAR_OPTIONS || []);
      el.innerHTML = `<option value="">Semua Tahun</option>` + ys.map(y=>`<option value="${escapeHtml(y)}">${escapeHtml(y)}</option>`).join("");
    }

    function initACMFilters(){
      // Periode MS
      const periodeVals = uniqueSorted(acmRows.map(r=>r[COL_PERIODE]));
      msPeriode = createMultiSelect("ms-periode", periodeVals, "Semua Periode", false, ()=>updateACMAll());

      // Tahun MS (dari COL_YEAR / fallback)
      const yearVals = uniqueSorted(acmRows.map(r=>getYearVal(r))).filter(v=>v!=="");
      GLOBAL_YEAR_OPTIONS = yearVals;
      msYear = createMultiSelect("ms-year", yearVals, "Semua Tahun", false, ()=>updateACMAll());

      // Build prov-kota map (fix prov empty)
      buildProvKotaMap();

      // Industry options
      setSelectOptions("f-industry", uniqueSorted(acmRows.map(r=>r[COL_INDUSTRY])), "Semua Industry");
      setSelectOptions("f-client", uniqueSorted(acmRows.map(r=>r[COL_CLIENT])), "Semua Client");

      // ✅ Provinsi: jangan bergantung kota
      setSelectOptions("f-prov", uniqueSorted(acmRows.map(r=>r[COL_PROV])), "Semua Provinsi");
      setSelectOptions("f-kota", uniqueSorted(acmRows.map(r=>r[COL_KOTA])), "Semua Kota");

      setSelectOptions("f-jobparent", uniqueSorted(acmRows.map(r=>r[COL_JOBPARENT])), "Semua Job Parent");
      setSelectOptions("f-jobtype", uniqueSorted(acmRows.map(r=>r[COL_JOBTYPE])), "Semua Job Type");
      setSelectOptions("f-kategori", uniqueSorted(acmRows.map(r=>r[COL_KATEGORI])), "Semua Kategori");

      // Qualified options (normalize)
      const qVals = uniqueSorted(acmRows.map(r=>r[COL_QUALIFIED])).map(v=>v.toLowerCase());
      const qSet = new Set(qVals);
      const showQ = [];
      if(qSet.has("yes") || qSet.has("ya")) showQ.push("Yes");
      if(qSet.has("no") || qSet.has("tidak")) showQ.push("No");
      // fallback include whatever is present
      if(!showQ.length) showQ.push(...uniqueSorted(acmRows.map(r=>r[COL_QUALIFIED])));
      setSelectOptions("f-qualified", showQ, "Semua Qualified");

      // dependent: prov -> kota
      $("f-prov").addEventListener("change", ()=>{
        const p = $("f-prov").value;
        if(!p){
          setSelectOptions("f-kota", uniqueSorted(acmRows.map(r=>r[COL_KOTA])), "Semua Kota");
        } else {
          const cities = provKotaMap.has(p) ? Array.from(provKotaMap.get(p)) : [];
          setSelectOptions("f-kota", uniqueSorted(cities), "Semua Kota");
        }
        updateACMAll();
      });

      // industry -> client
      $("f-industry").addEventListener("change", ()=>{
        const ind = $("f-industry").value;
        if(!ind){
          setSelectOptions("f-client", uniqueSorted(acmRows.map(r=>r[COL_CLIENT])), "Semua Client");
        } else {
          const clients = uniqueSorted(acmRows.filter(r=>trimStr(r[COL_INDUSTRY])===ind).map(r=>r[COL_CLIENT]));
          setSelectOptions("f-client", clients, "Semua Client");
        }
        updateACMAll();
      });

      ["f-client","f-kota","f-jobparent","f-jobtype","f-kategori","f-qualified"].forEach(id=>{
        $(id).addEventListener("change", updateACMAll);
      });

      updateACMAll();
    }

    function getFilteredACMRows(){
      const periodeSel = new Set(msPeriode ? msPeriode.getSelected() : []);
      const yearSel = new Set(msYear ? msYear.getSelected() : []);

      const ind = $("f-industry").value;
      const client = $("f-client").value;
      const prov = $("f-prov").value;
      const kota = $("f-kota").value;
      const jp = $("f-jobparent").value;
      const jt = $("f-jobtype").value;
      const kat = $("f-kategori").value;
      const q = $("f-qualified").value;

      return acmRows.filter(r=>{
        const per = trimStr(r[COL_PERIODE]);
        const y = getYearVal(r);
        const i = trimStr(r[COL_INDUSTRY]);
        const c = trimStr(r[COL_CLIENT]);
        const p = trimStr(r[COL_PROV]);
        const k = trimStr(r[COL_KOTA]);
        const jpp = trimStr(r[COL_JOBPARENT]);
        const jtt = trimStr(r[COL_JOBTYPE]);
        const kk = trimStr(r[COL_KATEGORI]);
        const qq = trimStr(r[COL_QUALIFIED]);

        if(periodeSel.size && !periodeSel.has(per)) return false;
        if(yearSel.size && !yearSel.has(y)) return false;

        if(ind && i!==ind) return false;
        if(client && c!==client) return false;
        if(prov && p!==prov) return false;
        if(kota && k!==kota) return false;
        if(jp && jpp!==jp) return false;
        if(jt && jtt!==jt) return false;
        if(kat && kk!==kat) return false;

        if(q){
          const qnorm = q.toLowerCase();
          if(qnorm==="yes"){
            if(!isYes(qq)) return false;
          } else if(qnorm==="no"){
            if(isYes(qq)) return false;
          } else {
            if(qq!==q) return false;
          }
        }
        return true;
      });
    }

    function updateACMAll(){
      const rows = getFilteredACMRows();

      // Status
      $("acm-status").textContent = `Rows: ${rows.length.toLocaleString("id-ID")} (filtered)`;

      // KPIs
      const valid = rows.reduce((a,r)=>a+getValidFlag(r),0);
      const buffer = rows.reduce((a,r)=>a+getBufferFlag(r),0);
      const qyes = rows.reduce((a,r)=>a+(isQualifiedYes(r)?1:0),0);

      $("kpi-total").textContent = rows.length.toLocaleString("id-ID");
      $("kpi-valid").textContent = valid.toLocaleString("id-ID");
      $("kpi-buffer").textContent = buffer.toLocaleString("id-ID");
      $("kpi-qyes").textContent = qyes.toLocaleString("id-ID");

      // Table kategori top10
      const catCount = new Map();
      rows.forEach(r=>{
        const k = trimStr(r[COL_KATEGORI]) || "(Kosong)";
        catCount.set(k, (catCount.get(k)||0) + 1);
      });
      const top = Array.from(catCount.entries())
        .sort((a,b)=>b[1]-a[1])
        .slice(0,10);

      $("tbl-kategori").innerHTML = top.map(([k,c])=>`
        <tr>
          <td>${escapeHtml(k)}</td>
          <td class="right">${c.toLocaleString("id-ID")}</td>
        </tr>
      `).join("") || `<tr><td colspan="2" class="muted">Tidak ada data</td></tr>`;

      // Chart per bulan
      const validByM = Array(12).fill(0);
      const bufferByM = Array(12).fill(0);

      rows.forEach(r=>{
        const m = parseMonthIndexFromText(r[COL_PERIODE]);
        if(m<0) return;
        validByM[m] += getValidFlag(r);
        bufferByM[m] += getBufferFlag(r);
      });

      renderDualBarChart("chart-acm", validByM, bufferByM);
    }

    function renderDualBarChart(containerId, arrA, arrB){
      const el = $(containerId);
      if(!el) return;
      const labels = ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"];
      const maxV = Math.max(1, ...arrA, ...arrB);

      el.innerHTML = `
        <div class="bars">
          ${labels.map((lb,idx)=>{
            const a = arrA[idx]||0;
            const b = arrB[idx]||0;
            const ha = Math.round((a/maxV)*190) + 8;
            const hb = Math.round((b/maxV)*190) + 8;
            return `
              <div class="bar-col" title="${lb} · Valid ${a} · Buffer ${b}">
                <div class="bar bar2" style="height:${hb}px"></div>
                <div class="bar" style="height:${ha}px"></div>
                <div class="bar-label">${lb}</div>
              </div>
            `;
          }).join("")}
        </div>
      `;
    }

    function clearACMFilters(){
      msPeriode && msPeriode.clear();
      msYear && msYear.clear();

      ["f-industry","f-client","f-prov","f-kota","f-jobparent","f-jobtype","f-kategori","f-qualified"].forEach(id=>{
        const el = $(id);
        if(el) el.value = "";
      });

      // reset dependents
      setSelectOptions("f-client", uniqueSorted(acmRows.map(r=>r[COL_CLIENT])), "Semua Client");
      setSelectOptions("f-kota", uniqueSorted(acmRows.map(r=>r[COL_KOTA])), "Semua Kota");

      updateACMAll();
    }

    /******************************************************************
     * SOURCING ANALYST PAGE
     ******************************************************************/
    let saYearMS = null;

    function initSourcingAnalystFilters(){
      $("sa-status").textContent = `Data ACM siap · total rows ${acmRows.length.toLocaleString("id-ID")}`;

      // Year MS uses GLOBAL_YEAR_OPTIONS from ACM
      saYearMS = createMultiSelect("sa-ms-year", GLOBAL_YEAR_OPTIONS, "Semua Tahun", false, ()=>{
        updateSaDependentOptions();
        updateSourcingAnalystAnalysis();
      });

      // Build initial options
      setSelectOptions("sa-industry", uniqueSorted(acmRows.map(r=>r[COL_INDUSTRY])), "Semua Industry");
      setSelectOptions("sa-client", uniqueSorted(acmRows.map(r=>r[COL_CLIENT])), "Semua Client");
      setSelectOptions("sa-area", uniqueSorted(acmRows.map(r=>r[COL_AREA])), "Semua Area");
      setSelectOptions("sa-jobparent", uniqueSorted(acmRows.map(r=>r[COL_JOBPARENT])), "Semua Job Parent");

      $("sa-industry").addEventListener("change", ()=>{
        updateSaDependentOptions();
        updateSourcingAnalystAnalysis();
      });
      $("sa-client").addEventListener("change", ()=>{
        updateSaDependentOptions();
        updateSourcingAnalystAnalysis();
      });
      $("sa-area").addEventListener("change", ()=>{
        updateSaDependentOptions();
        updateSourcingAnalystAnalysis();
      });
      $("sa-jobparent").addEventListener("change", updateSourcingAnalystAnalysis);

      updateSaDependentOptions();
      updateSourcingAnalystAnalysis();
    }

    function getSourcingAnalystFilteredRows(){
      const yearSel = new Set(saYearMS ? saYearMS.getSelected() : []);
      const ind = $("sa-industry").value;
      const client = $("sa-client").value;
      const area = $("sa-area").value;
      const jp = $("sa-jobparent").value;

      return acmRows.filter(r=>{
        const y = getYearVal(r);
        if(yearSel.size && !yearSel.has(y)) return false;

        if(ind && trimStr(r[COL_INDUSTRY])!==ind) return false;
        if(client && trimStr(r[COL_CLIENT])!==client) return false;
        if(area && trimStr(r[COL_AREA])!==area) return false;
        if(jp && trimStr(r[COL_JOBPARENT])!==jp) return false;
        return true;
      });
    }

    function updateSaDependentOptions(){
      const yearSel = saYearMS ? saYearMS.getSelected() : [];
      const ind = $("sa-industry").value;
      const client = $("sa-client").value;
      const area = $("sa-area").value;

      // Filter base rows for option generation
      let base = acmRows.slice();

      if(yearSel.length){
        base = base.filter(r=>yearSel.includes(getYearVal(r)));
      }

      // Industry is top-level (keep as is), but update clients based on industry
      if(ind){
        base = base.filter(r=>trimStr(r[COL_INDUSTRY])===ind);
      }
      const clients = uniqueSorted(base.map(r=>r[COL_CLIENT]));
      const curClient = $("sa-client").value;
      setSelectOptions("sa-client", clients, "Semua Client");
      if(clients.includes(curClient)) $("sa-client").value = curClient;
      else $("sa-client").value = "";

      // If client selected, narrow for areas & jobparent
      let base2 = base.slice();
      const newClient = $("sa-client").value;
      if(newClient){
        base2 = base2.filter(r=>trimStr(r[COL_CLIENT])===newClient);
      }
      const areas = uniqueSorted(base2.map(r=>r[COL_AREA]));
      const curArea = $("sa-area").value;
      setSelectOptions("sa-area", areas, "Semua Area");
      if(areas.includes(curArea)) $("sa-area").value = curArea;
      else $("sa-area").value = "";

      // Job Parent based on area too
      let base3 = base2.slice();
      const newArea = $("sa-area").value;
      if(newArea){
        base3 = base3.filter(r=>trimStr(r[COL_AREA])===newArea);
      }
      const parents = uniqueSorted(base3.map(r=>r[COL_JOBPARENT]));
      const curJP = $("sa-jobparent").value;
      setSelectOptions("sa-jobparent", parents, "Semua Job Parent");
      if(parents.includes(curJP)) $("sa-jobparent").value = curJP;
      else $("sa-jobparent").value = "";
    }

    function updateSourcingAnalystAnalysis(){
      const rows = getSourcingAnalystFilteredRows();
      const yearSel = saYearMS ? saYearMS.getSelected() : [];
      $("sa-kpi-rows").textContent = rows.length.toLocaleString("id-ID");
      $("sa-kpi-hint").textContent = yearSel.length ? `Tahun: ${yearSel.join(", ")}` : "Semua tahun";

      const valid = rows.reduce((a,r)=>a+getValidFlag(r),0);
      const buffer = rows.reduce((a,r)=>a+getBufferFlag(r),0);
      $("sa-kpi-valid").textContent = valid.toLocaleString("id-ID");
      $("sa-kpi-buffer").textContent = buffer.toLocaleString("id-ID");

      // Table by job parent
      const m = new Map(); // jp -> {rows,valid,buffer}
      rows.forEach(r=>{
        const jp = trimStr(r[COL_JOBPARENT]) || "(Kosong)";
        if(!m.has(jp)) m.set(jp, {rows:0, valid:0, buffer:0});
        const o = m.get(jp);
        o.rows += 1;
        o.valid += getValidFlag(r);
        o.buffer += getBufferFlag(r);
      });

      const list = Array.from(m.entries())
        .sort((a,b)=>b[1].rows - a[1].rows)
        .slice(0, 30);

      $("sa-tbl").innerHTML = list.map(([jp,o])=>`
        <tr>
          <td>${escapeHtml(jp)}</td>
          <td class="right">${o.rows.toLocaleString("id-ID")}</td>
          <td class="right">${o.valid.toLocaleString("id-ID")}</td>
          <td class="right">${o.buffer.toLocaleString("id-ID")}</td>
        </tr>
      `).join("") || `<tr><td colspan="4" class="muted">Tidak ada data</td></tr>`;

      // Monthly chart
      const validByM = Array(12).fill(0);
      const bufferByM = Array(12).fill(0);
      rows.forEach(r=>{
        const mm = parseMonthIndexFromText(r[COL_PERIODE]);
        if(mm<0) return;
        validByM[mm] += getValidFlag(r);
        bufferByM[mm] += getBufferFlag(r);
      });
      renderDualBarChart("chart-sa", validByM, bufferByM);
    }

    function clearSaFilters(){
      saYearMS && saYearMS.clear();
      ["sa-industry","sa-client","sa-area","sa-jobparent"].forEach(id=>{
        const el = $(id);
        if(el) el.value = "";
      });
      updateSaDependentOptions();
      updateSourcingAnalystAnalysis();
    }

    /******************************************************************
     * PERFORMANCE PAGES
     ******************************************************************/
    const perfClient = { rows:[], fields:[], yearField:null };
    const perfArea = { rows:[], fields:[], yearField:null };
    const perfJob = { rows:[], fields:[], yearField:null };

    // Inferred column names per performance CSV
    function detectPerfColumns(fields){
      return {
        periode: findField(fields, ["PERIODE","PERIODE PELAMAR","TIMESTAMP","WAKTU"]) || fields[0],
        year: findField(fields, ["TAHUN","YEAR"]) || fields[colLetterToIndex("AK")] || null,
        industry: findField(fields, ["INDUSTRY","INDUSTRI","GROUP"]) || "INDUSTRY",
        client: findField(fields, ["CLIENT","KLIEN","COMPANY","PERUSAHAAN"]) || "CLIENT",
        group: findField(fields, ["GROUP","INDUSTRY","INDUSTRI","CLUSTER"]) || "GROUP",
        area: findField(fields, ["AREA","REGION","CABANG","BRANCH"]) || "AREA",
        jobParent: findField(fields, ["JOB PARENT","JOBPARENT","PARENT"]) || "JOB PARENT",
        jobType: findField(fields, ["JOB TYPE","JOBTYPE","TYPE","JENIS"]) || "JOB TYPE",
        kategori: findField(fields, ["KATEGORI","CATEGORY","STATUS"]) || "KATEGORI",
        qualified: findField(fields, ["QUALIFIED","KUALIFIKASI","QUALIFIED YES/NO"]) || "QUALIFIED",
      };
    }

    // helpers for perf logic (re-use ACM logic by mapping globals temporarily)
    function calcPerfKPIs(rows, cols){
      const v = rows.reduce((a,r)=>a + (isKategoriValidPerf(r, cols) ? 1 : 0), 0);
      const b = rows.reduce((a,r)=>a + (isBufferPerf(r, cols) ? 1 : 0), 0);
      const qy = rows.reduce((a,r)=>a + (isYes(r?.[cols.qualified]) ? 1 : 0), 0);
      return { rows: rows.length, valid:v, buffer:b, qyes:qy };
    }

    function isKategoriValidPerf(row, cols){
      const k = trimStr(row?.[cols.kategori]).toLowerCase();
      if(!k) return false;
      if(k.includes("valid")) return true;
      if(k.includes("ctc 1")) return true;
      if(k.includes("aplikan valid")) return true;
      return false;
    }
    function isBufferPerf(row, cols){
      return (isYes(row?.[cols.qualified]) && !isKategoriValidPerf(row, cols)) ? 1 : 0;
    }

    function renderPerfChart(containerId, rows, cols){
      const validByM = Array(12).fill(0);
      const bufferByM = Array(12).fill(0);
      rows.forEach(r=>{
        const mm = parseMonthIndexFromText(r[cols.periode]);
        if(mm<0) return;
        validByM[mm] += isKategoriValidPerf(r, cols) ? 1 : 0;
        bufferByM[mm] += isBufferPerf(r, cols);
      });
      renderDualBarChart(containerId, validByM, bufferByM);
    }

    /********** Performance Client **********/
    let pcCols = null;

    function initPerformanceClient(){
      pcCols = detectPerfColumns(perfClient.fields);
      perfClient.yearField = pcCols.year;

      // Year dropdown
      const years = perfClient.yearField ? uniqueSorted(perfClient.rows.map(r=>r[perfClient.yearField])).filter(v=>v!=="") : [];
      setYearSelectOptions("pc-year", years);

      // Industry dropdown
      const industries = uniqueSorted(perfClient.rows.map(r=>r[pcCols.industry]));
      setSelectOptions("pc-industry", industries, "Pilih Industry");
      $("pc-industry").value = industries[0] || "";

      $("pc-year").addEventListener("change", ()=>{
        updateClientDropdown();
        updatePerformanceClientView();
      });

      $("pc-industry").addEventListener("change", ()=>{
        updateClientDropdown();
        updatePerformanceClientView();
      });
      $("pc-client").addEventListener("change", updatePerformanceClientView);

      updateClientDropdown();
      updatePerformanceClientView();
    }

    function updateClientDropdown(){
      const year = $("pc-year").value;
      const ind = $("pc-industry").value;
      let rows = perfClient.rows.filter(r => trimStr(r[pcCols.industry]) === ind);

      if(year && perfClient.yearField){
        rows = rows.filter(r => trimStr(r[perfClient.yearField]) === year);
      }

      const clients = uniqueSorted(rows.map(r=>r[pcCols.client]));
      setSelectOptions("pc-client", clients, "Semua Client");
      $("pc-client").value = "";
      $("pc-status-text").textContent = (year ? `Tahun "${year}" · ` : "") + `Industry "${ind}" · ${clients.length} client`;
    }

    function updatePerformanceClientView(){
      const year = $("pc-year").value;
      const ind = $("pc-industry").value;
      const client = $("pc-client").value;

      let rows = perfClient.rows.filter(r => trimStr(r[pcCols.industry]) === ind);
      if(year && perfClient.yearField){
        rows = rows.filter(r => trimStr(r[perfClient.yearField]) === year);
      }
      if(client){
        rows = rows.filter(r => trimStr(r[pcCols.client]) === client);
      }

      const k = calcPerfKPIs(rows, pcCols);
      $("pc-kpi-rows").textContent = k.rows.toLocaleString("id-ID");
      $("pc-kpi-valid").textContent = k.valid.toLocaleString("id-ID");
      $("pc-kpi-buffer").textContent = k.buffer.toLocaleString("id-ID");
      $("pc-kpi-qyes").textContent = k.qyes.toLocaleString("id-ID");
      $("pc-status-text").textContent =
        (year ? `Tahun "${year}" · ` : "") +
        `Industry "${ind}"` +
        (client ? ` · Client "${client}"` : ` · ${uniqueSorted(perfClient.rows.filter(r=>trimStr(r[pcCols.industry])===ind).map(r=>r[pcCols.client])).length} client`);

      renderPerfChart("chart-pc", rows, pcCols);
    }

    function clearPC(){
      $("pc-year").value = "";
      $("pc-client").value = "";
      updateClientDropdown();
      updatePerformanceClientView();
    }

    /********** Performance Area **********/
    let paCols = null;

    function initPerformanceArea(){
      paCols = detectPerfColumns(perfArea.fields);
      perfArea.yearField = paCols.year;

      const years = perfArea.yearField ? uniqueSorted(perfArea.rows.map(r=>r[perfArea.yearField])).filter(v=>v!=="") : [];
      setYearSelectOptions("pa-year", years);

      const groups = uniqueSorted(perfArea.rows.map(r=>r[paCols.group]));
      setSelectOptions("pa-group", groups, "Pilih Group");
      $("pa-group").value = groups[0] || "";

      $("pa-year").addEventListener("change", ()=>{
        updateAreaDropdown();
        updatePerformanceAreaView();
        refreshPJAreaOptions();
      });
      $("pa-group").addEventListener("change", ()=>{
        updateAreaDropdown();
        updatePerformanceAreaView();
        refreshPJAreaOptions();
      });
      $("pa-area").addEventListener("change", ()=>{
        updatePerformanceAreaView();
        refreshPJAreaOptions();
      });

      updateAreaDropdown();
      updatePerformanceAreaView();
    }

    function updateAreaDropdown(){
      const year = $("pa-year").value;
      const g = $("pa-group").value;

      let rows = perfArea.rows.filter(r=>trimStr(r[paCols.group])===g);
      if(year && perfArea.yearField){
        rows = rows.filter(r=>trimStr(r[perfArea.yearField])===year);
      }

      const areas = uniqueSorted(rows.map(r=>r[paCols.area]));
      setSelectOptions("pa-area", areas, "Semua Area");
      $("pa-area").value = "";
      $("pa-status-text").textContent = (year ? `Tahun "${year}" · ` : "") + `Group "${g}" · ${areas.length} area`;
    }

    function updatePerformanceAreaView(){
      const year = $("pa-year").value;
      const g = $("pa-group").value;
      const a = $("pa-area").value;

      let rows = perfArea.rows.filter(r=>trimStr(r[paCols.group])===g);
      if(year && perfArea.yearField){
        rows = rows.filter(r=>trimStr(r[perfArea.yearField])===year);
      }
      if(a){
        rows = rows.filter(r=>trimStr(r[paCols.area])===a);
      }

      const k = calcPerfKPIs(rows, paCols);
      $("pa-kpi-rows").textContent = k.rows.toLocaleString("id-ID");
      $("pa-kpi-valid").textContent = k.valid.toLocaleString("id-ID");
      $("pa-kpi-buffer").textContent = k.buffer.toLocaleString("id-ID");
      $("pa-kpi-qyes").textContent = k.qyes.toLocaleString("id-ID");

      const allAreas = uniqueSorted(perfArea.rows.filter(r=>trimStr(r[paCols.group])===g).map(r=>r[paCols.area]));
      $("pa-status-text").textContent =
        (year ? `Tahun "${year}" · ` : "") +
        `Group "${g}"` +
        (a ? ` · Area "${a}"` : ` · ${allAreas.length} area`);

      renderPerfChart("chart-pa", rows, paCols);
    }

    function clearPA(){
      $("pa-year").value = "";
      $("pa-area").value = "";
      updateAreaDropdown();
      updatePerformanceAreaView();
      refreshPJAreaOptions();
    }

    /********** Performance Jobtype **********/
    let pjCols = null;

    function initPerformanceJobtype(){
      pjCols = detectPerfColumns(perfJob.fields);
      perfJob.yearField = pjCols.year;

      const years = perfJob.yearField ? uniqueSorted(perfJob.rows.map(r=>r[perfJob.yearField])).filter(v=>v!=="") : [];
      setYearSelectOptions("pj-year", years);

      const parents = uniqueSorted(perfJob.rows.map(r=>r[pjCols.jobParent]));
      setSelectOptions("pj-parent", parents, "Pilih Job Parent");
      $("pj-parent").value = parents[0] || "";

      // area options initial (will be refreshed)
      refreshPJAreaOptions();

      $("pj-year").addEventListener("change", ()=>{
        updatePJTypeOptions();
        updatePerformanceJobtypeView();
      });
      $("pj-parent").addEventListener("change", ()=>{
        refreshPJAreaOptions();
        updatePJTypeOptions();
        updatePerformanceJobtypeView();
      });
      $("pj-area").addEventListener("change", ()=>{
        updatePJTypeOptions();
        updatePerformanceJobtypeView();
      });
      $("pj-type").addEventListener("change", updatePerformanceJobtypeView);

      updatePJTypeOptions();
      updatePerformanceJobtypeView();
    }

    function refreshPJAreaOptions(){
      // Prefer options from Performance Area selection if available
      const year = $("pj-year") ? $("pj-year").value : "";
      const parent = $("pj-parent") ? $("pj-parent").value : "";

      // Use perfJob rows, but also allow pa selections to narrow
      let rows = perfJob.rows.slice();

      if(year && perfJob.yearField){
        rows = rows.filter(r=>trimStr(r[perfJob.yearField])===year);
      }
      if(parent){
        rows = rows.filter(r=>trimStr(r[pjCols.jobParent])===parent);
      }
      const areas = uniqueSorted(rows.map(r=>r[pjCols.area]));
      setSelectOptions("pj-area", areas, "Semua Area");
      $("pj-area").value = "";
    }

    function updatePJTypeOptions(){
      const year = $("pj-year").value;
      const parent = $("pj-parent").value;
      const area = $("pj-area").value;

      let rows = perfJob.rows.filter(r=>trimStr(r[pjCols.jobParent])===parent);

      if(year && perfJob.yearField){
        rows = rows.filter(r=>trimStr(r[perfJob.yearField])===year);
      }
      if(area){
        rows = rows.filter(r=>trimStr(r[pjCols.area])===area);
      }

      const types = uniqueSorted(rows.map(r=>r[pjCols.jobType]));
      setSelectOptions("pj-type", types, "Semua Job Type");
      $("pj-type").value = "";
    }

    function updatePerformanceJobtypeView(){
      const year = $("pj-year").value;
      const parent = $("pj-parent").value;
      const area = $("pj-area").value;
      const type = $("pj-type").value;

      let rows = perfJob.rows.filter(r=>trimStr(r[pjCols.jobParent])===parent);
      if(year && perfJob.yearField){
        rows = rows.filter(r=>trimStr(r[perfJob.yearField])===year);
      }
      if(area){
        rows = rows.filter(r=>trimStr(r[pjCols.area])===area);
      }
      if(type){
        rows = rows.filter(r=>trimStr(r[pjCols.jobType])===type);
      }

      const k = calcPerfKPIs(rows, pjCols);
      $("pj-kpi-rows").textContent = k.rows.toLocaleString("id-ID");
      $("pj-kpi-valid").textContent = k.valid.toLocaleString("id-ID");
      $("pj-kpi-buffer").textContent = k.buffer.toLocaleString("id-ID");
      $("pj-kpi-qyes").textContent = k.qyes.toLocaleString("id-ID");

      const typesAll = uniqueSorted(perfJob.rows.filter(r=>trimStr(r[pjCols.jobParent])===parent).map(r=>r[pjCols.jobType]));
      $("pj-status-text").textContent =
        (year ? `Tahun "${year}" · ` : "") +
        `Parent "${parent}"` +
        (area ? ` · Area "${area}"` : "") +
        (type ? ` · Type "${type}"` : ` · ${typesAll.length} job type`);

      renderPerfChart("chart-pj", rows, pjCols);
    }

    function clearPJ(){
      $("pj-year").value = "";
      $("pj-area").value = "";
      $("pj-type").value = "";
      refreshPJAreaOptions();
      updatePJTypeOptions();
      updatePerformanceJobtypeView();
    }

    /******************************************************************
     * TABS routing
     ******************************************************************/
    function switchPage(pageKey){
      $$(".tab").forEach(t=>t.classList.toggle("active", t.dataset.page===pageKey));
      $$(".page").forEach(p=>p.classList.remove("active"));
      const pageId = "page-" + pageKey;
      const el = $(pageId);
      if(el) el.classList.add("active");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    $("tabs").addEventListener("click", (e)=>{
      const t = e.target.closest(".tab");
      if(!t) return;
      switchPage(t.dataset.page);
    });

    /******************************************************************
     * INIT FLOW
     ******************************************************************/
    async function initAll(){
      // Buttons
      $("btn-clear-acm").addEventListener("click", clearACMFilters);
      $("btn-clear-sa").addEventListener("click", clearSaFilters);
      $("btn-clear-pc").addEventListener("click", clearPC);
      $("btn-clear-pa").addEventListener("click", clearPA);
      $("btn-clear-pj").addEventListener("click", clearPJ);
      $("btn-reload").addEventListener("click", ()=>location.reload());

      // Load ACM first
      try{
        $("acm-status").textContent = "Memuat ACM...";
        const acm = await loadCsv(CONFIG.ACM_CSV_URL);
        acmRows = acm.rows;
        acmFields = acm.fields;
        detectACMColumns(acmFields);

        $("acm-status").textContent = `ACM loaded: ${acmRows.length.toLocaleString("id-ID")} rows`;
        initACMFilters();
        initSourcingAnalystFilters();
      }catch(err){
        console.error(err);
        $("acm-status").textContent = `Gagal load ACM: ${err.message}`;
        $("sa-status").textContent = `Gagal load ACM: ${err.message}`;
        toast("Gagal load ACM (cek CONFIG URL).");
      }

      // Load Performance CSVs (optional)
      await initPerfSafe("client", CONFIG.PERF_CLIENT_CSV_URL, perfClient, initPerformanceClient, "pc-status-text");
      await initPerfSafe("area", CONFIG.PERF_AREA_CSV_URL, perfArea, initPerformanceArea, "pa-status-text");
      await initPerfSafe("jobtype", CONFIG.PERF_JOBTYPE_CSV_URL, perfJob, initPerformanceJobtype, "pj-status-text");
    }

    async function initPerfSafe(name, url, store, initFn, statusId){
      try{
        $(statusId).textContent = `Memuat Performance ${name}...`;
        const res = await loadCsv(url);
        store.rows = res.rows;
        store.fields = res.fields;
        initFn();
        $(statusId).textContent = `Loaded: ${store.rows.length.toLocaleString("id-ID")} rows`;
      }catch(err){
        console.warn(`Perf ${name} skipped:`, err.message);
        $(statusId).textContent = `Tidak aktif (isi CONFIG ${name} URL)`;
      }
    }

    initAll();
  </script>
</body>
</html>
