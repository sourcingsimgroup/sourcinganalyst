<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sourcing Intelligence Market</title>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --brand:#2563eb;
      --brand-soft:#e0edff;
      --line:#e5e7eb;
      --radius:18px;
      --shadow:0 18px 40px rgba(15,23,42,0.08);
      --warn:#b91c1c;
      --male:#1d4ed8;
      --female:#db2777;
      --total:#059669;
      --orange:#f97316;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      width:100%;
      min-height:100%;
      font-family:'Montserrat',system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background: radial-gradient(circle at top left,#e0edff 0,#f5f7fb 40%,#f5f7fb 100%);
      color:var(--ink);
    }
    body{ display:flex; justify-content:center; padding:16px; }
    .app-shell{ width:100%; max-width:1240px; }

    header{
      display:flex; flex-wrap:wrap; gap:12px;
      justify-content:space-between; align-items:flex-start;
      margin-bottom:12px;
    }
    .title-block h1{ font-size:1.65rem; font-weight:800; letter-spacing:0.01em; }
    .title-block p{ margin-top:6px; font-size:0.9rem; color:var(--muted); line-height:1.4; }

    .pill{
      padding:8px 14px;
      background:rgba(37,99,235,0.06);
      border-radius:999px;
      font-size:0.8rem;
      color:var(--brand);
      font-weight:700;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .pill-dot{
      width:8px; height:8px; border-radius:999px;
      background:var(--brand);
      box-shadow:0 0 0 4px rgba(37,99,235,0.18);
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px 18px 16px;
      border:1px solid rgba(148,163,184,0.18);
    }

    /* Tabs */
    .tab-row{ display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap; }
    .tab-btn{
      border-radius:999px;
      border:1px solid var(--line);
      background:#f9fafb;
      font-size:0.8rem;
      padding:6px 14px;
      cursor:pointer;
      color:var(--muted);
      font-weight:800;
      white-space:nowrap;
    }
    .tab-btn.active{
      background:var(--brand);
      color:#ffffff;
      border-color:var(--brand);
    }
    .page{ display:none; }
    .page.active{ display:block; }

    /* Filter card sticky */
    .filter-card, .sa-filter-card, .perf-filter-card{
      margin-bottom:14px;
      position:sticky;
      top:0;
      z-index:40;
    }

    .card-title-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:8px;
    }
    .card-title{ font-size:0.95rem; font-weight:800; }
    .card-tag{
      font-size:0.7rem;
      padding:4px 10px;
      border-radius:999px;
      background:var(--brand-soft);
      color:var(--brand);
      font-weight:800;
      white-space:nowrap;
    }
    .card-subtext{
      font-size:0.75rem;
      color:var(--muted);
      line-height:1.45;
      margin-bottom:8px;
    }

    .header-right-flex{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .clear-btn{
      border-radius:999px;
      border:1px solid var(--line);
      background:#f9fafb;
      font-size:0.75rem;
      padding:5px 10px;
      cursor:pointer;
      color:var(--muted);
      font-weight:800;
    }
    .clear-btn:hover{ background:#eef2ff; border-color:var(--brand); color:var(--brand); }

    .filter-toggle-btn{
      display:none;
      border-radius:999px;
      border:1px solid var(--line);
      background:#ffffff;
      font-size:0.75rem;
      padding:5px 10px;
      cursor:pointer;
      color:var(--muted);
      align-items:center;
      gap:6px;
      box-shadow:0 6px 16px rgba(15,23,42,0.06);
      font-weight:900;
    }
    .filter-toggle-btn .hamburger-icon{ font-size:0.9rem; line-height:1; }

    .filter-body,.sa-filter-body,.perf-filter-body{ margin-top:6px; }

    @media (max-width:1024px){
      .filter-toggle-btn{ display:inline-flex; }
      .filter-body,.sa-filter-body,.perf-filter-body{ display:none; }
      .filter-card.open .filter-body,
      .sa-filter-card.open .sa-filter-body,
      .perf-filter-card.open .perf-filter-body{ display:block; }
      .filter-card,.sa-filter-card,.perf-filter-card{
        box-shadow:0 18px 40px rgba(15,23,42,0.12);
        border-color:rgba(148,163,184,0.4);
      }
    }

    /* ✅ ACM Filters: 5 sejajar */
    .filters{
      display:grid;
      grid-template-columns:repeat(5,minmax(0,1fr));
      gap:10px;
      margin-top:10px;
    }
    @media (max-width:1024px){
      .filters{ grid-template-columns:repeat(2,minmax(0,1fr)); }
    }
    @media (max-width:640px){
      .filters{ grid-template-columns:1fr; }
      .title-block h1{ font-size:1.35rem; }
    }

    .sa-filters{
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:10px;
      margin-top:10px;
    }
    @media (max-width:1024px){ .sa-filters{ grid-template-columns:repeat(2,minmax(0,1fr)); } }
    @media (max-width:640px){ .sa-filters{ grid-template-columns:1fr; } }

    .perf-filters{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:10px;
      margin-top:10px;
    }
    @media (max-width:1024px){ .perf-filters{ grid-template-columns:repeat(2,minmax(0,1fr)); } }
    @media (max-width:640px){ .perf-filters{ grid-template-columns:1fr; } }

    .filter-group{ display:flex; flex-direction:column; gap:4px; font-size:0.8rem; }
    .filter-label{ font-weight:900; color:var(--muted); font-size:0.78rem; }

    /* Multi select */
    .ms{ position:relative; }
    .ms-toggle{
      width:100%;
      border-radius:999px;
      border:1px solid var(--line);
      background:#f9fafb;
      padding:7px 9px;
      font-size:0.78rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
      cursor:pointer;
    }
    .ms-placeholder{ flex:1; text-align:left; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .ms-counter{ font-size:0.68rem; color:var(--muted); white-space:nowrap; }
    .ms-arrow{ font-size:0.68rem; }
    .ms-panel{
      position:absolute;
      left:0; right:0; top:100%;
      margin-top:4px;
      background:#ffffff;
      border-radius:14px;
      box-shadow:0 12px 30px rgba(15,23,42,0.12);
      border:1px solid rgba(148,163,184,0.4);
      padding:8px;
      z-index:60;
      display:none;
    }
    .ms.open .ms-panel{ display:block; }
    .ms-search{
      width:100%;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      font-size:0.75rem;
      margin-bottom:6px;
      outline:none;
    }
    .ms-options{ max-height:220px; overflow-y:auto; }
    .ms-option{
      display:flex; align-items:center; gap:6px;
      padding:3px 4px;
      font-size:0.76rem;
      cursor:pointer;
    }
    .ms-option input{ accent-color:var(--brand); }
    .ms-empty{ font-size:0.74rem; color:var(--muted); padding:4px 2px; display:none; }
    .ms-disabled .ms-toggle{ background:#e5e7eb; color:#9ca3af; cursor:not-allowed; }
    .filter-hint{ margin-top:8px; font-size:0.75rem; color:var(--muted); }

    /* Perf select native */
    .perf-select{
      width:100%;
      border-radius:999px;
      border:1px solid var(--line);
      background:#ffffff;
      padding:8px 10px;
      font-size:0.8rem;
      outline:none;
      cursor:pointer;
    }
    .perf-select:disabled{ background:#e5e7eb; color:#9ca3af; cursor:not-allowed; }

    /* Loading & errors */
    .loading{ display:flex; align-items:center; gap:8px; font-size:0.8rem; color:var(--muted); margin-top:6px; }
    .spinner{
      width:14px; height:14px; border-radius:999px;
      border:2px solid rgba(37,99,235,0.18);
      border-top-color:var(--brand);
      animation:spin 0.7s linear infinite;
    }
    @keyframes spin{ to{transform:rotate(360deg);} }
    .error{ margin-top:8px; font-size:0.8rem; color:var(--warn); font-weight:700; line-height:1.4; }

    /* Summary cards */
    .summary-row{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:12px;
      margin-bottom:18px;
    }
    @media (max-width:900px){ .summary-row{ grid-template-columns:1fr; } }
    .summary-card{
      border-radius:16px;
      padding:12px 14px;
      background:#ffffff;
      box-shadow:0 14px 30px rgba(15,23,42,0.06);
      border:1px solid rgba(148,163,184,0.2);
      display:flex; flex-direction:column; gap:6px;
    }
    .summary-header{ display:flex; justify-content:space-between; align-items:center; font-size:0.78rem; }
    .summary-title{ font-weight:900; }
    .summary-tag{
      font-size:0.7rem; padding:3px 8px; border-radius:999px;
      background:#f3f4f6; font-weight:800;
    }
    .summary-body{ display:flex; justify-content:space-between; gap:8px; font-size:0.8rem; margin-top:4px; }
    .summary-metric{ flex:1; }
    .summary-label{ color:var(--muted); font-size:0.73rem; }
    .summary-value{ font-weight:900; font-size:0.95rem; font-variant-numeric:tabular-nums; }

    .summary-card.male .summary-title{ color:var(--male); }
    .summary-card.female .summary-title{ color:var(--female); }
    .summary-card.total .summary-title{ color:var(--total); }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:16px;
      margin-bottom:12px;
    }
    @media (max-width:960px){ .grid{ grid-template-columns:1fr; } }

    /* Tables */
    .table-wrap{
      width:100%;
      overflow-x:auto;
      border-radius:12px;
      border:1px solid var(--line);
      background:#f9fafb;
    }
    table{ width:100%; border-collapse:collapse; font-size:0.78rem; min-width:360px; }
    thead{ background:#111827; color:#f9fafb; }
    th,td{ padding:7px 10px; text-align:left; border-bottom:1px solid var(--line); white-space:nowrap; }
    thead th{ position:sticky; top:0; z-index:1; }
    tbody tr:nth-child(even){ background:#f3f4f6; }
    .col-label{ font-weight:900; color:#111827; }
    .col-number{ text-align:right; font-variant-numeric:tabular-nums; }
    .total-row{ background:#e5e7eb; color:#111827; font-weight:900; }
    table.acm-table{ table-layout:fixed; min-width:560px; }
    table.acm-table th:nth-child(1), table.acm-table td:nth-child(1){
      width:58%; max-width:58%; overflow:hidden; text-overflow:ellipsis;
    }
    table.acm-table th:nth-child(2), table.acm-table td:nth-child(2),
    table.acm-table th:nth-child(3), table.acm-table td:nth-child(3){ width:21%; }

    .status-bar{
      display:flex; align-items:center; justify-content:space-between;
      margin:4px 2px 0;
      font-size:0.72rem; color:var(--muted);
      gap:10px; flex-wrap:wrap;
    }
    .status-left{ display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
    .status-dot{
      width:8px; height:8px; border-radius:999px;
      background:#22c55e; box-shadow:0 0 0 3px rgba(34,197,94,0.3);
    }
    .status-right{ font-style:italic; }

    /* Chart */
    .chart-card{ margin-bottom:14px; }
    .chart-legend{
      display:flex; align-items:center; gap:16px;
      font-size:0.75rem; color:var(--muted);
      margin-bottom:6px; flex-wrap:wrap;
    }
    .legend-item{ display:flex; align-items:center; gap:6px; }
    .legend-dot{ width:14px; height:8px; border-radius:999px; }
    .legend-valid{ background:var(--brand); }
    .legend-buffer{ background:var(--orange); }

    .chart-body{
      display:flex; align-items:flex-end; gap:10px;
      height:260px;
      padding:8px 8px 4px;
      border-radius:16px;
      background:linear-gradient(to top,#f9fafb,#ffffff);
      border:1px solid var(--line);
      overflow-x:auto;
    }
    .chart-col{
      flex:1; min-width:48px; height:100%;
      display:flex; flex-direction:column; align-items:center; justify-content:flex-end; gap:4px;
    }
    .chart-col-bars{ flex:1; display:flex; align-items:flex-end; justify-content:center; gap:4px; width:100%; }
    .chart-bar-vert{ width:14px; border-radius:6px 6px 0 0; background:#e5e7eb; transition:height .25s ease-out; }
    .bar-valid{ background:var(--brand); }
    .bar-buffer{ background:var(--orange); }
    .chart-col-values{ font-size:0.7rem; text-align:center; font-variant-numeric:tabular-nums; color:#111827; line-height:1.2; }
    .chart-col-label{ font-size:0.7rem; text-align:center; color:var(--muted); white-space:nowrap; }
    .chart-footer{ margin-top:6px; font-size:0.72rem; color:var(--muted); font-style:italic; }

    /* Performance stacked */
    .stack-col{ display:flex; flex-direction:column; gap:16px; margin-bottom:16px; width:100%; }
    table.matrix-table{ min-width:920px; table-layout:auto; }
    .matrix-empty{ margin-top:8px; font-size:0.78rem; color:var(--muted); font-weight:800; display:none; }
    .tiny-note{ margin-top:6px; font-size:0.72rem; color:var(--muted); font-style:italic; line-height:1.45; white-space:pre-wrap; }

    /* Sourcing Analyst text */
    .analysis-text{ font-size:0.8rem; color:var(--ink); line-height:1.6; margin-top:4px; }
    .analysis-section{
      display:flex; align-items:flex-start; gap:10px;
      padding:10px 12px;
      border-radius:14px;
      background:linear-gradient(to bottom right,#f9fafb,#ffffff);
      border:1px solid rgba(148,163,184,0.35);
      box-shadow:0 10px 20px rgba(15,23,42,0.04);
      margin-top:8px;
    }
    .analysis-icon{ font-size:1.5rem; line-height:1; margin-top:2px; }
    .analysis-title{ font-weight:900; font-size:0.85rem; }
    .analysis-summary{ font-size:0.8rem; color:var(--ink); }
    .analysis-detail{ font-size:0.75rem; color:var(--warn); font-weight:900; }
  </style>
</head>

<body>
<div class="app-shell">
  <header>
    <div class="title-block">
      <h1>Sourcing Intelligence Market</h1>
      <p>Dashboard Applicant Cycle Management + Sourcing Analyst Insight + Performance (Client / Area / Jobtype).</p>
    </div>
    <div class="title-right">
      <span class="pill"><span class="pill-dot"></span><span id="pill-status">Ready</span></span>
    </div>
  </header>

  <div class="tab-row">
    <button id="tab-acm" class="tab-btn active" type="button">ACM</button>
    <button id="tab-sa" class="tab-btn" type="button">Sourcing Analyst</button>
    <button id="tab-pc" class="tab-btn" type="button">Performance Sourcing Client</button>
    <button id="tab-pa" class="tab-btn" type="button">Performance Sourcing Area</button>
    <button id="tab-pj" class="tab-btn" type="button">Performance Jobtype</button>
  </div>

  <main>
    <!-- ===================== PAGE: ACM ===================== -->
    <section id="page-acm" class="page active">
      <section class="card filter-card" id="acm-filter-card">
        <div class="card-title-row">
          <div class="card-title">Filter Data Applicant</div>
          <div class="header-right-flex">
            <button id="acm-filter-toggle-btn" class="filter-toggle-btn" type="button">
              <span class="hamburger-icon">☰</span><span>Filter</span>
            </button>
            <button id="clear-filters-btn" class="clear-btn" type="button">Hapus semua filter</button>
          </div>
        </div>
        <div class="card-subtext">
          Multi-select aktif. <strong>Job Type</strong> hanya muncul setelah <strong>Job Parent</strong> dipilih.
        </div>

        <div class="filter-body">
          <div class="filters">
            <div class="filter-group">
              <label class="filter-label">Provinsi</label>
              <div class="ms" id="ms-prov">
                <button type="button" class="ms-toggle">
                  <span class="ms-placeholder">Semua Provinsi</span>
                  <span class="ms-counter"></span><span class="ms-arrow">▾</span>
                </button>
                <div class="ms-panel">
                  <input class="ms-search" type="text" placeholder="Cari provinsi..." />
                  <div class="ms-options"></div><div class="ms-empty">Tidak ada provinsi</div>
                </div>
              </div>
            </div>

            <div class="filter-group">
              <label class="filter-label">Kota</label>
              <div class="ms ms-disabled" id="ms-kota">
                <button type="button" class="ms-toggle">
                  <span class="ms-placeholder">Pilih provinsi terlebih dahulu</span>
                  <span class="ms-counter"></span><span class="ms-arrow">▾</span>
                </button>
                <div class="ms-panel">
                  <input class="ms-search" type="text" placeholder="Cari kota..." />
                  <div class="ms-options"></div><div class="ms-empty">Tidak ada kota</div>
                </div>
              </div>
            </div>

            <div class="filter-group">
              <label class="filter-label">Periode Pelamar</label>
              <div class="ms" id="ms-periode">
                <button type="button" class="ms-toggle">
                  <span class="ms-placeholder">Semua Periode</span>
                  <span class="ms-counter"></span><span class="ms-arrow">▾</span>
                </button>
                <div class="ms-panel">
                  <input class="ms-search" type="text" placeholder="Cari periode..." />
                  <div class="ms-options"></div><div class="ms-empty">Tidak ada periode</div>
                </div>
              </div>
            </div>

            <div class="filter-group">
              <label class="filter-label">Job Parent</label>
              <div class="ms" id="ms-job-parent">
                <button type="button" class="ms-toggle">
                  <span class="ms-placeholder">Semua Job Parent</span>
                  <span class="ms-counter"></span><span class="ms-arrow">▾</span>
                </button>
                <div class="ms-panel">
                  <input class="ms-search" type="text" placeholder="Cari job parent..." />
                  <div class="ms-options"></div><div class="ms-empty">Tidak ada job parent</div>
                </div>
              </div>
            </div>

            <div class="filter-group">
              <label class="filter-label">Job Type</label>
              <div class="ms ms-disabled" id="ms-job-type">
                <button type="button" class="ms-toggle">
                  <span class="ms-placeholder">Pilih Job Parent terlebih dahulu</span>
                  <span class="ms-counter"></span><span class="ms-arrow">▾</span>
                </button>
                <div class="ms-panel">
                  <input class="ms-search" type="text" placeholder="Cari job type..." />
                  <div class="ms-options"></div><div class="ms-empty">Tidak ada job type</div>
                </div>
              </div>
            </div>
          </div>

          <div class="filter-hint">* Filter <strong>Cycle Hired</strong> sudah dihapus sesuai revisi.</div>
        </div>

        <div id="acm-load-state" class="loading">
          <div class="spinner"></div><span>Memuat data ACM ...</span>
        </div>
        <div id="acm-error-state" class="error" style="display:none;"></div>
      </section>

      <!-- Chart -->
      <section class="card chart-card">
        <div class="card-title-row">
          <div class="card-title">Trend Applicant Valid & Buffer per Bulan</div>
          <div class="card-tag">Jan–Des</div>
        </div>
        <p class="card-subtext">
          Berdasarkan <strong>PERIODE PELAMAR</strong>. Valid/Buffer dihitung dari kombinasi <strong>KATEGORI APP</strong> dan <strong>QUALIFIED</strong>.
        </p>
        <div class="chart-legend">
          <div class="legend-item"><span class="legend-dot legend-valid"></span><span>Applicant Valid</span></div>
          <div class="legend-item"><span class="legend-dot legend-buffer"></span><span>Buffer</span></div>
        </div>
        <div id="chart-body" class="chart-body"></div>
        <div id="chart-summary-text" class="chart-footer">Menunggu data...</div>
      </section>

      <!-- Summary -->
      <section class="summary-row">
        <div class="summary-card male">
          <div class="summary-header">
            <div class="summary-title">Summary Laki-Laki</div>
            <div class="summary-tag">Gender: L</div>
          </div>
          <div class="summary-body">
            <div class="summary-metric">
              <div class="summary-label">Applicant Valid</div>
              <div id="sum-male-valid" class="summary-value">0</div>
            </div>
            <div class="summary-metric">
              <div class="summary-label">Buffer</div>
              <div id="sum-male-buffer" class="summary-value">0</div>
            </div>
          </div>
        </div>

        <div class="summary-card female">
          <div class="summary-header">
            <div class="summary-title">Summary Perempuan</div>
            <div class="summary-tag">Gender: P</div>
          </div>
          <div class="summary-body">
            <div class="summary-metric">
              <div class="summary-label">Applicant Valid</div>
              <div id="sum-female-valid" class="summary-value">0</div>
            </div>
            <div class="summary-metric">
              <div class="summary-label">Buffer</div>
              <div id="sum-female-buffer" class="summary-value">0</div>
            </div>
          </div>
        </div>

        <div class="summary-card total">
          <div class="summary-header">
            <div class="summary-title">Total Nasional</div>
            <div class="summary-tag">All</div>
          </div>
          <div class="summary-body">
            <div class="summary-metric">
              <div class="summary-label">Applicant Valid</div>
              <div id="sum-total-valid" class="summary-value">0</div>
            </div>
            <div class="summary-metric">
              <div class="summary-label">Buffer</div>
              <div id="sum-total-buffer" class="summary-value">0</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Tables 1 & 2 -->
      <section class="grid">
        <article class="card">
          <div class="card-title-row">
            <div class="card-title">Preview Applicant Valid × Buffer</div>
            <div class="card-tag">By Provinsi</div>
          </div>
          <div class="table-wrap">
            <table class="acm-table">
              <thead>
              <tr><th>Provinsi</th><th>Applicant Valid</th><th>Buffer</th></tr>
              </thead>
              <tbody id="tbl-prov-body"></tbody>
            </table>
          </div>
          <div class="status-bar">
            <div class="status-left"><span class="status-dot"></span><span id="status-prov">Menunggu data...</span></div>
            <div class="status-right">Valid = (KATEGORI APP = "APLIKAN VALID - CTC 1") & QUALIFIED = YES</div>
          </div>
        </article>

        <article class="card">
          <div class="card-title-row">
            <div class="card-title">Preview Metode Sourcing</div>
            <div class="card-tag">MEDIA SOURCING</div>
          </div>
          <div class="table-wrap">
            <table class="acm-table">
              <thead>
              <tr><th>Metode Sourcing</th><th>Applicant Valid</th><th>Buffer</th></tr>
              </thead>
              <tbody id="tbl-metode-body"></tbody>
            </table>
          </div>
          <div class="status-bar">
            <div class="status-left"><span class="status-dot"></span><span id="status-metode">Menunggu data...</span></div>
            <div class="status-right">OFFLINE / ONLINE - JOB PORTAL / ONLINE - MEDIA SOSIAL</div>
          </div>
        </article>
      </section>

      <!-- Tables 3 & 4 -->
      <section class="grid">
        <article class="card">
          <div class="card-title-row">
            <div class="card-title">Preview Sourcing Media Sosial</div>
            <div class="card-tag">Platform</div>
          </div>
          <div class="table-wrap">
            <table class="acm-table">
              <thead>
              <tr><th>Media Sosial</th><th>Applicant Valid</th><th>Buffer</th></tr>
              </thead>
              <tbody id="tbl-media-body"></tbody>
            </table>
          </div>
          <div class="status-bar">
            <div class="status-left"><span class="status-dot"></span><span id="status-media">Menunggu data...</span></div>
            <div class="status-right">Filter: MEDIA SOURCING = ONLINE - MEDIA SOSIAL</div>
          </div>
        </article>

        <article class="card">
          <div class="card-title-row">
            <div class="card-title">Preview Profiling Applicant</div>
            <div class="card-tag">Pendidikan</div>
          </div>
          <div class="table-wrap">
            <table class="acm-table">
              <thead>
              <tr><th>Pendidikan Terakhir</th><th>Applicant Valid</th><th>Buffer</th></tr>
              </thead>
              <tbody id="tbl-edu-body"></tbody>
            </table>
          </div>
          <div class="status-bar">
            <div class="status-left"><span class="status-dot"></span><span id="status-edu">Menunggu data...</span></div>
            <div class="status-right">Kolom: PENDIDIKAN TERAKHIR</div>
          </div>
        </article>
      </section>

      <!-- Tables 5 & 6 -->
      <section class="grid">
        <article class="card">
          <div class="card-title-row">
            <div class="card-title">Preview Sourcing Job Portal</div>
            <div class="card-tag">Portal</div>
          </div>
          <div class="table-wrap">
            <table class="acm-table">
              <thead>
              <tr><th>Job Portal</th><th>Applicant Valid</th><th>Buffer</th></tr>
              </thead>
              <tbody id="tbl-portal-body"></tbody>
            </table>
          </div>
          <div class="status-bar">
            <div class="status-left"><span class="status-dot"></span><span id="status-portal">Menunggu data...</span></div>
            <div class="status-right">Filter: MEDIA SOURCING = ONLINE - JOB PORTAL</div>
          </div>
        </article>

        <article class="card">
          <div class="card-title-row">
            <div class="card-title">Preview Sourcing Offline</div>
            <div class="card-tag">Aktivitas</div>
          </div>
          <div class="table-wrap">
            <table class="acm-table">
              <thead>
              <tr><th>Aktivitas Offline</th><th>Applicant Valid</th><th>Buffer</th></tr>
              </thead>
              <tbody id="tbl-offline-body"></tbody>
            </table>
          </div>
          <div class="status-bar">
            <div class="status-left"><span class="status-dot"></span><span id="status-offline">Menunggu data...</span></div>
            <div class="status-right">Filter: MEDIA SOURCING = OFFLINE</div>
          </div>
        </article>
      </section>
    </section>

    <!-- ===================== PAGE: SOURCING ANALYST ===================== -->
    <section id="page-sa" class="page">
      <section class="card sa-filter-card" id="sa-filter-card">
        <div class="card-title-row">
          <div class="card-title">Filter Sourcing Analyst</div>
          <div class="header-right-flex">
            <button id="sa-filter-toggle-btn" class="filter-toggle-btn" type="button">
              <span class="hamburger-icon">☰</span><span>Filter</span>
            </button>
            <button id="sa-clear-filters-btn" class="clear-btn" type="button">Hapus filter</button>
            <div class="card-tag">Provinsi · Kota · Job Parent · Job Type</div>
          </div>
        </div>

        <div class="sa-filter-body">
          <div class="sa-filters">
            <div class="filter-group">
              <label class="filter-label">Provinsi</label>
              <div class="ms" id="sa-ms-prov">
                <button type="button" class="ms-toggle">
                  <span class="ms-placeholder">Semua Provinsi</span>
                  <span class="ms-counter"></span><span class="ms-arrow">▾</span>
                </button>
                <div class="ms-panel">
                  <input class="ms-search" type="text" placeholder="Cari provinsi..." />
                  <div class="ms-options"></div><div class="ms-empty">Tidak ada provinsi</div>
                </div>
              </div>
            </div>

            <div class="filter-group">
              <label class="filter-label">Kota</label>
              <div class="ms ms-disabled" id="sa-ms-kota">
                <button type="button" class="ms-toggle">
                  <span class="ms-placeholder">Pilih provinsi terlebih dahulu</span>
                  <span class="ms-counter"></span><span class="ms-arrow">▾</span>
                </button>
                <div class="ms-panel">
                  <input class="ms-search" type="text" placeholder="Cari kota..." />
                  <div class="ms-options"></div><div class="ms-empty">Tidak ada kota</div>
                </div>
              </div>
            </div>

            <div class="filter-group">
              <label class="filter-label">Job Parent</label>
              <div class="ms" id="sa-ms-job-parent">
                <button type="button" class="ms-toggle">
                  <span class="ms-placeholder">Semua Job Parent</span>
                  <span class="ms-counter"></span><span class="ms-arrow">▾</span>
                </button>
                <div class="ms-panel">
                  <input class="ms-search" type="text" placeholder="Cari job parent..." />
                  <div class="ms-options"></div><div class="ms-empty">Tidak ada job parent</div>
                </div>
              </div>
            </div>

            <div class="filter-group">
              <label class="filter-label">Job Type</label>
              <div class="ms ms-disabled" id="sa-ms-job-type">
                <button type="button" class="ms-toggle">
                  <span class="ms-placeholder">Pilih Job Parent terlebih dahulu</span>
                  <span class="ms-counter"></span><span class="ms-arrow">▾</span>
                </button>
                <div class="ms-panel">
                  <input class="ms-search" type="text" placeholder="Cari job type..." />
                  <div class="ms-options"></div><div class="ms-empty">Tidak ada job type</div>
                </div>
              </div>
            </div>
          </div>

          <div class="filter-hint">* Insight otomatis akan mengikuti filter di atas.</div>
        </div>
      </section>

      <section class="card">
        <div class="card-title-row">
          <div class="card-title">Analisa Best Practice Sourcing</div>
          <div class="card-tag">Auto Insight</div>
        </div>
        <div id="sa-analysis-text" class="analysis-text">
          Pilih filter untuk melihat rekomendasi channel terbaik berdasarkan Applicant Valid.
        </div>
      </section>
    </section>

    <!-- ===================== PAGE: Performance Client ===================== -->
    <section id="page-pc" class="page">
      <section class="card perf-filter-card" id="pc-filter-card">
        <div class="card-title-row">
          <div class="card-title">Filter Performance Sourcing Client</div>
          <div class="header-right-flex">
            <button id="pc-filter-toggle-btn" class="filter-toggle-btn" type="button">
              <span class="hamburger-icon">☰</span><span>Filter</span>
            </button>
            <button id="pc-clear-btn" class="clear-btn" type="button">Hapus filter</button>
            <div class="card-tag">Industry</div>
          </div>
        </div>
        <div class="card-subtext">
          Pilih <strong>Industry</strong> untuk menampilkan data per <strong>Client</strong>. Nilai tampil format <strong>xx.xx%</strong>.
        </div>

        <div class="perf-filter-body">
          <div class="perf-filters">
            <div class="filter-group">
              <label class="filter-label">Industry</label>
              <select id="pc-industry" class="perf-select">
                <option value="">Pilih Industry...</option>
              </select>
            </div>
          </div>

          <div id="pc-load-state" class="loading"><div class="spinner"></div><span>Memuat Performance Client...</span></div>
          <div id="pc-error-state" class="error" style="display:none;"></div>

          <div class="status-bar" style="margin-top:10px;">
            <div class="status-left"><span class="status-dot"></span><span id="pc-status-text">Menunggu data...</span></div>
            <div class="status-right" id="pc-col-note"></div>
          </div>
        </div>
      </section>

      <section class="stack-col">
        <article class="card">
          <div class="card-title-row">
            <div class="card-title">Achievement Rasio Submit</div>
            <div class="card-tag">Client × Bulan</div>
          </div>
          <div class="table-wrap">
            <table class="matrix-table">
              <thead id="pc-submit-head"></thead>
              <tbody id="pc-submit-body"></tbody>
            </table>
          </div>
          <div id="pc-submit-empty" class="matrix-empty">Pilih Industry dulu.</div>
        </article>

        <article class="card">
          <div class="card-title-row">
            <div class="card-title">Achievement Applicant Qualified</div>
            <div class="card-tag">Client × Bulan</div>
          </div>
          <div class="table-wrap">
            <table class="matrix-table">
              <thead id="pc-qual-head"></thead>
              <tbody id="pc-qual-body"></tbody>
            </table>
          </div>
          <div id="pc-qual-empty" class="matrix-empty">Pilih Industry dulu.</div>
        </article>
      </section>
    </section>

    <!-- ===================== PAGE: Performance Area ===================== -->
    <section id="page-pa" class="page">
      <section class="card perf-filter-card" id="pa-filter-card">
        <div class="card-title-row">
          <div class="card-title">Filter Performance Sourcing Area</div>
          <div class="header-right-flex">
            <button id="pa-filter-toggle-btn" class="filter-toggle-btn" type="button">
              <span class="hamburger-icon">☰</span><span>Filter</span>
            </button>
            <button id="pa-clear-btn" class="clear-btn" type="button">Hapus filter</button>
            <div class="card-tag">Group Client · Area</div>
          </div>
        </div>

        <div class="card-subtext">
          Pilih <strong>Group Client</strong> lalu pilih <strong>Area</strong> (opsional). Nilai tampil format <strong>xx.xx%</strong>.
        </div>

        <div class="perf-filter-body">
          <div class="perf-filters">
            <div class="filter-group">
              <label class="filter-label">Group Client</label>
              <select id="pa-group" class="perf-select">
                <option value="">Pilih Group Client...</option>
              </select>
            </div>

            <div class="filter-group">
              <label class="filter-label">Area</label>
              <select id="pa-area" class="perf-select" disabled>
                <option value="">Semua Area</option>
              </select>
            </div>
          </div>

          <div id="pa-load-state" class="loading"><div class="spinner"></div><span>Memuat Performance Area...</span></div>
          <div id="pa-error-state" class="error" style="display:none;"></div>

          <div class="status-bar" style="margin-top:10px;">
            <div class="status-left"><span class="status-dot"></span><span id="pa-status-text">Menunggu data...</span></div>
            <div class="status-right" id="pa-col-note"></div>
          </div>
        </div>
      </section>

      <section class="stack-col">
        <article class="card">
          <div class="card-title-row">
            <div class="card-title">Achievement Rasio Submit</div>
            <div class="card-tag">Area × Bulan</div>
          </div>
          <div class="table-wrap">
            <table class="matrix-table">
              <thead id="pa-submit-head"></thead>
              <tbody id="pa-submit-body"></tbody>
            </table>
          </div>
          <div id="pa-submit-empty" class="matrix-empty">Pilih Group Client dulu.</div>
        </article>

        <article class="card">
          <div class="card-title-row">
            <div class="card-title">Achievement Qualified</div>
            <div class="card-tag">Area × Bulan</div>
          </div>
          <div class="table-wrap">
            <table class="matrix-table">
              <thead id="pa-qual-head"></thead>
              <tbody id="pa-qual-body"></tbody>
            </table>
          </div>
          <div id="pa-qual-empty" class="matrix-empty">Pilih Group Client dulu.</div>
        </article>
      </section>
    </section>

    <!-- ===================== PAGE: Performance Jobtype ===================== -->
    <section id="page-pj" class="page">
      <section class="card perf-filter-card" id="pj-filter-card">
        <div class="card-title-row">
          <div class="card-title">Filter Performance Jobtype</div>
          <div class="header-right-flex">
            <button id="pj-filter-toggle-btn" class="filter-toggle-btn" type="button">
              <span class="hamburger-icon">☰</span><span>Filter</span>
            </button>
            <button id="pj-clear-btn" class="clear-btn" type="button">Hapus filter</button>
            <div class="card-tag">Area · Job Parent · Job Type</div>
          </div>
        </div>

        <div class="card-subtext">
          <strong>Revisi sesuai request:</strong> pada dataset Jobtype, <strong>Job Type = kolom A</strong> dan <strong>Job Parent = kolom B</strong>.
        </div>

        <div class="perf-filter-body">
          <div class="perf-filters">
            <div class="filter-group">
              <label class="filter-label">Area (diambil dari data Performance Area)</label>
              <select id="pj-area" class="perf-select">
                <option value="">Semua Area</option>
              </select>
              <div class="tiny-note">Jika data Jobtype tidak punya kolom Area, dropdown Area hanya untuk label (tidak memfilter angka).</div>
            </div>

            <div class="filter-group">
              <label class="filter-label">Job Parent (Kolom B)</label>
              <select id="pj-parent" class="perf-select">
                <option value="">Pilih Job Parent...</option>
              </select>
            </div>

            <div class="filter-group">
              <label class="filter-label">Job Type (Kolom A)</label>
              <select id="pj-type" class="perf-select" disabled>
                <option value="">Pilih Job Type...</option>
              </select>
            </div>
          </div>

          <div id="pj-load-state" class="loading"><div class="spinner"></div><span>Memuat Performance Jobtype...</span></div>
          <div id="pj-error-state" class="error" style="display:none;"></div>

          <div class="status-bar" style="margin-top:10px;">
            <div class="status-left"><span class="status-dot"></span><span id="pj-status-text">Menunggu data...</span></div>
            <div class="status-right" id="pj-col-note"></div>
          </div>
        </div>
      </section>

      <section class="stack-col">
        <article class="card">
          <div class="card-title-row">
            <div class="card-title">Achievement Rasio Submit (Job Parent)</div>
            <div class="card-tag">Parent × Bulan</div>
          </div>
          <div class="table-wrap">
            <table class="matrix-table">
              <thead id="pj-parent-submit-head"></thead>
              <tbody id="pj-parent-submit-body"></tbody>
            </table>
          </div>
          <div id="pj-parent-empty" class="matrix-empty">Pilih Job Parent dulu.</div>
        </article>

        <article class="card">
          <div class="card-title-row">
            <div class="card-title">Achievement Rasio Submit (Job Type)</div>
            <div class="card-tag">Type × Bulan</div>
          </div>
          <div class="table-wrap">
            <table class="matrix-table">
              <thead id="pj-submit-head"></thead>
              <tbody id="pj-submit-body"></tbody>
            </table>
          </div>
          <div id="pj-submit-empty" class="matrix-empty">Pilih Job Parent (opsional Job Type) dulu.</div>
        </article>

        <article class="card">
          <div class="card-title-row">
            <div class="card-title">Achievement Qualified (Job Type)</div>
            <div class="card-tag">Type × Bulan</div>
          </div>
          <div class="table-wrap">
            <table class="matrix-table">
              <thead id="pj-qual-head"></thead>
              <tbody id="pj-qual-body"></tbody>
            </table>
          </div>
          <div id="pj-qual-empty" class="matrix-empty">Pilih Job Parent (opsional Job Type) dulu.</div>
        </article>
      </section>
    </section>

  </main>
</div>

<script>
/* =========================================================
   KONFIGURASI CSV URL (GANTI JIKA PERLU)
========================================================= */
const CSV_URL_ACM = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ1IRy6uulUDdZtEV05QNMrse9vdqLTn_NDDoi-KgYTkEBV44HZAqAZHqgOQ6m4FwZ59kcQxHm3elhT/pub?gid=1347000673&single=true&output=csv";

/* Performance: Jika URL kamu berbeda, ganti 3 baris ini */
const CSV_URL_CLIENT  = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTt_Ogppb0Q15snoZmje8NSvgpsBuu4cqhy4e8YY8eJgYNSNyHsKNC4G5rUQz70aFTm0O2ARoXeIUgz/pub?gid=1768056592&single=true&output=csv";
const CSV_URL_AREA    = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTt_Ogppb0Q15snoZmje8NSvgpsBuu4cqhy4e8YY8eJgYNSNyHsKNC4G5rUQz70aFTm0O2ARoXeIUgz/pub?gid=631317217&single=true&output=csv";
const CSV_URL_JOBTYPE = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTt_Ogppb0Q15snoZmje8NSvgpsBuu4cqhy4e8YY8eJgYNSNyHsKNC4G5rUQz70aFTm0O2ARoXeIUgz/pub?gid=1873604383&single=true&output=csv";

/* =========================================================
   UTILITIES
========================================================= */
const $ = (id)=>document.getElementById(id);
const norm = (v)=>String(v ?? "").trim().toUpperCase();
const trimStr = (v)=>String(v ?? "").trim();
const numberFmt = new Intl.NumberFormat("id-ID",{maximumFractionDigits:0});
const percentFmt2 = new Intl.NumberFormat("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2});

const MONTHS = [
  {idx:1,label:"Januari", tokens:["JANUARI","JAN"]},
  {idx:2,label:"Februari", tokens:["FEBRUARI","FEB"]},
  {idx:3,label:"Maret", tokens:["MARET","MAR"]},
  {idx:4,label:"April", tokens:["APRIL","APR"]},
  {idx:5,label:"Mei", tokens:["MEI","MAY"]},
  {idx:6,label:"Juni", tokens:["JUNI","JUN"]},
  {idx:7,label:"Juli", tokens:["JULI","JUL"]},
  {idx:8,label:"Agustus", tokens:["AGUSTUS","AGU","AUG"]},
  {idx:9,label:"September", tokens:["SEPTEMBER","SEP"]},
  {idx:10,label:"Oktober", tokens:["OKTOBER","OKT","OCT"]},
  {idx:11,label:"November", tokens:["NOVEMBER","NOV"]},
  {idx:12,label:"Desember", tokens:["DESEMBER","DES","DEC"]},
];

function uniqueSorted(arr){
  return Array.from(new Set((arr||[]).map(v=>String(v??"").trim()).filter(v=>v!=="")))
    .sort((a,b)=>a.localeCompare(b,"id"));
}

function loadCsv(url){
  return new Promise((resolve,reject)=>{
    Papa.parse(url,{
      download:true, header:true, skipEmptyLines:true,
      complete:(parsed)=>{
        try{
          resolve({
            rows: parsed.data || [],
            fields: (parsed.meta && parsed.meta.fields) ? parsed.meta.fields : []
          });
        }catch(e){ reject(e); }
      },
      error:(err)=>reject(err)
    });
  });
}

function toFloat(v){
  if(v==null) return null;
  let s = String(v).trim();
  if(!s) return null;
  s = s.replace("%","").trim();
  s = s.replace(/[^0-9.,-]/g,"");
  if(!s) return null;
  if(s.includes(",") && s.includes(".")){
    s = s.replace(/\./g,"").replace(",",".");
  }else{
    if(s.includes(",")) s = s.replace(",",".");
  }
  const n = Number(s);
  return isNaN(n) ? null : n;
}
function fmtPercent(v){
  const n = toFloat(v);
  if(n==null) return "-";
  const pct = (n>0 && n<=1) ? (n*100) : n;
  return `${percentFmt2.format(pct)}%`;
}
function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

/* parse month index from PERIODE (robust) */
function parseMonthIndex(periodStr){
  const s = norm(periodStr);
  if(!s) return null;

  // if contains number month like "2025-02" or "02/2025"
  const m1 = s.match(/\b(0?[1-9]|1[0-2])\b/);
  // do NOT take year like 2025; prefer token-based if possible
  // We'll search month names first:
  for(const m of MONTHS){
    if(m.tokens.some(t=>s.includes(t))) return m.idx;
  }
  // then try patterns YYYY-MM or MM-YYYY
  const mIso = s.match(/(\d{4})[-/](0?[1-9]|1[0-2])\b/);
  if(mIso) return Number(mIso[2]);
  const mIso2 = s.match(/\b(0?[1-9]|1[0-2])[-/](\d{4})/);
  if(mIso2) return Number(mIso2[1]);

  // fallback: standalone small number (avoid year)
  if(m1){
    const n = Number(m1[1]);
    if(n>=1 && n<=12) return n;
  }
  return null;
}

/* =========================================================
   MULTISELECT
========================================================= */
function createMultiSelect(rootId, options, placeholder, disabled, onChange){
  const root = $(rootId);
  const toggle = root.querySelector(".ms-toggle");
  const searchInput = root.querySelector(".ms-search");
  const optsContainer = root.querySelector(".ms-options");
  const emptyEl = root.querySelector(".ms-empty");
  const labelSpan = root.querySelector(".ms-placeholder");
  const counterSpan = root.querySelector(".ms-counter");

  const state = { options:[...(options||[])], selected:new Set() };

  function updateLabel(){
    const count = state.selected.size;
    if(count===0){
      labelSpan.textContent = placeholder;
      counterSpan.textContent = "";
    }else if(count<=2){
      labelSpan.textContent = Array.from(state.selected).join(", ");
      counterSpan.textContent = "";
    }else{
      labelSpan.textContent = placeholder;
      counterSpan.textContent = count+" dipilih";
    }
  }

  function renderOptions(){
    optsContainer.innerHTML = "";
    const term = searchInput.value.toLowerCase();
    let visible = 0;

    state.options.forEach(val=>{
      const text = String(val);
      if(term && !text.toLowerCase().includes(term)) return;
      visible++;

      const label = document.createElement("label");
      label.className = "ms-option";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.value = text;
      cb.checked = state.selected.has(text);

      cb.addEventListener("change",()=>{
        if(cb.checked) state.selected.add(text);
        else state.selected.delete(text);
        updateLabel();
        onChange && onChange(getSelected());
      });

      const span = document.createElement("span");
      span.textContent = text;

      label.appendChild(cb);
      label.appendChild(span);
      optsContainer.appendChild(label);
    });

    emptyEl.style.display = visible ? "none" : "block";
  }

  function getSelected(){ return Array.from(state.selected); }

  function setOptions(newOptions){
    state.options = [...(newOptions||[])];
    state.selected.clear();
    searchInput.value = "";
    renderOptions();
    updateLabel();
    onChange && onChange(getSelected());
  }

  function setDisabled(flag){
    if(flag){
      root.classList.add("ms-disabled");
      root.classList.remove("open");
    }else{
      root.classList.remove("ms-disabled");
    }
  }

  function clear(){
    state.selected.clear();
    searchInput.value = "";
    renderOptions();
    updateLabel();
    onChange && onChange(getSelected());
  }

  toggle.addEventListener("click",()=>{
    if(root.classList.contains("ms-disabled")) return;
    const isOpen = root.classList.toggle("open");
    if(isOpen){
      searchInput.value = "";
      renderOptions();
      searchInput.focus();
    }
  });
  searchInput.addEventListener("input",renderOptions);
  document.addEventListener("click",(e)=>{
    if(!root.contains(e.target)) root.classList.remove("open");
  });

  setDisabled(!!disabled);
  renderOptions(); updateLabel();
  return {getSelected,setOptions,setDisabled,clear};
}

/* =========================================================
   ACM CONFIG & DATA
========================================================= */
/* Column names (ACM) */
let COL_PROV      = "PROVINSI MINAT PENEMPATAN";
let COL_KOTA      = "KOTA MINAT PENEMPATAN";
let COL_PERIODE   = "PERIODE PELAMAR";
let COL_KATEGORI  = "KATEGORI APP";
let COL_QUALIFIED = "QUALIFIED";
let COL_METODE    = "METODE SOURCING";
let COL_MEDIA     = "MEDIA SOURCING";
let COL_EDU       = "PENDIDIKAN TERAKHIR";
let COL_GENDER    = "JENIS KELAMIN";
let COL_JOB_PARENT= "JOB PARENT";
let COL_JOB_TYPE  = "JOB TYPE";

const KATEGORI_VALID_TARGET = "APLIKAN VALID - CTC 1";
const LABEL_LAINNYA = "LAINNYA / TIDAK TERDETEKSI";

/* Fixed lists */
const FIXED_PROV_LIST = [
  "ACEH (NAD)","BALI","BANTEN","BENGKULU","DI YOGYAKARTA","DKI JAKARTA",
  "GORONTALO","JAMBI","JAWA BARAT","JAWA TENGAH","JAWA TIMUR",
  "KALIMANTAN BARAT","KALIMANTAN SELATAN","KALIMANTAN TENGAH",
  "KALIMANTAN TIMUR","KALIMANTAN UTARA","KEPULAUAN BANGKA BELITUNG",
  "KEPULAUAN RIAU","LAMPUNG","MALUKU","MALUKU UTARA",
  "NUSA TENGGARA BARAT (NTB)","NUSA TENGGARA TIMUR (NTT)",
  "PAPUA","PAPUA BARAT DAYA","PAPUA SELATAN","PAPUA TENGAH",
  "RIAU","SULAWESI BARAT","SULAWESI SELATAN","SULAWESI TENGAH",
  "SULAWESI TENGGARA","SULAWESI TIMUR","SULAWESI UTARA",
  "SUMATERA BARAT","SUMATERA SELATAN","SUMATERA UTARA"
];
const FIXED_MEDIA_LIST = ["Facebook","FLK","Instagram","Linkedin","SIM Talent Search","Telegram","Tiktok","Twitter","Whatsapp / Media Chat"];
const FIXED_PORTAL_LIST = ["Glints","Hired Today","Indeed","JobStreet","Jobstreet Express","KarirHub","KitaLutus","KitaLulus","Lumina","Pintarnya"];
const FIXED_OFFLINE_LIST = [
  "Academy/Training/Seminar","Balai Latian Kerja (BLK)","Brosur/Banner/Spanduk/Flyer",
  "Campus Hiring","Disnaker","Drop CV","Freelance Recruiter","Job Fair",
  "Komunitas Informal","Referensi Client","Referensi Teman/Keluarga/Komunitas",
  "School Hiring","Walk In Interview (WI)"
];
const FIXED_EDU_LIST = ["SMP","SMA / SMK","D1","D2","D3","D4","S1","S2","S3"];

/* State */
let acmRows = [];
let acmFields = [];

let msProv, msKota, msPeriode, msJobParent, msJobType;
let saProvMS, saKotaMS, saJobParentMS, saJobTypeMS;

const provKotaMap = new Map();
const jobParentTypeMap = new Map();

/* Detect columns by header similarity */
function findField(fields, candidates){
  const set = candidates.map(norm);
  const exact = fields.find(f=>set.includes(norm(f)));
  if(exact) return exact;
  // fallback by includes
  for(const f of fields){
    const s = norm(f);
    for(const c of candidates){
      const cs = norm(c);
      if(s.includes(cs)) return f;
    }
  }
  return null;
}
function detectACMColumns(fields){
  if(!fields || !fields.length) return;
  const prov = findField(fields, ["PROVINSI MINAT PENEMPATAN","PROVINSI"]);
  const kota = findField(fields, ["KOTA MINAT PENEMPATAN","KOTA"]);
  const periode = findField(fields, ["PERIODE PELAMAR","PERIODE"]);
  const kategori = findField(fields, ["KATEGORI APP","KATEGORI"]);
  const qualified = findField(fields, ["QUALIFIED"]);
  const metode = findField(fields, ["METODE SOURCING","METODE"]);
  const media = findField(fields, ["MEDIA SOURCING","MEDIA"]);
  const edu = findField(fields, ["PENDIDIKAN TERAKHIR","PENDIDIKAN"]);
  const gender = findField(fields, ["JENIS KELAMIN","GENDER"]);
  const jp = findField(fields, ["JOB PARENT"]);
  const jt = findField(fields, ["JOB TYPE"]);

  if(prov) COL_PROV = prov;
  if(kota) COL_KOTA = kota;
  if(periode) COL_PERIODE = periode;
  if(kategori) COL_KATEGORI = kategori;
  if(qualified) COL_QUALIFIED = qualified;
  if(metode) COL_METODE = metode;
  if(media) COL_MEDIA = media;
  if(edu) COL_EDU = edu;
  if(gender) COL_GENDER = gender;
  if(jp) COL_JOB_PARENT = jp;
  if(jt) COL_JOB_TYPE = jt;
}

function isKategoriValid(row){
  return norm(row[COL_KATEGORI]) === norm(KATEGORI_VALID_TARGET);
}
function isQualifiedYes(row){
  const s = norm(row[COL_QUALIFIED]);
  return s === "YES" || s === "YA";
}
function getValidFlag(row){
  return isKategoriValid(row) && isQualifiedYes(row) ? 1 : 0;
}
function getBufferFlag(row){
  return isKategoriValid(row) && !isQualifiedYes(row) ? 1 : 0;
}
function genderBucket(row){
  const s = norm(row[COL_GENDER]);
  if(!s) return "UNK";
  if(s === "L" || s.includes("LAKI") || s==="M" || s.includes("MALE")) return "M";
  if(s === "P" || s.includes("PEREM") || s==="F" || s.includes("FEMALE")) return "F";
  return "UNK";
}

/* Build dependency maps */
function buildProvKotaMap(){
  provKotaMap.clear();
  acmRows.forEach(r=>{
    const p = trimStr(r[COL_PROV]);
    const k = trimStr(r[COL_KOTA]);
    if(!p || !k) return;
    if(!provKotaMap.has(p)) provKotaMap.set(p, new Set());
    provKotaMap.get(p).add(k);
  });
}
function buildJobParentTypeMap(){
  jobParentTypeMap.clear();
  acmRows.forEach(r=>{
    const jp = trimStr(r[COL_JOB_PARENT]);
    const jt = trimStr(r[COL_JOB_TYPE]);
    if(!jp || !jt) return;
    if(!jobParentTypeMap.has(jp)) jobParentTypeMap.set(jp, new Set());
    jobParentTypeMap.get(jp).add(jt);
  });
}

/* Filter helpers */
function getFilteredACMRows(){
  const provSel = new Set(msProv ? msProv.getSelected() : []);
  const kotaSel = new Set(msKota ? msKota.getSelected() : []);
  const perSel  = new Set(msPeriode ? msPeriode.getSelected() : []);
  const jpSel   = new Set(msJobParent ? msJobParent.getSelected() : []);
  const jtSel   = new Set(msJobType ? msJobType.getSelected() : []);

  return acmRows.filter(r=>{
    const p = trimStr(r[COL_PROV]);
    const k = trimStr(r[COL_KOTA]);
    const pe= trimStr(r[COL_PERIODE]);
    const jp= trimStr(r[COL_JOB_PARENT]);
    const jt= trimStr(r[COL_JOB_TYPE]);

    if(provSel.size && !provSel.has(p)) return false;
    if(kotaSel.size && !kotaSel.has(k)) return false;
    if(perSel.size  && !perSel.has(pe)) return false;
    if(jpSel.size   && !jpSel.has(jp)) return false;
    if(jtSel.size   && !jtSel.has(jt)) return false;
    return true;
  });
}

function updateKotaOptionsByProv(selProv){
  if(!msKota) return;
  if(!selProv || !selProv.length){
    msKota.setOptions([]);
    msKota.setDisabled(true);
    return;
  }
  const set = new Set();
  selProv.forEach(p=>{
    const s = provKotaMap.get(p);
    if(s) s.forEach(v=>set.add(v));
  });
  msKota.setOptions(uniqueSorted(Array.from(set)));
  msKota.setDisabled(false);
}
function updateJobTypeOptionsByParent(selParents){
  if(!msJobType) return;
  if(!selParents || !selParents.length){
    msJobType.setOptions([]);
    msJobType.setDisabled(true);
    return;
  }
  const set = new Set();
  selParents.forEach(p=>{
    const s = jobParentTypeMap.get(p);
    if(s) s.forEach(v=>set.add(v));
  });
  msJobType.setOptions(uniqueSorted(Array.from(set)));
  msJobType.setDisabled(false);
}

/* Init ACM filters */
function initACMFilters(){
  buildProvKotaMap();
  buildJobParentTypeMap();

  const provVals = uniqueSorted(Array.from(provKotaMap.keys()));
  const periodeVals = uniqueSorted(acmRows.map(r=>r[COL_PERIODE]));
  const jobParentVals = uniqueSorted(Array.from(jobParentTypeMap.keys()));

  msProv = createMultiSelect("ms-prov", provVals, "Semua Provinsi", false, (sel)=>{
    updateKotaOptionsByProv(sel);
    updateACMAll();
  });
  msKota = createMultiSelect("ms-kota", [], "Semua kota di provinsi ini", true, ()=>{
    updateACMAll();
  });
  msPeriode = createMultiSelect("ms-periode", periodeVals, "Semua Periode", false, ()=>{
    updateACMAll();
  });
  msJobParent = createMultiSelect("ms-job-parent", jobParentVals, "Semua Job Parent", false, (sel)=>{
    updateJobTypeOptionsByParent(sel);
    updateACMAll();
  });
  msJobType = createMultiSelect("ms-job-type", [], "Semua Job Type", true, ()=>{
    updateACMAll();
  });
}

function clearACMFilters(){
  msProv && msProv.clear();
  msPeriode && msPeriode.clear();
  msJobParent && msJobParent.clear();
  if(msKota){
    msKota.setOptions([]);
    msKota.setDisabled(true);
  }
  if(msJobType){
    msJobType.setOptions([]);
    msJobType.setDisabled(true);
  }
  updateACMAll();
}

/* =========================================================
   ACM RENDER: tables + summary + chart
========================================================= */
function renderRowsToTbody(tbodyId, rows){
  const tb = $(tbodyId);
  tb.innerHTML = "";
  rows.forEach(r=>{
    const tr = document.createElement("tr");

    const tdLabel = document.createElement("td");
    tdLabel.textContent = r.label;
    tdLabel.className = "col-label";
    tr.appendChild(tdLabel);

    const tdV = document.createElement("td");
    tdV.textContent = numberFmt.format(r.valid);
    tdV.className = "col-number";
    tr.appendChild(tdV);

    const tdB = document.createElement("td");
    tdB.textContent = numberFmt.format(r.buffer);
    tdB.className = "col-number";
    tr.appendChild(tdB);

    tb.appendChild(tr);
  });
}

function addTotalRow(tbodyId, totalLabel, valid, buffer){
  const tb = $(tbodyId);
  const tr = document.createElement("tr");
  tr.className = "total-row";

  const td0 = document.createElement("td");
  td0.textContent = totalLabel;
  tr.appendChild(td0);

  const td1 = document.createElement("td");
  td1.textContent = numberFmt.format(valid);
  td1.className = "col-number";
  tr.appendChild(td1);

  const td2 = document.createElement("td");
  td2.textContent = numberFmt.format(buffer);
  td2.className = "col-number";
  tr.appendChild(td2);

  tb.appendChild(tr);
}

function aggregateByKey(rows, keyFn){
  const map = new Map();
  rows.forEach(r=>{
    const key = trimStr(keyFn(r)) || "";
    const v = getValidFlag(r);
    const b = getBufferFlag(r);
    if(!map.has(key)) map.set(key, {valid:0, buffer:0});
    const obj = map.get(key);
    obj.valid += v;
    obj.buffer += b;
  });
  return map;
}

/* Provinces table: include others row to keep total match */
function buildProvTable(rows){
  const map = aggregateByKey(rows, r=>r[COL_PROV]);

  let out = [];
  let validSum = 0, bufferSum = 0;
  const fixedSet = new Set(FIXED_PROV_LIST.map(norm));

  FIXED_PROV_LIST.forEach(name=>{
    const obj = map.get(name) || map.get(trimStr(name)) || map.get(name.toUpperCase()) || null;
    const v = obj ? obj.valid : 0;
    const b = obj ? obj.buffer : 0;
    if(v+b>0) out.push({label:name, valid:v, buffer:b});
    validSum += v; bufferSum += b;
  });

  // compute other provinces
  let otherV = 0, otherB = 0;
  for(const [k,obj] of map.entries()){
    const kk = norm(k);
    if(!kk) continue;
    if(!fixedSet.has(kk)){
      otherV += obj.valid;
      otherB += obj.buffer;
    }
  }
  if(otherV+otherB>0){
    out.push({label:LABEL_LAINNYA, valid:otherV, buffer:otherB});
    validSum += otherV; bufferSum += otherB;
  }

  // if filters narrow and no row appears, show selected ones
  if(out.length===0){
    // show at least total 0 row
    out.push({label:"(Tidak ada data)", valid:0, buffer:0});
  }

  renderRowsToTbody("tbl-prov-body", out);
  addTotalRow("tbl-prov-body","TOTAL", validSum, bufferSum);
  $("status-prov").textContent = `Menampilkan ${rows.length} baris (filter aktif).`;
}

/* Metode table by MEDIA SOURCING (3 bucket + others) */
function buildMetodeTable(rows){
  const map = aggregateByKey(rows, r=>r[COL_MEDIA]);
  const buckets = ["OFFLINE","ONLINE - JOB PORTAL","ONLINE - MEDIA SOSIAL"];
  let out = [];
  let validSum=0, bufferSum=0;

  const used = new Set();
  buckets.forEach(b=>{
    const obj = map.get(b) || map.get(buckets.find(x=>norm(x)===norm(b))) || null;
    const v = obj ? obj.valid : 0;
    const bu= obj ? obj.buffer : 0;
    out.push({label:b, valid:v, buffer:bu});
    used.add(norm(b));
    validSum += v; bufferSum += bu;
  });

  // others
  let otherV=0, otherB=0;
  for(const [k,obj] of map.entries()){
    const kk = norm(k);
    if(!kk) continue;
    if(!used.has(kk)){
      otherV += obj.valid;
      otherB += obj.buffer;
    }
  }
  if(otherV+otherB>0){
    out.push({label:LABEL_LAINNYA, valid:otherV, buffer:otherB});
    validSum += otherV; bufferSum += otherB;
  }

  renderRowsToTbody("tbl-metode-body", out);
  addTotalRow("tbl-metode-body","TOTAL", validSum, bufferSum);
  $("status-metode").textContent = `Menampilkan ${rows.length} baris (filter aktif).`;
}

/* Media Sosial breakdown by METODE SOURCING within ONLINE - MEDIA SOSIAL */
function buildMediaSosialTable(rows){
  const subset = rows.filter(r=>norm(r[COL_MEDIA])===norm("ONLINE - MEDIA SOSIAL"));
  const map = aggregateByKey(subset, r=>r[COL_METODE]);

  const out = [];
  let validSum=0, bufferSum=0;
  FIXED_MEDIA_LIST.forEach(name=>{
    const obj = map.get(name) || null;
    const v = obj ? obj.valid : 0;
    const b = obj ? obj.buffer : 0;
    out.push({label:name, valid:v, buffer:b});
    validSum += v; bufferSum += b;
  });

  renderRowsToTbody("tbl-media-body", out);
  addTotalRow("tbl-media-body","TOTAL", validSum, bufferSum);
  $("status-media").textContent = `Subset Media Sosial: ${subset.length} baris.`;
}

/* Education table */
function buildEduTable(rows){
  const map = aggregateByKey(rows, r=>r[COL_EDU]);
  const out = [];
  let validSum=0, bufferSum=0;

  FIXED_EDU_LIST.forEach(name=>{
    const obj = map.get(name) || null;
    const v = obj ? obj.valid : 0;
    const b = obj ? obj.buffer : 0;
    out.push({label:name, valid:v, buffer:b});
    validSum += v; bufferSum += b;
  });

  renderRowsToTbody("tbl-edu-body", out);
  addTotalRow("tbl-edu-body","TOTAL", validSum, bufferSum);
  $("status-edu").textContent = `Menampilkan ${rows.length} baris (filter aktif).`;
}

/* Job Portal breakdown */
function buildPortalTable(rows){
  const subset = rows.filter(r=>norm(r[COL_MEDIA])===norm("ONLINE - JOB PORTAL"));
  const map = aggregateByKey(subset, r=>r[COL_METODE]);

  const out = [];
  let validSum=0, bufferSum=0;
  FIXED_PORTAL_LIST.forEach(name=>{
    const obj = map.get(name) || null;
    const v = obj ? obj.valid : 0;
    const b = obj ? obj.buffer : 0;
    out.push({label:name, valid:v, buffer:b});
    validSum += v; bufferSum += b;
  });

  renderRowsToTbody("tbl-portal-body", out);
  addTotalRow("tbl-portal-body","TOTAL", validSum, bufferSum);
  $("status-portal").textContent = `Subset Job Portal: ${subset.length} baris.`;
}

/* Offline breakdown */
function buildOfflineTable(rows){
  const subset = rows.filter(r=>norm(r[COL_MEDIA])===norm("OFFLINE"));
  const map = aggregateByKey(subset, r=>r[COL_METODE]);

  const out = [];
  let validSum=0, bufferSum=0;
  FIXED_OFFLINE_LIST.forEach(name=>{
    const obj = map.get(name) || null;
    const v = obj ? obj.valid : 0;
    const b = obj ? obj.buffer : 0;
    out.push({label:name, valid:v, buffer:b});
    validSum += v; bufferSum += b;
  });

  renderRowsToTbody("tbl-offline-body", out);
  addTotalRow("tbl-offline-body","TOTAL", validSum, bufferSum);
  $("status-offline").textContent = `Subset Offline: ${subset.length} baris.`;
}

/* Summary cards */
function updateSummary(rows){
  let mv=0, mb=0, fv=0, fb=0, tv=0, tb=0;

  rows.forEach(r=>{
    const v = getValidFlag(r);
    const b = getBufferFlag(r);
    tv += v; tb += b;
    const g = genderBucket(r);
    if(g==="M"){ mv += v; mb += b; }
    else if(g==="F"){ fv += v; fb += b; }
  });

  $("sum-male-valid").textContent = numberFmt.format(mv);
  $("sum-male-buffer").textContent = numberFmt.format(mb);
  $("sum-female-valid").textContent = numberFmt.format(fv);
  $("sum-female-buffer").textContent = numberFmt.format(fb);
  $("sum-total-valid").textContent = numberFmt.format(tv);
  $("sum-total-buffer").textContent = numberFmt.format(tb);
}

/* Chart monthly */
function updateMonthlyChart(rows){
  const bucket = new Map();
  MONTHS.forEach(m=>bucket.set(m.idx, {valid:0, buffer:0}));

  let skipped=0;
  rows.forEach(r=>{
    if(!isKategoriValid(r)) return;
    const mi = parseMonthIndex(r[COL_PERIODE]);
    if(!mi){ skipped++; return; }
    const obj = bucket.get(mi);
    if(!obj) return;
    obj.valid += isQualifiedYes(r) ? 1 : 0;
    obj.buffer += isQualifiedYes(r) ? 0 : 1;
  });

  let maxV=1;
  for(const m of MONTHS){
    const o = bucket.get(m.idx);
    maxV = Math.max(maxV, o.valid, o.buffer);
  }

  const body = $("chart-body");
  body.innerHTML = "";

  MONTHS.forEach(m=>{
    const o = bucket.get(m.idx);
    const validH = Math.round((o.valid / maxV) * 190);
    const bufferH= Math.round((o.buffer/ maxV) * 190);

    const col = document.createElement("div");
    col.className = "chart-col";

    const bars = document.createElement("div");
    bars.className = "chart-col-bars";

    const barV = document.createElement("div");
    barV.className = "chart-bar-vert bar-valid";
    barV.style.height = `${clamp(validH,0,190)}px`;

    const barB = document.createElement("div");
    barB.className = "chart-bar-vert bar-buffer";
    barB.style.height = `${clamp(bufferH,0,190)}px`;

    bars.appendChild(barV);
    bars.appendChild(barB);

    const values = document.createElement("div");
    values.className = "chart-col-values";
    values.innerHTML = `<div>${o.valid}</div><div style="color:var(--orange);font-weight:900">${o.buffer}</div>`;

    const label = document.createElement("div");
    label.className = "chart-col-label";
    label.textContent = m.label.slice(0,3);

    col.appendChild(bars);
    col.appendChild(values);
    col.appendChild(label);
    body.appendChild(col);
  });

  $("chart-summary-text").textContent =
    skipped>0
      ? `Catatan: ${skipped} baris dilewati karena PERIODE PELAMAR tidak terbaca bulan-nya.`
      : `Periode terbaca dengan baik untuk seluruh data yang relevan.`;
}

/* Master update ACM */
function updateACMAll(){
  const filtered = getFilteredACMRows();
  updateSummary(filtered);
  updateMonthlyChart(filtered);

  buildProvTable(filtered);
  buildMetodeTable(filtered);
  buildMediaSosialTable(filtered);
  buildEduTable(filtered);
  buildPortalTable(filtered);
  buildOfflineTable(filtered);

  // Update SA insight too
  updateSourcingAnalystAnalysis();
}

/* =========================================================
   SOURCING ANALYST (insight sederhana tapi berguna)
========================================================= */
function initSourcingAnalystFilters(){
  const provVals = uniqueSorted(Array.from(provKotaMap.keys()));
  const allParents = uniqueSorted(Array.from(jobParentTypeMap.keys()));

  saProvMS = createMultiSelect("sa-ms-prov", provVals, "Semua Provinsi", false, (sel)=>{
    updateSaKotaOptions(sel);
    updateSaJobParentOptions();
    updateSourcingAnalystAnalysis();
  });

  saKotaMS = createMultiSelect("sa-ms-kota", [], "Semua Kota", true, ()=>{
    updateSaJobParentOptions();
    updateSourcingAnalystAnalysis();
  });

  saJobParentMS = createMultiSelect("sa-ms-job-parent", allParents, "Semua Job Parent", false, ()=>{
    updateSaJobTypeOptions();
    updateSourcingAnalystAnalysis();
  });

  saJobTypeMS = createMultiSelect("sa-ms-job-type", [], "Semua Job Type", true, ()=>{
    updateSourcingAnalystAnalysis();
  });

  updateSaJobParentOptions();
}

function updateSaKotaOptions(selProv){
  if(!saKotaMS) return;
  if(!selProv || !selProv.length){
    saKotaMS.setOptions([]);
    saKotaMS.setDisabled(true);
    return;
  }
  const set = new Set();
  selProv.forEach(p=>{
    const s = provKotaMap.get(p);
    if(s) s.forEach(v=>set.add(v));
  });
  saKotaMS.setOptions(uniqueSorted(Array.from(set)));
  saKotaMS.setDisabled(false);
}

function getSourcingAnalystFilteredRows(){
  const provSel = new Set(saProvMS ? saProvMS.getSelected() : []);
  const kotaSel = new Set(saKotaMS ? saKotaMS.getSelected() : []);
  const jpSel   = new Set(saJobParentMS ? saJobParentMS.getSelected() : []);
  const jtSel   = new Set(saJobTypeMS ? saJobTypeMS.getSelected() : []);

  return acmRows.filter(r=>{
    const p = trimStr(r[COL_PROV]);
    const k = trimStr(r[COL_KOTA]);
    const jp= trimStr(r[COL_JOB_PARENT]);
    const jt= trimStr(r[COL_JOB_TYPE]);
    if(provSel.size && !provSel.has(p)) return false;
    if(kotaSel.size && !kotaSel.has(k)) return false;
    if(jpSel.size && !jpSel.has(jp)) return false;
    if(jtSel.size && !jtSel.has(jt)) return false;
    return true;
  });
}

function updateSaJobParentOptions(){
  if(!saJobParentMS) return;
  const provSel = saProvMS ? saProvMS.getSelected() : [];
  const kotaSel = saKotaMS ? saKotaMS.getSelected() : [];

  const set = new Set();
  acmRows.forEach(r=>{
    const p = trimStr(r[COL_PROV]);
    const k = trimStr(r[COL_KOTA]);
    if(provSel.length && !provSel.includes(p)) return;
    if(kotaSel.length && !kotaSel.includes(k)) return;
    const jp = trimStr(r[COL_JOB_PARENT]);
    if(jp) set.add(jp);
  });

  const list = uniqueSorted(Array.from(set));
  saJobParentMS.setOptions(list);
  saJobParentMS.setDisabled(list.length===0);

  if(saJobTypeMS){
    saJobTypeMS.setOptions([]);
    saJobTypeMS.setDisabled(true);
  }
}

function updateSaJobTypeOptions(){
  if(!saJobTypeMS) return;
  const rows = getSourcingAnalystFilteredRows();
  const parentSel = saJobParentMS ? saJobParentMS.getSelected() : [];
  if(!parentSel.length){
    saJobTypeMS.setOptions([]);
    saJobTypeMS.setDisabled(true);
    return;
  }
  const set = new Set();
  rows.forEach(r=>{
    const jt = trimStr(r[COL_JOB_TYPE]);
    if(jt) set.add(jt);
  });
  const list = uniqueSorted(Array.from(set));
  saJobTypeMS.setOptions(list);
  saJobTypeMS.setDisabled(list.length===0);
}

function clearSaFilters(){
  saProvMS && saProvMS.clear();
  if(saKotaMS){ saKotaMS.setOptions([]); saKotaMS.setDisabled(true); }
  saJobParentMS && saJobParentMS.clear();
  if(saJobTypeMS){ saJobTypeMS.setOptions([]); saJobTypeMS.setDisabled(true); }
  updateSaJobParentOptions();
  updateSourcingAnalystAnalysis();
}

function topNFromMap(map, n){
  const arr = Array.from(map.entries())
    .map(([k,v])=>({k, v}))
    .sort((a,b)=>b.v-a.v);
  return arr.slice(0,n);
}

function updateSourcingAnalystAnalysis(){
  const rows = getSourcingAnalystFilteredRows();
  const base = $("sa-analysis-text");
  if(!rows.length){
    base.innerHTML = `<div class="analysis-text">Tidak ada data untuk kombinasi filter tersebut.</div>`;
    return;
  }

  // Top MEDIA SOURCING by Valid
  const mediaMap = new Map();
  const metodeMap = new Map();
  const msosMap = new Map();
  const portalMap = new Map();
  const offMap = new Map();

  rows.forEach(r=>{
    const v = getValidFlag(r);
    if(!v) return;

    const media = trimStr(r[COL_MEDIA]) || "(Kosong)";
    mediaMap.set(media, (mediaMap.get(media)||0)+v);

    const metode = trimStr(r[COL_METODE]) || "(Kosong)";
    metodeMap.set(metode, (metodeMap.get(metode)||0)+v);

    const m = norm(r[COL_MEDIA]);
    if(m===norm("ONLINE - MEDIA SOSIAL")){
      msosMap.set(metode, (msosMap.get(metode)||0)+v);
    }else if(m===norm("ONLINE - JOB PORTAL")){
      portalMap.set(metode, (portalMap.get(metode)||0)+v);
    }else if(m===norm("OFFLINE")){
      offMap.set(metode, (offMap.get(metode)||0)+v);
    }
  });

  const topMedia = topNFromMap(mediaMap, 3);
  const topMetode = topNFromMap(metodeMap, 3);
  const topSos = topNFromMap(msosMap, 3);
  const topPortal = topNFromMap(portalMap, 3);
  const topOff = topNFromMap(offMap, 3);

  const totalValid = rows.reduce((acc,r)=>acc+getValidFlag(r),0);
  const totalBuf = rows.reduce((acc,r)=>acc+getBufferFlag(r),0);

  base.innerHTML = `
    <div class="analysis-text">
      <div class="analysis-section">
        <div class="analysis-icon">📌</div>
        <div>
          <div class="analysis-title">Ringkasan</div>
          <div class="analysis-summary">Applicant Valid: <strong>${numberFmt.format(totalValid)}</strong> · Buffer: <strong>${numberFmt.format(totalBuf)}</strong> (berdasarkan filter SA)</div>
        </div>
      </div>

      <div class="analysis-section">
        <div class="analysis-icon">🚀</div>
        <div>
          <div class="analysis-title">Top Metode Utama (MEDIA SOURCING) berdasarkan Applicant Valid</div>
          <div class="analysis-summary">
            ${topMedia.map((x,i)=>`${i+1}. <strong>${x.k}</strong> (${numberFmt.format(x.v)})`).join("<br/>")}
          </div>
        </div>
      </div>

      <div class="analysis-section">
        <div class="analysis-icon">🎯</div>
        <div>
          <div class="analysis-title">Top Channel (METODE SOURCING) berdasarkan Applicant Valid</div>
          <div class="analysis-summary">
            ${topMetode.map((x,i)=>`${i+1}. <strong>${x.k}</strong> (${numberFmt.format(x.v)})`).join("<br/>")}
          </div>
        </div>
      </div>

      <div class="analysis-section">
        <div class="analysis-icon">📣</div>
        <div>
          <div class="analysis-title">Rekomendasi Fokus Per Metode</div>
          <div class="analysis-summary">
            <strong>Media Sosial:</strong><br/>
            ${topSos.length ? topSos.map((x,i)=>`${i+1}. ${x.k} (${numberFmt.format(x.v)})`).join("<br/>") : "-"}<br/><br/>
            <strong>Job Portal:</strong><br/>
            ${topPortal.length ? topPortal.map((x,i)=>`${i+1}. ${x.k} (${numberFmt.format(x.v)})`).join("<br/>") : "-"}<br/><br/>
            <strong>Offline:</strong><br/>
            ${topOff.length ? topOff.map((x,i)=>`${i+1}. ${x.k} (${numberFmt.format(x.v)})`).join("<br/>") : "-"}
          </div>
          <div class="analysis-detail">Tips: prioritasin 1–2 channel teratas untuk scale sourcing, lalu optimasi conversion Qualified.</div>
        </div>
      </div>
    </div>
  `;
}

/* =========================================================
   PERFORMANCE: generic matrix builder (flexible headers)
========================================================= */
function renderMatrixHead(theadEl, leftTitle){
  const tr = document.createElement("tr");
  const th0 = document.createElement("th");
  th0.textContent = leftTitle;
  tr.appendChild(th0);
  MONTHS.forEach(m=>{
    const th = document.createElement("th");
    th.textContent = m.label;
    tr.appendChild(th);
  });
  theadEl.innerHTML = "";
  theadEl.appendChild(tr);
}

function detectMonthCols(fields, metricToken){
  // find 12 columns matching month token & metric token (submit/qualified)
  const cols = [];
  const fNorm = fields.map(f=>({f, n:norm(f)}));

  for(const m of MONTHS){
    const found = fNorm.find(x=>{
      const okMetric = metricToken ? x.n.includes(norm(metricToken)) : true;
      const okMonth = m.tokens.some(t=>x.n.includes(t));
      return okMetric && okMonth;
    });
    cols.push(found ? found.f : null);
  }

  const okCount = cols.filter(Boolean).length;
  return { cols, okCount };
}

function fallbackMonthColsByIndex(fields, startIndex){
  const cols = [];
  for(let i=0;i<12;i++){
    cols.push(fields[startIndex+i] || null);
  }
  return cols;
}

function buildMatrixRows(rows, rowKeyField, monthCols){
  // monthCols: array length 12 of field names
  const map = new Map(); // key -> {idx -> formatted}
  rows.forEach(r=>{
    const k = trimStr(r[rowKeyField]) || "(Kosong)";
    if(!map.has(k)) map.set(k, {});
    const obj = map.get(k);
    MONTHS.forEach((m,i)=>{
      const col = monthCols[i];
      if(!col) return;
      obj[m.idx] = fmtPercent(r[col]);
    });
  });
  return map;
}

function buildAvgMatrixForGroup(rows, groupKeyField, monthCols){
  // average percentage per month for group
  const result = new Map(); // group -> {idx -> fmt}
  const tmp = new Map(); // group -> {idx -> {sum,count}}
  rows.forEach(r=>{
    const g = trimStr(r[groupKeyField]) || "(Kosong)";
    if(!tmp.has(g)) tmp.set(g, {});
    const grp = tmp.get(g);
    MONTHS.forEach((m,i)=>{
      const col = monthCols[i];
      if(!col) return;
      const val = toFloat(r[col]);
      if(val==null) return;
      const pct = (val>0 && val<=1) ? (val*100) : val;
      if(!grp[m.idx]) grp[m.idx] = {sum:0,count:0};
      grp[m.idx].sum += pct;
      grp[m.idx].count += 1;
    });
  });

  for(const [g,obj] of tmp.entries()){
    const out = {};
    MONTHS.forEach(m=>{
      const s = obj[m.idx];
      if(!s || !s.count) out[m.idx] = "-";
      else out[m.idx] = `${percentFmt2.format(s.sum/s.count)}%`;
    });
    result.set(g, out);
  }
  return result;
}

function renderMatrixBody(tbodyEl, rowKeys, valueMap){
  tbodyEl.innerHTML = "";
  rowKeys.forEach(k=>{
    const tr = document.createElement("tr");
    const td0 = document.createElement("td");
    td0.textContent = k;
    td0.className = "col-label";
    tr.appendChild(td0);

    MONTHS.forEach(m=>{
      const td = document.createElement("td");
      td.className = "col-number";
      const v = valueMap.get(k)?.[m.idx] ?? "-";
      td.textContent = v;
      tr.appendChild(td);
    });

    tbodyEl.appendChild(tr);
  });
}

/* =========================================================
   PERFORMANCE CLIENT
========================================================= */
let perfClient = { rows:[], fields:[], industryField:null, clientField:null, submitCols:[], qualCols:[] };

function detectClientFields(fields){
  const industry = findField(fields, ["INDUSTRY"]);
  const client = findField(fields, ["CLIENT"]);
  return {industry, client};
}

function initPerformanceClient(){
  $("pc-error-state").style.display = "none";
  $("pc-load-state").style.display = "flex";
  $("pc-status-text").textContent = "Memuat data...";
  $("pc-col-note").textContent = "";

  loadCsv(CSV_URL_CLIENT).then(({rows,fields})=>{
    perfClient.rows = rows;
    perfClient.fields = fields;

    const {industry, client} = detectClientFields(fields);
    perfClient.industryField = industry || fields[0] || null;
    perfClient.clientField = client || fields[1] || null;

    // detect month cols
    const submitDetect = detectMonthCols(fields, "SUBMIT");
    const qualDetect = detectMonthCols(fields, "QUALIFIED");
    if(submitDetect.okCount >= 6) perfClient.submitCols = submitDetect.cols;
    else perfClient.submitCols = fallbackMonthColsByIndex(fields, 2);

    if(qualDetect.okCount >= 6) perfClient.qualCols = qualDetect.cols;
    else perfClient.qualCols = fallbackMonthColsByIndex(fields, 14);

    renderMatrixHead($("pc-submit-head"), "Client");
    renderMatrixHead($("pc-qual-head"), "Client");

    // populate industry dropdown
    const industryVals = uniqueSorted(rows.map(r=>r[perfClient.industryField]));
    const sel = $("pc-industry");
    sel.innerHTML = `<option value="">Pilih Industry...</option>` + industryVals.map(v=>`<option value="${String(v).replaceAll('"','&quot;')}">${v}</option>`).join("");

    $("pc-load-state").style.display = "none";
    $("pc-status-text").textContent = `Data siap. Kolom: Industry="${perfClient.industryField}", Client="${perfClient.clientField}".`;
    $("pc-col-note").textContent = "Jika header bulan tidak terbaca, sistem otomatis pakai urutan kolom setelah ID.";

    $("pc-submit-empty").style.display = "block";
    $("pc-qual-empty").style.display = "block";
  }).catch(err=>{
    console.error(err);
    $("pc-load-state").style.display = "none";
    $("pc-error-state").style.display = "block";
    $("pc-error-state").textContent = "Gagal memuat Performance Client: " + (err.message || err);
  });
}

function updatePerformanceClientView(){
  const ind = $("pc-industry").value;
  const emptySubmit = $("pc-submit-empty");
  const emptyQual = $("pc-qual-empty");

  if(!ind){
    $("pc-submit-body").innerHTML = "";
    $("pc-qual-body").innerHTML = "";
    emptySubmit.style.display = "block";
    emptyQual.style.display = "block";
    $("pc-status-text").textContent = "Pilih Industry untuk menampilkan data.";
    return;
  }

  const rows = perfClient.rows.filter(r=>trimStr(r[perfClient.industryField])===ind);
  const clients = uniqueSorted(rows.map(r=>r[perfClient.clientField]));
  const submitMap = buildMatrixRows(rows, perfClient.clientField, perfClient.submitCols);
  const qualMap = buildMatrixRows(rows, perfClient.clientField, perfClient.qualCols);

  renderMatrixBody($("pc-submit-body"), clients, submitMap);
  renderMatrixBody($("pc-qual-body"), clients, qualMap);

  emptySubmit.style.display = clients.length ? "none" : "block";
  emptyQual.style.display = clients.length ? "none" : "block";
  $("pc-status-text").textContent = `Industry "${ind}" · ${clients.length} client.`;
}

function clearPC(){
  $("pc-industry").value = "";
  updatePerformanceClientView();
}

/* =========================================================
   PERFORMANCE AREA
========================================================= */
let perfArea = { rows:[], fields:[], groupField:null, areaField:null, submitCols:[], qualCols:[] };

function detectAreaFields(fields){
  const group = findField(fields, ["GROUP CLIENT","GROUP"]);
  const area = findField(fields, ["AREA"]);
  return {group, area};
}

function initPerformanceArea(){
  $("pa-error-state").style.display = "none";
  $("pa-load-state").style.display = "flex";
  $("pa-status-text").textContent = "Memuat data...";
  $("pa-col-note").textContent = "";

  loadCsv(CSV_URL_AREA).then(({rows,fields})=>{
    perfArea.rows = rows;
    perfArea.fields = fields;

    const {group, area} = detectAreaFields(fields);
    perfArea.groupField = group || fields[0] || null;
    perfArea.areaField = area || fields[1] || null;

    const submitDetect = detectMonthCols(fields, "SUBMIT");
    const qualDetect = detectMonthCols(fields, "QUALIFIED");
    perfArea.submitCols = (submitDetect.okCount>=6) ? submitDetect.cols : fallbackMonthColsByIndex(fields, 2);
    perfArea.qualCols   = (qualDetect.okCount>=6)   ? qualDetect.cols   : fallbackMonthColsByIndex(fields, 14);

    renderMatrixHead($("pa-submit-head"), "Area");
    renderMatrixHead($("pa-qual-head"), "Area");

    const groupVals = uniqueSorted(rows.map(r=>r[perfArea.groupField]));
    const selG = $("pa-group");
    selG.innerHTML = `<option value="">Pilih Group Client...</option>` + groupVals.map(v=>`<option value="${String(v).replaceAll('"','&quot;')}">${v}</option>`).join("");

    $("pa-area").innerHTML = `<option value="">Semua Area</option>`;
    $("pa-area").disabled = true;

    $("pa-load-state").style.display = "none";
    $("pa-status-text").textContent = `Data siap. Kolom: Group="${perfArea.groupField}", Area="${perfArea.areaField}".`;
    $("pa-col-note").textContent = "Area list akan muncul setelah Group Client dipilih.";

    $("pa-submit-empty").style.display = "block";
    $("pa-qual-empty").style.display = "block";
  }).catch(err=>{
    console.error(err);
    $("pa-load-state").style.display = "none";
    $("pa-error-state").style.display = "block";
    $("pa-error-state").textContent = "Gagal memuat Performance Area: " + (err.message || err);
  });
}

function updateAreaDropdown(){
  const g = $("pa-group").value;
  const selA = $("pa-area");
  if(!g){
    selA.innerHTML = `<option value="">Semua Area</option>`;
    selA.disabled = true;
    return;
  }
  const rows = perfArea.rows.filter(r=>trimStr(r[perfArea.groupField])===g);
  const areas = uniqueSorted(rows.map(r=>r[perfArea.areaField]));
  selA.innerHTML = `<option value="">Semua Area</option>` + areas.map(v=>`<option value="${String(v).replaceAll('"','&quot;')}">${v}</option>`).join("");
  selA.disabled = false;
}

function updatePerformanceAreaView(){
  const g = $("pa-group").value;
  const a = $("pa-area").value;

  if(!g){
    $("pa-submit-body").innerHTML = "";
    $("pa-qual-body").innerHTML = "";
    $("pa-submit-empty").style.display = "block";
    $("pa-qual-empty").style.display = "block";
    $("pa-status-text").textContent = "Pilih Group Client untuk menampilkan data.";
    return;
  }

  let rows = perfArea.rows.filter(r=>trimStr(r[perfArea.groupField])===g);
  if(a){
    rows = rows.filter(r=>trimStr(r[perfArea.areaField])===a);
  }

  const areas = uniqueSorted(rows.map(r=>r[perfArea.areaField]));
  const submitMap = buildMatrixRows(rows, perfArea.areaField, perfArea.submitCols);
  const qualMap = buildMatrixRows(rows, perfArea.areaField, perfArea.qualCols);

  renderMatrixBody($("pa-submit-body"), areas, submitMap);
  renderMatrixBody($("pa-qual-body"), areas, qualMap);

  $("pa-submit-empty").style.display = areas.length ? "none" : "block";
  $("pa-qual-empty").style.display = areas.length ? "none" : "block";
  $("pa-status-text").textContent = `Group "${g}"` + (a ? ` · Area "${a}"` : ` · ${areas.length} area`);
}

function clearPA(){
  $("pa-group").value = "";
  $("pa-area").value = "";
  $("pa-area").innerHTML = `<option value="">Semua Area</option>`;
  $("pa-area").disabled = true;
  updatePerformanceAreaView();
}

/* =========================================================
   PERFORMANCE JOBTYPE (✅ Job Type = kolom A, Job Parent = kolom B)
========================================================= */
let perfJob = {
  rows:[], fields:[],
  jobTypeField:null,
  jobParentField:null,
  areaField:null,
  submitCols:[], qualCols:[],
  areaOptions:[]
};

function initPerformanceJobtype(){
  $("pj-error-state").style.display = "none";
  $("pj-load-state").style.display = "flex";
  $("pj-status-text").textContent = "Memuat data...";
  $("pj-col-note").textContent = "";

  loadCsv(CSV_URL_JOBTYPE).then(({rows,fields})=>{
    perfJob.rows = rows;
    perfJob.fields = fields;

    // ✅ Hard rule: kolom A & B by position, not by header name
    perfJob.jobTypeField = fields[0] || null;   // A
    perfJob.jobParentField = fields[1] || null; // B

    // optional area column if exists by header
    perfJob.areaField = findField(fields, ["AREA"]);

    const submitDetect = detectMonthCols(fields, "SUBMIT");
    const qualDetect = detectMonthCols(fields, "QUALIFIED");

    perfJob.submitCols = (submitDetect.okCount>=6) ? submitDetect.cols : fallbackMonthColsByIndex(fields, 2);
    perfJob.qualCols   = (qualDetect.okCount>=6)   ? qualDetect.cols   : fallbackMonthColsByIndex(fields, 14);

    renderMatrixHead($("pj-parent-submit-head"), "Job Parent");
    renderMatrixHead($("pj-submit-head"), "Job Type");
    renderMatrixHead($("pj-qual-head"), "Job Type");

    // Parent dropdown
    const parents = uniqueSorted(rows.map(r=>r[perfJob.jobParentField]));
    const selP = $("pj-parent");
    selP.innerHTML = `<option value="">Pilih Job Parent...</option>` + parents.map(v=>`<option value="${String(v).replaceAll('"','&quot;')}">${v}</option>`).join("");

    // Type dropdown initial
    const selT = $("pj-type");
    selT.innerHTML = `<option value="">Pilih Job Type...</option>`;
    selT.disabled = true;

    // Area dropdown from perfArea rows (if already loaded), else from perfArea later
    refreshPJAreaOptions();

    $("pj-load-state").style.display = "none";
    $("pj-status-text").textContent = `Data siap. JobType(A)="${perfJob.jobTypeField}", JobParent(B)="${perfJob.jobParentField}".`;
    $("pj-col-note").textContent = perfJob.areaField ? `Kolom Area terdeteksi: "${perfJob.areaField}" (Area bisa memfilter).` : "Kolom Area tidak terdeteksi (dropdown Area hanya label).";

    $("pj-parent-empty").style.display = "block";
    $("pj-submit-empty").style.display = "block";
    $("pj-qual-empty").style.display = "block";
  }).catch(err=>{
    console.error(err);
    $("pj-load-state").style.display = "none";
    $("pj-error-state").style.display = "block";
    $("pj-error-state").textContent = "Gagal memuat Performance Jobtype: " + (err.message || err);
  });
}

function refreshPJAreaOptions(){
  // Prefer from Performance Area data if available
  let areas = [];
  if(perfArea.rows && perfArea.rows.length && perfArea.areaField){
    areas = uniqueSorted(perfArea.rows.map(r=>r[perfArea.areaField]));
  }
  perfJob.areaOptions = areas;

  const selA = $("pj-area");
  selA.innerHTML = `<option value="">Semua Area</option>` + areas.map(v=>`<option value="${String(v).replaceAll('"','&quot;')}">${v}</option>`).join("");
}

function updatePJTypeOptions(){
  const parent = $("pj-parent").value;
  const selT = $("pj-type");
  if(!parent){
    selT.innerHTML = `<option value="">Pilih Job Type...</option>`;
    selT.disabled = true;
    return;
  }

  let rows = perfJob.rows.filter(r=>trimStr(r[perfJob.jobParentField])===parent);

  // optional: filter by area if exists in jobtype dataset
  const area = $("pj-area").value;
  if(area && perfJob.areaField){
    rows = rows.filter(r=>trimStr(r[perfJob.areaField])===area);
  }

  const types = uniqueSorted(rows.map(r=>r[perfJob.jobTypeField]));
  selT.innerHTML = `<option value="">Semua Job Type (di parent ini)</option>` + types.map(v=>`<option value="${String(v).replaceAll('"','&quot;')}">${v}</option>`).join("");
  selT.disabled = false;
}

function updatePerformanceJobtypeView(){
  const area = $("pj-area").value;
  const parent = $("pj-parent").value;
  const type = $("pj-type").value;

  if(!parent){
    $("pj-parent-submit-body").innerHTML = "";
    $("pj-submit-body").innerHTML = "";
    $("pj-qual-body").innerHTML = "";
    $("pj-parent-empty").style.display = "block";
    $("pj-submit-empty").style.display = "block";
    $("pj-qual-empty").style.display = "block";
    $("pj-status-text").textContent = "Pilih Job Parent untuk menampilkan data.";
    return;
  }

  // Filter base rows
  let rows = perfJob.rows.filter(r=>trimStr(r[perfJob.jobParentField])===parent);
  if(area && perfJob.areaField){
    rows = rows.filter(r=>trimStr(r[perfJob.areaField])===area);
  }

  // Parent aggregate (average of job types under parent)
  const parentAvgSubmit = buildAvgMatrixForGroup(rows, perfJob.jobParentField, perfJob.submitCols);
  renderMatrixBody($("pj-parent-submit-body"), [parent], parentAvgSubmit);
  $("pj-parent-empty").style.display = "none";

  // Job type matrices
  let rowsType = rows;
  if(type){
    rowsType = rowsType.filter(r=>trimStr(r[perfJob.jobTypeField])===type);
  }

  const types = uniqueSorted(rowsType.map(r=>r[perfJob.jobTypeField]));
  const submitMap = buildMatrixRows(rowsType, perfJob.jobTypeField, perfJob.submitCols);
  const qualMap = buildMatrixRows(rowsType, perfJob.jobTypeField, perfJob.qualCols);

  renderMatrixBody($("pj-submit-body"), types, submitMap);
  renderMatrixBody($("pj-qual-body"), types, qualMap);

  $("pj-submit-empty").style.display = types.length ? "none" : "block";
  $("pj-qual-empty").style.display = types.length ? "none" : "block";

  $("pj-status-text").textContent =
    `Parent "${parent}"` +
    (area ? ` · Area "${area}"` : "") +
    (type ? ` · Type "${type}"` : ` · ${types.length} job type`);
}

function clearPJ(){
  $("pj-area").value = "";
  $("pj-parent").value = "";
  $("pj-type").value = "";
  $("pj-type").innerHTML = `<option value="">Pilih Job Type...</option>`;
  $("pj-type").disabled = true;
  updatePerformanceJobtypeView();
}

/* =========================================================
   TAB NAVIGATION
========================================================= */
function setActiveTab(tabId){
  const tabs = ["acm","sa","pc","pa","pj"];
  tabs.forEach(t=>{
    $("tab-"+t).classList.toggle("active", t===tabId);
    $("page-"+t).classList.toggle("active", t===tabId);
  });
}

/* =========================================================
   LOAD ALL
========================================================= */
function setPill(text){ $("pill-status").textContent = text; }

async function loadAll(){
  try{
    setPill("Loading...");
    $("acm-error-state").style.display = "none";
    $("acm-load-state").style.display = "flex";

    const acm = await loadCsv(CSV_URL_ACM);
    acmRows = acm.rows;
    acmFields = acm.fields;

    detectACMColumns(acmFields);

    $("acm-load-state").style.display = "none";
    if(!acmRows.length){
      $("acm-error-state").style.display = "block";
      $("acm-error-state").textContent = "Data ACM kosong atau header tidak sesuai.";
      setPill("ACM empty");
      return;
    }

    initACMFilters();
    initSourcingAnalystFilters();
    updateACMAll();

    setPill("Loaded");

    // Performance loads (non-blocking sequence)
    initPerformanceClient();
    initPerformanceArea();
    initPerformanceJobtype();
  }catch(err){
    console.error(err);
    $("acm-load-state").style.display = "none";
    $("acm-error-state").style.display = "block";
    $("acm-error-state").textContent =
      "Terjadi kesalahan saat memuat ACM: " + (err.message || err) +
      ". Pastikan link CSV bisa dibuka tanpa login (Anyone with link - Viewer).";
    setPill("Error");
  }
}

document.addEventListener("DOMContentLoaded", ()=>{
  // Tab handlers
  $("tab-acm").addEventListener("click", ()=>setActiveTab("acm"));
  $("tab-sa").addEventListener("click", ()=>setActiveTab("sa"));
  $("tab-pc").addEventListener("click", ()=>setActiveTab("pc"));
  $("tab-pa").addEventListener("click", ()=>setActiveTab("pa"));
  $("tab-pj").addEventListener("click", ()=>setActiveTab("pj"));

  // Filter card toggles
  $("acm-filter-toggle-btn").addEventListener("click", ()=> $("acm-filter-card").classList.toggle("open"));
  $("sa-filter-toggle-btn").addEventListener("click", ()=> $("sa-filter-card").classList.toggle("open"));
  $("pc-filter-toggle-btn").addEventListener("click", ()=> $("pc-filter-card").classList.toggle("open"));
  $("pa-filter-toggle-btn").addEventListener("click", ()=> $("pa-filter-card").classList.toggle("open"));
  $("pj-filter-toggle-btn").addEventListener("click", ()=> $("pj-filter-card").classList.toggle("open"));

  // Clear buttons
  $("clear-filters-btn").addEventListener("click", clearACMFilters);
  $("sa-clear-filters-btn").addEventListener("click", clearSaFilters);
  $("pc-clear-btn").addEventListener("click", clearPC);
  $("pa-clear-btn").addEventListener("click", clearPA);
  $("pj-clear-btn").addEventListener("click", clearPJ);

  // Perf events
  $("pc-industry").addEventListener("change", updatePerformanceClientView);

  $("pa-group").addEventListener("change", ()=>{
    updateAreaDropdown();
    updatePerformanceAreaView();
    // refresh jobtype area options too (if jobtype already loaded)
    refreshPJAreaOptions();
  });
  $("pa-area").addEventListener("change", updatePerformanceAreaView);

  $("pj-area").addEventListener("change", ()=>{
    updatePJTypeOptions();
    updatePerformanceJobtypeView();
  });
  $("pj-parent").addEventListener("change", ()=>{
    updatePJTypeOptions();
    updatePerformanceJobtypeView();
  });
  $("pj-type").addEventListener("change", updatePerformanceJobtypeView);

  loadAll();
});
</script>
</body>
</html>
