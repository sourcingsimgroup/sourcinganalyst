<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ACM Dashboard • Applicant Valid vs Buffer</title>
  <meta name="description" content="ACM Dashboard: Filter multi-select (Provinsi/Kota/Area/Periode/Job Parent/Job Type) + Trend Applicant Valid vs Buffer per bulan + Sourcing Analyst insights. Data source: CSV Google Sheets." />

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --brand:#1d4ed8;
      --brand-2:#2563eb;
      --ok:#059669;
      --warn:#f97316;
      --line:#e5e7eb;
      --shadow: 0 12px 36px rgba(2, 6, 23, .10);
      --shadow-soft: 0 10px 26px rgba(2, 6, 23, .08);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(37,99,235,.18), transparent 60%),
        radial-gradient(900px 500px at 95% 10%, rgba(5,150,105,.14), transparent 55%),
        radial-gradient(900px 500px at 70% 105%, rgba(249,115,22,.10), transparent 55%),
        var(--bg);
    }

    /* Topbar (sticky + expensive blur) */
    .topbar{
      position:sticky; top:0; z-index:50;
      border-bottom:1px solid rgba(229,231,235,.7);
      background: rgba(255,255,255,.66);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .topbar::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(to bottom, rgba(255,255,255,.65), rgba(255,255,255,.40));
      pointer-events:none;
    }
    .topbar-inner{
      position:relative;
      max-width:1200px;
      margin:0 auto;
      padding:14px 16px;
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
    }
    .brand{
      display:flex; gap:10px; align-items:center;
      min-width:220px;
    }
    .logo{
      width:38px; height:38px; border-radius:12px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.9), rgba(255,255,255,.5) 30%, rgba(37,99,235,.18) 65%, rgba(29,78,216,.25));
      border:1px solid rgba(29,78,216,.22);
      box-shadow: 0 10px 26px rgba(29,78,216,.15);
      display:grid; place-items:center;
    }
    .logo svg{opacity:.9}
    .brand h1{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
      line-height:1.1;
    }
    .brand p{
      margin:2px 0 0 0;
      font-size:11px;
      color:var(--muted);
    }
    .nav{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .tab{
      border:1px solid rgba(229,231,235,.9);
      background: rgba(255,255,255,.72);
      border-radius:999px;
      padding:9px 12px;
      font-size:12px;
      color:var(--muted);
      cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      user-select:none;
    }
    .tab:hover{transform:translateY(-1px); box-shadow: var(--shadow-soft); border-color: rgba(37,99,235,.25)}
    .tab.active{
      color:var(--ink);
      border-color: rgba(29,78,216,.35);
      box-shadow: 0 12px 34px rgba(29,78,216,.12);
      background: rgba(255,255,255,.86);
    }

    /* Layout */
    .wrap{max-width:1200px; margin:18px auto 70px; padding:0 16px;}
    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .brand{min-width:auto}
    }

    /* Card */
    .card{
      background: rgba(255,255,255,.88);
      border:1px solid rgba(229,231,235,.9);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-hd{
      padding:14px 14px 0 14px;
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:10px;
    }
    .card-title{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
    }
    .card-sub{
      margin:6px 0 0 0;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }
    .card-bd{padding:14px}

    /* Filters */
    .filters{
      display:grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 1100px){
      .filters{grid-template-columns: repeat(3, minmax(0, 1fr));}
    }
    @media (max-width: 640px){
      .filters{grid-template-columns: repeat(2, minmax(0, 1fr));}
    }
    .filter-group{min-width:0}
    .filter-label{
      display:block;
      font-size:11px;
      color:var(--muted);
      margin:0 0 6px 2px;
    }

    /* Multi-select component */
    .ms{position:relative; min-width:0}
    .ms-toggle{
      width:100%;
      display:flex;
      align-items:center;
      gap:8px;
      justify-content:space-between;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(229,231,235,.95);
      background: rgba(255,255,255,.85);
      cursor:pointer;
      box-shadow: 0 8px 18px rgba(2,6,23,.06);
      transition:border-color .12s ease, transform .12s ease, box-shadow .12s ease;
      text-align:left;
    }
    .ms-toggle:hover{transform:translateY(-1px); border-color: rgba(37,99,235,.25); box-shadow: 0 12px 26px rgba(2,6,23,.08)}
    .ms-placeholder{
      font-size:12px;
      color:var(--ink);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      min-width:0;
      flex:1;
    }
    .ms-counter{
      font-size:11px;
      color:var(--muted);
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(229,231,235,.95);
      background: rgba(245,247,251,.9);
      display:none;
      flex:0 0 auto;
    }
    .ms-arrow{color:var(--muted); font-size:12px}
    .ms-panel{
      position:absolute;
      top: calc(100% + 8px);
      left:0; right:0;
      z-index:30;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(229,231,235,.95);
      border-radius:16px;
      box-shadow: var(--shadow);
      padding:10px;
      display:none;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .ms.open .ms-panel{display:block}
    .ms-search{
      width:100%;
      border-radius:12px;
      padding:10px 10px;
      border:1px solid rgba(229,231,235,.95);
      outline:none;
      font-size:12px;
      margin-bottom:8px;
      background: rgba(255,255,255,.9);
    }
    .ms-options{
      max-height:240px;
      overflow:auto;
      padding-right:2px;
    }
    .ms-opt{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 8px;
      border-radius:12px;
      cursor:pointer;
      transition: background .12s ease;
      user-select:none;
    }
    .ms-opt:hover{background: rgba(37,99,235,.08)}
    .ms-opt input{accent-color: var(--brand); cursor:pointer}
    .ms-opt span{
      font-size:12px;
      color:var(--ink);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .ms-empty{
      display:none;
      font-size:12px;
      color:var(--muted);
      padding:8px;
    }
    .ms-actions{
      display:flex; gap:8px; justify-content:space-between;
      padding-top:8px; margin-top:8px;
      border-top:1px solid rgba(229,231,235,.9);
    }
    .btn{
      border:1px solid rgba(229,231,235,.95);
      background: rgba(255,255,255,.86);
      border-radius:12px;
      padding:9px 10px;
      font-size:12px;
      cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      color:var(--ink);
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px); box-shadow: var(--shadow-soft); border-color: rgba(37,99,235,.25)}
    .btn.primary{
      border-color: rgba(29,78,216,.25);
      background: rgba(29,78,216,.08);
      color: var(--ink);
    }

    /* KPI */
    .kpis{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 640px){
      .kpis{grid-template-columns:1fr}
    }
    .kpi{
      border:1px solid rgba(229,231,235,.9);
      background: rgba(255,255,255,.88);
      border-radius:16px;
      padding:12px;
      box-shadow: 0 10px 22px rgba(2,6,23,.06);
    }
    .kpi .label{font-size:11px; color:var(--muted)}
    .kpi .val{font-size:22px; font-weight:700; margin-top:6px}
    .kpi .hint{font-size:11px; color:var(--muted); margin-top:4px; line-height:1.3}
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:5px 9px;
      border-radius:999px;
      border:1px solid rgba(229,231,235,.95);
      background: rgba(245,247,251,.9);
      font-size:11px;
      color:var(--muted);
    }

    /* Chart */
    .chart-wrap{
      border:1px solid rgba(229,231,235,.9);
      background: rgba(255,255,255,.86);
      border-radius:16px;
      padding:10px;
      box-shadow: 0 10px 22px rgba(2,6,23,.06);
    }
    canvas{width:100%; height:260px; display:block}
    .chart-footer{
      margin-top:8px;
      font-size:11px;
      color:var(--muted);
      line-height:1.35;
    }

    /* Table */
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:16px;
      border:1px solid rgba(229,231,235,.9);
      background: rgba(255,255,255,.88);
      box-shadow: 0 10px 22px rgba(2,6,23,.06);
    }
    th,td{
      padding:10px 10px;
      font-size:12px;
      border-bottom:1px solid rgba(229,231,235,.8);
      text-align:left;
      vertical-align:top;
    }
    th{
      font-size:11px;
      color:var(--muted);
      background: rgba(245,247,251,.9);
      position:sticky;
      top:0;
      z-index:1;
    }
    tr:last-child td{border-bottom:none}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .pill{
      display:inline-flex;
      align-items:center;
      padding:4px 10px;
      border-radius:999px;
      font-size:11px;
      border:1px solid rgba(229,231,235,.95);
      background: rgba(255,255,255,.92);
      color:var(--muted);
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    /* Skeleton */
    .skeleton{
      background: linear-gradient(90deg, rgba(229,231,235,.45), rgba(229,231,235,.85), rgba(229,231,235,.45));
      background-size: 200% 100%;
      animation: shimmer 1.05s infinite linear;
      border-radius:14px;
    }
    @keyframes shimmer{
      0%{background-position: 200% 0}
      100%{background-position: -200% 0}
    }
    .sk-row{height:12px; margin:8px 0}
    .sk-lg{height:18px}
    .hide{display:none !important}

    .footnote{
      margin-top:10px;
      font-size:11px;
      color:var(--muted);
      line-height:1.35;
    }
    .warn{color:#b45309}
    .ok{color:var(--ok)}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <!-- magnifier -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="rgba(29,78,216,.9)" stroke-width="2"/>
            <path d="M16.3 16.3 21 21" stroke="rgba(29,78,216,.9)" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div>
          <h1>ACM Dashboard</h1>
          <p>Filter Area dari <b>CSV ACM</b> + Trend Valid vs Buffer per bulan</p>
        </div>
      </div>

      <div class="nav">
        <div class="tab active" data-page="acm">ACM</div>
        <div class="tab" data-page="sa">Sourcing Analyst</div>
      </div>
    </div>
  </div>

  <div class="wrap">

    <!-- PAGE: ACM -->
    <section id="page-acm">
      <div class="grid">
        <!-- Left: Filters + KPIs + Chart -->
        <div class="card">
          <div class="card-hd">
            <div>
              <h2 class="card-title">Applicant Cycle Management (ACM)</h2>
              <p class="card-sub">
                Dropdown <b>Area</b> diambil dari sumber CSV ACM yang kamu kirim.
                Grafik trend dihitung per bulan dengan parser periode yang lebih kuat (tidak mudah miss).
              </p>
            </div>
            <div class="badge" id="acm-badge">Loading…</div>
          </div>

          <div class="card-bd">

            <div class="filters">
              <div class="filter-group">
                <label class="filter-label">Provinsi</label>
                <div class="ms" id="ms-prov">
                  <button type="button" class="ms-toggle">
                    <span class="ms-placeholder">Semua Provinsi</span>
                    <span class="ms-counter"></span><span class="ms-arrow">▾</span>
                  </button>
                  <div class="ms-panel">
                    <input class="ms-search" type="text" placeholder="Cari provinsi..." />
                    <div class="ms-options"></div><div class="ms-empty">Tidak ada provinsi</div>
                    <div class="ms-actions">
                      <button class="btn" data-action="clear">Clear</button>
                      <button class="btn primary" data-action="close">Tutup</button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="filter-group">
                <label class="filter-label">Kota</label>
                <div class="ms" id="ms-kota">
                  <button type="button" class="ms-toggle">
                    <span class="ms-placeholder">Semua Kota</span>
                    <span class="ms-counter"></span><span class="ms-arrow">▾</span>
                  </button>
                  <div class="ms-panel">
                    <input class="ms-search" type="text" placeholder="Cari kota..." />
                    <div class="ms-options"></div><div class="ms-empty">Tidak ada kota</div>
                    <div class="ms-actions">
                      <button class="btn" data-action="clear">Clear</button>
                      <button class="btn primary" data-action="close">Tutup</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- AREA: from ACM CSV -->
              <div class="filter-group">
                <label class="filter-label">Area</label>
                <div class="ms" id="ms-area">
                  <button type="button" class="ms-toggle">
                    <span class="ms-placeholder">Semua Area</span>
                    <span class="ms-counter"></span><span class="ms-arrow">▾</span>
                  </button>
                  <div class="ms-panel">
                    <input class="ms-search" type="text" placeholder="Cari area..." />
                    <div class="ms-options"></div><div class="ms-empty">Tidak ada area</div>
                    <div class="ms-actions">
                      <button class="btn" data-action="clear">Clear</button>
                      <button class="btn primary" data-action="close">Tutup</button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="filter-group">
                <label class="filter-label">Periode</label>
                <div class="ms" id="ms-periode">
                  <button type="button" class="ms-toggle">
                    <span class="ms-placeholder">Semua Periode</span>
                    <span class="ms-counter"></span><span class="ms-arrow">▾</span>
                  </button>
                  <div class="ms-panel">
                    <input class="ms-search" type="text" placeholder="Cari periode..." />
                    <div class="ms-options"></div><div class="ms-empty">Tidak ada periode</div>
                    <div class="ms-actions">
                      <button class="btn" data-action="clear">Clear</button>
                      <button class="btn primary" data-action="close">Tutup</button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="filter-group">
                <label class="filter-label">Job Parent</label>
                <div class="ms" id="ms-jobparent">
                  <button type="button" class="ms-toggle">
                    <span class="ms-placeholder">Semua Job Parent</span>
                    <span class="ms-counter"></span><span class="ms-arrow">▾</span>
                  </button>
                  <div class="ms-panel">
                    <input class="ms-search" type="text" placeholder="Cari job parent..." />
                    <div class="ms-options"></div><div class="ms-empty">Tidak ada job parent</div>
                    <div class="ms-actions">
                      <button class="btn" data-action="clear">Clear</button>
                      <button class="btn primary" data-action="close">Tutup</button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="filter-group">
                <label class="filter-label">Job Type</label>
                <div class="ms" id="ms-jobtype">
                  <button type="button" class="ms-toggle">
                    <span class="ms-placeholder">Semua Job Type</span>
                    <span class="ms-counter"></span><span class="ms-arrow">▾</span>
                  </button>
                  <div class="ms-panel">
                    <input class="ms-search" type="text" placeholder="Cari job type..." />
                    <div class="ms-options"></div><div class="ms-empty">Tidak ada job type</div>
                    <div class="ms-actions">
                      <button class="btn" data-action="clear">Clear</button>
                      <button class="btn primary" data-action="close">Tutup</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
              <button class="btn primary" id="btn-refresh">Refresh Data</button>
              <button class="btn" id="btn-clear">Clear Semua Filter</button>
              <span class="badge" id="acm-source">Sumber: CSV ACM</span>
            </div>

            <div class="kpis" id="kpi-skeleton">
              <div class="kpi"><div class="skeleton sk-row sk-lg"></div><div class="skeleton sk-row"></div><div class="skeleton sk-row"></div></div>
              <div class="kpi"><div class="skeleton sk-row sk-lg"></div><div class="skeleton sk-row"></div><div class="skeleton sk-row"></div></div>
              <div class="kpi"><div class="skeleton sk-row sk-lg"></div><div class="skeleton sk-row"></div><div class="skeleton sk-row"></div></div>
            </div>

            <div class="kpis hide" id="kpi-real">
              <div class="kpi">
                <div class="label">Total Rows (setelah filter)</div>
                <div class="val" id="kpi-total">0</div>
                <div class="hint">Jumlah baris data ACM yang ikut dihitung</div>
              </div>
              <div class="kpi">
                <div class="label">Applicant Valid</div>
                <div class="val" id="kpi-valid">0</div>
                <div class="hint">Kategori = <span class="pill" id="pill-valid-target">Applicant Valid - CTC 1</span></div>
              </div>
              <div class="kpi">
                <div class="label">Buffer</div>
                <div class="val" id="kpi-buffer">0</div>
                <div class="hint">Qualified = YES <b>dan</b> bukan Valid (non-overlap)</div>
              </div>
            </div>

            <div class="chart-wrap" style="margin-top:12px;">
              <canvas id="trendChart" width="1100" height="320"></canvas>
              <div class="chart-footer" id="chart-summary-text">—</div>
            </div>

            <div class="footnote" id="acm-footnote">
              <span class="muted">Catatan:</span> Jika masih ada data “tidak terhitung”, lihat pesan “PERIODE PELAMAR tidak terbaca” (contoh value akan ditampilkan).
            </div>

          </div>
        </div>

        <!-- Right: Table summary -->
        <div class="card">
          <div class="card-hd">
            <div>
              <h2 class="card-title">Ringkasan Cepat</h2>
              <p class="card-sub">Top 10 Job Parent berdasarkan Valid & Buffer dari data yang sudah terfilter.</p>
            </div>
          </div>
          <div class="card-bd">
            <div id="tbl-skeleton">
              <div class="skeleton sk-row sk-lg"></div>
              <div class="skeleton sk-row"></div>
              <div class="skeleton sk-row"></div>
              <div class="skeleton sk-row"></div>
              <div class="skeleton sk-row"></div>
              <div class="skeleton sk-row"></div>
              <div class="skeleton sk-row"></div>
            </div>

            <div id="tbl-real" class="hide" style="max-height:520px; overflow:auto;">
              <table>
                <thead>
                  <tr>
                    <th style="width:48%">Job Parent</th>
                    <th class="right" style="width:17%">Valid</th>
                    <th class="right" style="width:17%">Buffer</th>
                    <th class="right" style="width:18%">Total</th>
                  </tr>
                </thead>
                <tbody id="summary-tbody"></tbody>
              </table>
            </div>

            <div class="footnote">
              <span class="badge">Tips</span>
              Kalau kamu ingin <b>Buffer overlap dengan Valid</b> (buffer = qualified YES termasuk valid), tinggal bilang—aku ubah definisinya.
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE: SA -->
    <section id="page-sa" class="hide">
      <div class="card">
        <div class="card-hd">
          <div>
            <h2 class="card-title">Sourcing Analyst</h2>
            <p class="card-sub">Insight ringkas berbasis data ACM yang sama (dropdown Area juga dari CSV ACM).</p>
          </div>
          <div class="badge" id="sa-badge">Ready</div>
        </div>

        <div class="card-bd">
          <div class="filters" style="grid-template-columns: repeat(5, minmax(0,1fr));">
            <div class="filter-group">
              <label class="filter-label">Provinsi</label>
              <div class="ms" id="sa-ms-prov">
                <button type="button" class="ms-toggle">
                  <span class="ms-placeholder">Semua Provinsi</span>
                  <span class="ms-counter"></span><span class="ms-arrow">▾</span>
                </button>
                <div class="ms-panel">
                  <input class="ms-search" type="text" placeholder="Cari provinsi..." />
                  <div class="ms-options"></div><div class="ms-empty">Tidak ada provinsi</div>
                  <div class="ms-actions">
                    <button class="btn" data-action="clear">Clear</button>
                    <button class="btn primary" data-action="close">Tutup</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="filter-group">
              <label class="filter-label">Kota</label>
              <div class="ms" id="sa-ms-kota">
                <button type="button" class="ms-toggle">
                  <span class="ms-placeholder">Semua Kota</span>
                  <span class="ms-counter"></span><span class="ms-arrow">▾</span>
                </button>
                <div class="ms-panel">
                  <input class="ms-search" type="text" placeholder="Cari kota..." />
                  <div class="ms-options"></div><div class="ms-empty">Tidak ada kota</div>
                  <div class="ms-actions">
                    <button class="btn" data-action="clear">Clear</button>
                    <button class="btn primary" data-action="close">Tutup</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="filter-group">
              <label class="filter-label">Area</label>
              <div class="ms" id="sa-ms-area">
                <button type="button" class="ms-toggle">
                  <span class="ms-placeholder">Semua Area</span>
                  <span class="ms-counter"></span><span class="ms-arrow">▾</span>
                </button>
                <div class="ms-panel">
                  <input class="ms-search" type="text" placeholder="Cari area..." />
                  <div class="ms-options"></div><div class="ms-empty">Tidak ada area</div>
                  <div class="ms-actions">
                    <button class="btn" data-action="clear">Clear</button>
                    <button class="btn primary" data-action="close">Tutup</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="filter-group">
              <label class="filter-label">Job Parent</label>
              <div class="ms" id="sa-ms-jobparent">
                <button type="button" class="ms-toggle">
                  <span class="ms-placeholder">Semua Job Parent</span>
                  <span class="ms-counter"></span><span class="ms-arrow">▾</span>
                </button>
                <div class="ms-panel">
                  <input class="ms-search" type="text" placeholder="Cari job parent..." />
                  <div class="ms-options"></div><div class="ms-empty">Tidak ada job parent</div>
                  <div class="ms-actions">
                    <button class="btn" data-action="clear">Clear</button>
                    <button class="btn primary" data-action="close">Tutup</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="filter-group">
              <label class="filter-label">Job Type</label>
              <div class="ms" id="sa-ms-jobtype">
                <button type="button" class="ms-toggle">
                  <span class="ms-placeholder">Semua Job Type</span>
                  <span class="ms-counter"></span><span class="ms-arrow">▾</span>
                </button>
                <div class="ms-panel">
                  <input class="ms-search" type="text" placeholder="Cari job type..." />
                  <div class="ms-options"></div><div class="ms-empty">Tidak ada job type</div>
                  <div class="ms-actions">
                    <button class="btn" data-action="clear">Clear</button>
                    <button class="btn primary" data-action="close">Tutup</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
            <button class="btn" id="sa-clear">Clear Filter SA</button>
            <span class="badge">Sumber: CSV ACM</span>
          </div>

          <div class="kpis" style="margin-top:12px;">
            <div class="kpi">
              <div class="label">Rows (filtered)</div>
              <div class="val" id="sa-rows">0</div>
              <div class="hint">Total baris untuk analisa</div>
            </div>
            <div class="kpi">
              <div class="label">Valid Rate</div>
              <div class="val" id="sa-validrate">0%</div>
              <div class="hint">Valid / Total rows</div>
            </div>
            <div class="kpi">
              <div class="label">Qualified Rate</div>
              <div class="val" id="sa-qualrate">0%</div>
              <div class="hint">Qualified YES / Total rows</div>
            </div>
          </div>

          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px;">
            <div class="chart-wrap">
              <div class="badge">Top Job Parent (Valid)</div>
              <div style="margin-top:10px; max-height:260px; overflow:auto;">
                <table>
                  <thead><tr><th>Job Parent</th><th class="right">Valid</th></tr></thead>
                  <tbody id="sa-top-jobparent"></tbody>
                </table>
              </div>
            </div>

            <div class="chart-wrap">
              <div class="badge">Top Area (Valid)</div>
              <div style="margin-top:10px; max-height:260px; overflow:auto;">
                <table>
                  <thead><tr><th>Area</th><th class="right">Valid</th></tr></thead>
                  <tbody id="sa-top-area"></tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="footnote">
            Insight ini mengikuti definisi yang sama dengan ACM:
            <b>Valid</b> = kategori target, <b>Buffer</b> = qualified YES dan bukan valid.
          </div>
        </div>
      </div>
    </section>

  </div>

  <script>
    /********************
     * CONFIG (CSV ACM)
     ********************/
    const CSV_URL_ACM = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ1IRy6uulUDdZtEV05QNMrse9vdqLTn_NDDoi-KgYTkEBV44HZAqAZHqgOQ6m4FwZ59kcQxHm3elhT/pub?gid=1347000673&single=true&output=csv";

    // Default target kategori valid
    const KATEGORI_VALID_TARGET = "Applicant Valid - CTC 1";

    // Month tokens (ID + EN)
    const MONTHS = [
      {idx:1,  name:"Jan", tokens:["JAN","JANUARI","JANUARY"]},
      {idx:2,  name:"Feb", tokens:["FEB","FEBRUARI","FEBRUARY"]},
      {idx:3,  name:"Mar", tokens:["MAR","MARET","MARCH"]},
      {idx:4,  name:"Apr", tokens:["APR","APRIL"]},
      {idx:5,  name:"Mei", tokens:["MEI","MAY"]},
      {idx:6,  name:"Jun", tokens:["JUN","JUNI","JUNE"]},
      {idx:7,  name:"Jul", tokens:["JUL","JULI","JULY"]},
      {idx:8,  name:"Agu", tokens:["AGU","AGUSTUS","AUG","AUGUST"]},
      {idx:9,  name:"Sep", tokens:["SEP","SEPT","SEPTEMBER"]},
      {idx:10, name:"Okt", tokens:["OKT","OKTOBER","OCT","OCTOBER"]},
      {idx:11, name:"Nov", tokens:["NOV","NOVEMBER"]},
      {idx:12, name:"Des", tokens:["DES","DESEMBER","DEC","DECEMBER"]},
    ];

    /********************
     * STATE
     ********************/
    let acmRows = [];
    let acmFields = [];

    // Column mapping (auto-detect)
    let COL_PERIODE   = "PERIODE PELAMAR";
    let COL_PROV      = "PROVINSI";
    let COL_KOTA      = "KOTA";
    let COL_AREA      = "AREA";
    let COL_JOBPARENT = "JOB PARENT";
    let COL_JOBTYPE   = "JOB TYPE";
    let COL_KATEGORI  = "KATEGORI APP";
    let COL_QUALIFIED = "QUALIFIED";

    // Multi-select instances
    let msProv, msKota, msArea, msPeriode, msJobParent, msJobType;
    let saProvMS, saKotaMS, saAreaMS, saJobParentMS, saJobTypeMS;

    /********************
     * HELPERS
     ********************/
    const $ = (id)=>document.getElementById(id);

    function trimStr(v){
      return String(v ?? "").trim();
    }
    function norm(v){
      return trimStr(v).toUpperCase();
    }
    function safeNum(n){ return Number.isFinite(n) ? n : 0; }

    function uniqueSorted(arr){
      const set = new Set();
      arr.forEach(v=>{
        const t = trimStr(v);
        if(t) set.add(t);
      });
      return Array.from(set).sort((a,b)=>a.localeCompare(b,"id"));
    }

    function findField(fields, candidates){
      const fU = fields.map(x=>String(x||"").trim().toUpperCase());
      for(const cand of candidates){
        const cU = String(cand).trim().toUpperCase();
        const idx = fU.indexOf(cU);
        if(idx !== -1) return fields[idx];
      }
      // fuzzy contains
      for(const cand of candidates){
        const cU = String(cand).trim().toUpperCase();
        const idx = fU.findIndex(x=>x.includes(cU));
        if(idx !== -1) return fields[idx];
      }
      return null;
    }

    function detectACMColumns(fields){
      // periode
      const periode = findField(fields, ["PERIODE PELAMAR","PERIODE","TANGGAL","DATE","SUBMIT DATE","CREATED"]);
      if(periode) COL_PERIODE = periode;

      const prov = findField(fields, ["PROVINSI","PROVINCE"]);
      if(prov) COL_PROV = prov;

      const kota = findField(fields, ["KOTA","CITY","KABUPATEN","KAB/KOTA"]);
      if(kota) COL_KOTA = kota;

      const area = findField(fields, ["AREA","CABANG","BRANCH","PENEMPATAN","LOKASI CABANG","AREA KERJA","PLACEMENT"]);
      if(area) COL_AREA = area;

      const jp = findField(fields, ["JOB PARENT","JOBPARENT","PARENT JOB","JOB FAMILY","FUNCTION"]);
      if(jp) COL_JOBPARENT = jp;

      const jt = findField(fields, ["JOB TYPE","JOBTYPE","POSITION","ROLE","JABATAN"]);
      if(jt) COL_JOBTYPE = jt;

      const kat = findField(fields, ["KATEGORI APP","KATEGORI","CATEGORY","STATUS","STATUS APP"]);
      if(kat) COL_KATEGORI = kat;

      const q = findField(fields, ["QUALIFIED","QUALIFIED?","QUALIFIED STATUS","QUALIFIED (Y/N)"]);
      if(q) COL_QUALIFIED = q;
    }

    // robust month parsing
    function parseMonthIndex(periodStr){
      const raw = String(periodStr ?? "").trim();
      if(!raw) return null;
      const sU = raw.toUpperCase();

      // 1) tokens month names
      for(const m of MONTHS){
        if(m.tokens.some(t=>sU.includes(t))) return m.idx;
      }

      // 2) YYYY-MM-DD / YYYY/MM / YYYY.MM
      let m = sU.match(/\b(\d{4})[.\-\/](0?[1-9]|1[0-2])([.\-\/](0?[1-9]|[12]\d|3[01]))?\b/);
      if(m) return Number(m[2]);

      // 3) MM-YYYY / MM/YYYY
      m = sU.match(/\b(0?[1-9]|1[0-2])[.\-\/](\d{4})\b/);
      if(m) return Number(m[1]);

      // 4) 202601 or 2026 01
      m = sU.match(/\b(\d{4})\s*(0[1-9]|1[0-2])\b/);
      if(m) return Number(m[2]);

      // 5) 01 2026
      m = sU.match(/\b(0[1-9]|1[0-2])\s*(\d{4})\b/);
      if(m) return Number(m[1]);

      return null;
    }

    function isKategoriValid(row){
      const s = norm(row[COL_KATEGORI]).replace(/\s+/g," ").trim();
      const t = norm(KATEGORI_VALID_TARGET).replace(/\s+/g," ").trim();
      return s === t;
    }

    function isQualifiedYes(row){
      const s = norm(row[COL_QUALIFIED]).replace(/\s+/g," ").trim();
      return ["YES","YA","Y","TRUE","1"].includes(s);
    }

    function getValidFlag(row){
      return isKategoriValid(row) ? 1 : 0;
    }

    // Non-overlap buffer: qualified YES AND not valid
    function getBufferFlag(row){
      return (isQualifiedYes(row) && !isKategoriValid(row)) ? 1 : 0;
    }

    function fmtInt(n){
      const x = Math.round(Number(n||0));
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    /********************
     * CSV LOADER (cache)
     ********************/
    async function loadCsvCached(url, cacheKey, ttlMs=5*60*1000){
      const now = Date.now();
      try{
        const cached = localStorage.getItem(cacheKey);
        if(cached){
          const obj = JSON.parse(cached);
          if(obj && obj.ts && (now - obj.ts) < ttlMs && obj.data){
            return obj.data;
          }
        }
      }catch(e){}

      const data = await new Promise((resolve,reject)=>{
        Papa.parse(url, {
          download:true,
          header:true,
          skipEmptyLines:true,
          dynamicTyping:false,
          complete:(res)=>resolve(res),
          error:(err)=>reject(err)
        });
      });

      try{
        localStorage.setItem(cacheKey, JSON.stringify({ts: now, data}));
      }catch(e){}

      return data;
    }

    /********************
     * MULTI SELECT
     ********************/
    function createMultiSelect(rootId, items, placeholderText, preselectAll=false, onChange=()=>{}){
      const root = $(rootId);
      const toggle = root.querySelector(".ms-toggle");
      const placeholder = root.querySelector(".ms-placeholder");
      const counter = root.querySelector(".ms-counter");
      const panel = root.querySelector(".ms-panel");
      const search = root.querySelector(".ms-search");
      const optionsEl = root.querySelector(".ms-options");
      const emptyEl = root.querySelector(".ms-empty");
      const btnClear = root.querySelector('[data-action="clear"]');
      const btnClose = root.querySelector('[data-action="close"]');

      let all = (items||[]).map(x=>trimStr(x)).filter(Boolean);
      let selected = new Set();

      function render(list){
        optionsEl.innerHTML = "";
        let shown = 0;
        list.forEach(val=>{
          const row = document.createElement("div");
          row.className = "ms-opt";
          row.dataset.value = val;

          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.checked = selected.has(val);

          const sp = document.createElement("span");
          sp.textContent = val;

          row.appendChild(cb);
          row.appendChild(sp);

          row.addEventListener("click", (e)=>{
            // allow click anywhere
            if(selected.has(val)) selected.delete(val);
            else selected.add(val);
            cb.checked = selected.has(val);
            syncHeader();
            onChange();
          });

          optionsEl.appendChild(row);
          shown++;
        });

        emptyEl.style.display = shown ? "none" : "block";
      }

      function syncHeader(){
        const selCount = selected.size;
        if(selCount === 0){
          placeholder.textContent = placeholderText;
          counter.style.display = "none";
        }else if(selCount === 1){
          const only = Array.from(selected)[0];
          placeholder.textContent = only;
          counter.style.display = "none";
        }else{
          placeholder.textContent = placeholderText;
          counter.textContent = selCount + " dipilih";
          counter.style.display = "inline-flex";
        }
      }

      function setItems(newItems){
        all = (newItems||[]).map(x=>trimStr(x)).filter(Boolean);
        // drop selections not in list
        const setAll = new Set(all);
        selected = new Set(Array.from(selected).filter(x=>setAll.has(x)));
        syncHeader();
        applySearch();
      }

      function applySearch(){
        const q = norm(search.value);
        const list = !q ? all : all.filter(x=>norm(x).includes(q));
        render(list);
      }

      function open(){
        root.classList.add("open");
        search.value = "";
        applySearch();
        setTimeout(()=>search.focus(), 0);
      }
      function close(){
        root.classList.remove("open");
      }

      toggle.addEventListener("click", ()=>{
        root.classList.contains("open") ? close() : open();
      });
      btnClose && btnClose.addEventListener("click", close);
      btnClear && btnClear.addEventListener("click", ()=>{
        selected.clear();
        syncHeader();
        applySearch();
        onChange();
      });
      search.addEventListener("input", applySearch);

      // click outside close
      document.addEventListener("click", (e)=>{
        if(!root.contains(e.target)) close();
      });

      if(preselectAll){
        all.forEach(v=>selected.add(v));
      }
      syncHeader();
      render(all);

      return {
        getSelected: ()=>Array.from(selected),
        setSelected: (arr)=>{
          selected = new Set((arr||[]).map(trimStr).filter(Boolean));
          syncHeader();
          applySearch();
          onChange();
        },
        setItems,
        clear: ()=>{
          selected.clear(); syncHeader(); applySearch(); onChange();
        }
      };
    }

    /********************
     * FILTERED ROWS
     ********************/
    function getFilteredACMRows(){
      const provSel = new Set(msProv ? msProv.getSelected() : []);
      const kotaSel = new Set(msKota ? msKota.getSelected() : []);
      const areaSel = new Set(msArea ? msArea.getSelected() : []);
      const perSel  = new Set(msPeriode ? msPeriode.getSelected() : []);
      const jpSel   = new Set(msJobParent ? msJobParent.getSelected() : []);
      const jtSel   = new Set(msJobType ? msJobType.getSelected() : []);

      return acmRows.filter(r=>{
        const pv = trimStr(r[COL_PROV]);
        const kt = trimStr(r[COL_KOTA]);
        const ar = trimStr(r[COL_AREA]);
        const pe = trimStr(r[COL_PERIODE]);
        const jp = trimStr(r[COL_JOBPARENT]);
        const jt = trimStr(r[COL_JOBTYPE]);

        if(provSel.size && !provSel.has(pv)) return false;
        if(kotaSel.size && !kotaSel.has(kt)) return false;
        if(areaSel.size && !areaSel.has(ar)) return false;
        if(perSel.size && !perSel.has(pe)) return false;
        if(jpSel.size && !jpSel.has(jp)) return false;
        if(jtSel.size && !jtSel.has(jt)) return false;

        return true;
      });
    }

    function getSAFilteredRows(){
      const provSel = new Set(saProvMS ? saProvMS.getSelected() : []);
      const kotaSel = new Set(saKotaMS ? saKotaMS.getSelected() : []);
      const areaSel = new Set(saAreaMS ? saAreaMS.getSelected() : []);
      const jpSel   = new Set(saJobParentMS ? saJobParentMS.getSelected() : []);
      const jtSel   = new Set(saJobTypeMS ? saJobTypeMS.getSelected() : []);

      return acmRows.filter(r=>{
        const pv = trimStr(r[COL_PROV]);
        const kt = trimStr(r[COL_KOTA]);
        const ar = trimStr(r[COL_AREA]);
        const jp = trimStr(r[COL_JOBPARENT]);
        const jt = trimStr(r[COL_JOBTYPE]);

        if(provSel.size && !provSel.has(pv)) return false;
        if(kotaSel.size && !kotaSel.has(kt)) return false;
        if(areaSel.size && !areaSel.has(ar)) return false;
        if(jpSel.size && !jpSel.has(jp)) return false;
        if(jtSel.size && !jtSel.has(jt)) return false;

        return true;
      });
    }

    /********************
     * DEPENDENT OPTIONS
     ********************/
    function updateDependentOptions(){
      // Make options “cascade”: kota/area/jobparent/jobtype/periode adapt to current selections.
      const provSel = new Set(msProv.getSelected());
      const kotaSel = new Set(msKota.getSelected());
      const areaSel = new Set(msArea.getSelected());
      const jpSel   = new Set(msJobParent.getSelected());
      const jtSel   = new Set(msJobType.getSelected());
      const perSel  = new Set(msPeriode.getSelected());

      // Helper that filters rows by partial selection
      const rows = acmRows.filter(r=>{
        const pv = trimStr(r[COL_PROV]);
        const kt = trimStr(r[COL_KOTA]);
        const ar = trimStr(r[COL_AREA]);
        const jp = trimStr(r[COL_JOBPARENT]);
        const jt = trimStr(r[COL_JOBTYPE]);
        const pe = trimStr(r[COL_PERIODE]);

        if(provSel.size && !provSel.has(pv)) return false;
        if(kotaSel.size && !kotaSel.has(kt)) return false;
        if(areaSel.size && !areaSel.has(ar)) return false;
        if(jpSel.size && !jpSel.has(jp)) return false;
        if(jtSel.size && !jtSel.has(jt)) return false;
        if(perSel.size && !perSel.has(pe)) return false;
        return true;
      });

      // Recompute available options from rows
      const kotaVals = uniqueSorted(rows.map(r=>r[COL_KOTA]));
      const areaVals = uniqueSorted(rows.map(r=>r[COL_AREA]));
      const perVals  = uniqueSorted(rows.map(r=>r[COL_PERIODE]));
      const jpVals   = uniqueSorted(rows.map(r=>r[COL_JOBPARENT]));
      const jtVals   = uniqueSorted(rows.map(r=>r[COL_JOBTYPE]));

      // Important: Provinsi should always be from full data (so user can start anywhere)
      const provVals = uniqueSorted(acmRows.map(r=>r[COL_PROV]));

      msProv.setItems(provVals);
      msKota.setItems(kotaVals);
      msArea.setItems(areaVals);
      msPeriode.setItems(perVals);
      msJobParent.setItems(jpVals);
      msJobType.setItems(jtVals);
    }

    function updateDependentOptionsSA(){
      const provSel = new Set(saProvMS.getSelected());
      const kotaSel = new Set(saKotaMS.getSelected());
      const areaSel = new Set(saAreaMS.getSelected());
      const jpSel   = new Set(saJobParentMS.getSelected());
      const jtSel   = new Set(saJobTypeMS.getSelected());

      const rows = acmRows.filter(r=>{
        const pv = trimStr(r[COL_PROV]);
        const kt = trimStr(r[COL_KOTA]);
        const ar = trimStr(r[COL_AREA]);
        const jp = trimStr(r[COL_JOBPARENT]);
        const jt = trimStr(r[COL_JOBTYPE]);

        if(provSel.size && !provSel.has(pv)) return false;
        if(kotaSel.size && !kotaSel.has(kt)) return false;
        if(areaSel.size && !areaSel.has(ar)) return false;
        if(jpSel.size && !jpSel.has(jp)) return false;
        if(jtSel.size && !jtSel.has(jt)) return false;
        return true;
      });

      const provVals = uniqueSorted(acmRows.map(r=>r[COL_PROV]));
      const kotaVals = uniqueSorted(rows.map(r=>r[COL_KOTA]));
      const areaVals = uniqueSorted(rows.map(r=>r[COL_AREA]));
      const jpVals   = uniqueSorted(rows.map(r=>r[COL_JOBPARENT]));
      const jtVals   = uniqueSorted(rows.map(r=>r[COL_JOBTYPE]));

      saProvMS.setItems(provVals);
      saKotaMS.setItems(kotaVals);
      saAreaMS.setItems(areaVals);
      saJobParentMS.setItems(jpVals);
      saJobTypeMS.setItems(jtVals);
    }

    /********************
     * RENDER: KPI + TABLE + CHART
     ********************/
    function updateACMAll(){
      // update cascade first, then render based on filtered rows
      updateDependentOptions();
      const rows = getFilteredACMRows();

      // KPI
      const total = rows.length;
      let valid=0, buffer=0;
      rows.forEach(r=>{
        valid += getValidFlag(r);
        buffer += getBufferFlag(r);
      });

      $("kpi-total").textContent = fmtInt(total);
      $("kpi-valid").textContent = fmtInt(valid);
      $("kpi-buffer").textContent = fmtInt(buffer);
      $("pill-valid-target").textContent = KATEGORI_VALID_TARGET;

      // Badge
      $("acm-badge").textContent = `Rows: ${fmtInt(total)} • Valid: ${fmtInt(valid)} • Buffer: ${fmtInt(buffer)}`;

      // Trend Chart
      renderMonthlyTrend(rows);

      // Summary table (top job parent)
      renderSummaryTable(rows);

      // show real
      $("kpi-skeleton").classList.add("hide");
      $("kpi-real").classList.remove("hide");
      $("tbl-skeleton").classList.add("hide");
      $("tbl-real").classList.remove("hide");
    }

    function renderSummaryTable(rows){
      const map = new Map(); // jobParent -> {v,b,t}
      rows.forEach(r=>{
        const jp = trimStr(r[COL_JOBPARENT]) || "(blank)";
        const v = getValidFlag(r);
        const b = getBufferFlag(r);
        const cur = map.get(jp) || {v:0,b:0,t:0};
        cur.v += v; cur.b += b; cur.t += 1;
        map.set(jp, cur);
      });

      const arr = Array.from(map.entries())
        .map(([k,obj])=>({jobparent:k, ...obj}))
        .sort((a,b)=>(b.v+b.b) - (a.v+a.b))
        .slice(0, 10);

      const tb = $("summary-tbody");
      tb.innerHTML = "";
      if(arr.length===0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="4" class="muted">Tidak ada data</td>`;
        tb.appendChild(tr);
        return;
      }

      arr.forEach(x=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><span class="pill" title="${escapeHtml(x.jobparent)}">${escapeHtml(x.jobparent)}</span></td>
          <td class="right">${fmtInt(x.v)}</td>
          <td class="right">${fmtInt(x.b)}</td>
          <td class="right">${fmtInt(x.t)}</td>
        `;
        tb.appendChild(tr);
      });
    }

    function renderMonthlyTrend(rows){
      const months = MONTHS.map(m=>m.name);
      const validArr = new Array(12).fill(0);
      const bufferArr = new Array(12).fill(0);

      let skipped=0;
      const skippedSamples = [];

      rows.forEach(r=>{
        const mi = parseMonthIndex(r[COL_PERIODE]);
        if(!mi){
          skipped++;
          if(skippedSamples.length < 5) skippedSamples.push(trimStr(r[COL_PERIODE]));
          return;
        }
        const idx = mi - 1;
        if(idx<0 || idx>11) return;

        validArr[idx] += getValidFlag(r);
        bufferArr[idx] += getBufferFlag(r);
      });

      drawBarsTwoSeries($("trendChart"), months, validArr, bufferArr);

      const msg =
        skipped>0
          ? `Catatan: ${fmtInt(skipped)} baris dilewati karena PERIODE PELAMAR tidak terbaca. Contoh: ${skippedSamples.filter(Boolean).join(" | ")}`
          : `Periode terbaca dengan baik untuk seluruh data terfilter.`;

      $("chart-summary-text").textContent = msg;
    }

    function updateSourcingAnalyst(){
      updateDependentOptionsSA();
      const rows = getSAFilteredRows();

      const total = rows.length;
      let valid=0, qualified=0;

      rows.forEach(r=>{
        valid += getValidFlag(r);
        qualified += isQualifiedYes(r) ? 1 : 0;
      });

      const validRate = total ? (valid/total*100) : 0;
      const qualRate  = total ? (qualified/total*100) : 0;

      $("sa-rows").textContent = fmtInt(total);
      $("sa-validrate").textContent = validRate.toFixed(1) + "%";
      $("sa-qualrate").textContent = qualRate.toFixed(1) + "%";
      $("sa-badge").textContent = `Rows: ${fmtInt(total)} • Valid: ${fmtInt(valid)}`;

      // top jobparent valid
      const jpMap = new Map();
      const arMap = new Map();
      rows.forEach(r=>{
        if(getValidFlag(r)){
          const jp = trimStr(r[COL_JOBPARENT]) || "(blank)";
          const ar = trimStr(r[COL_AREA]) || "(blank)";
          jpMap.set(jp, (jpMap.get(jp)||0)+1);
          arMap.set(ar, (arMap.get(ar)||0)+1);
        }
      });

      fillTopTable("sa-top-jobparent", jpMap, 10);
      fillTopTable("sa-top-area", arMap, 10);
    }

    function fillTopTable(tbodyId, map, limit){
      const tb = $(tbodyId);
      tb.innerHTML = "";
      const arr = Array.from(map.entries())
        .map(([k,v])=>({k,v}))
        .sort((a,b)=>b.v - a.v)
        .slice(0, limit);

      if(arr.length===0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="muted">Tidak ada data</td><td class="right muted">0</td>`;
        tb.appendChild(tr);
        return;
      }
      arr.forEach(x=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td><span class="pill" title="${escapeHtml(x.k)}">${escapeHtml(x.k)}</span></td><td class="right">${fmtInt(x.v)}</td>`;
        tb.appendChild(tr);
      });
    }

    /********************
     * CANVAS CHART (2 series)
     * - No hardcoded colors? We keep minimal neutral strokes; still readable.
     ********************/
    function drawBarsTwoSeries(canvas, labels, a, b){
      const ctx = canvas.getContext("2d");

      // device pixel ratio
      const dpr = window.devicePixelRatio || 1;
      const cssW = canvas.clientWidth;
      const cssH = canvas.clientHeight;
      canvas.width = Math.floor(cssW * dpr);
      canvas.height = Math.floor(cssH * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);

      // layout
      const W = cssW, H = cssH;
      ctx.clearRect(0,0,W,H);

      const padL = 42, padR = 14, padT = 12, padB = 34;
      const innerW = W - padL - padR;
      const innerH = H - padT - padB;

      const maxV = Math.max(1, ...a, ...b);

      // grid
      ctx.strokeStyle = "rgba(229,231,235,.9)";
      ctx.lineWidth = 1;
      for(let i=0;i<=4;i++){
        const y = padT + (innerH * i/4);
        ctx.beginPath();
        ctx.moveTo(padL, y);
        ctx.lineTo(W - padR, y);
        ctx.stroke();
      }

      // axis labels
      ctx.fillStyle = "rgba(100,116,139,.95)";
      ctx.font = "11px Montserrat, sans-serif";
      for(let i=0;i<=4;i++){
        const val = Math.round(maxV * (1 - i/4));
        const y = padT + (innerH * i/4);
        ctx.fillText(String(val), 6, y + 4);
      }

      // bars
      const n = labels.length;
      const groupW = innerW / n;
      const barW = Math.max(6, Math.min(18, groupW * 0.22));
      const gap = Math.max(4, Math.min(10, groupW * 0.10));
      const groupPad = (groupW - (2*barW + gap)) / 2;

      for(let i=0;i<n;i++){
        const x0 = padL + i*groupW + groupPad;

        const ha = innerH * (a[i]/maxV);
        const hb = innerH * (b[i]/maxV);

        // Valid: outline navy, soft fill
        ctx.fillStyle = "rgba(29,78,216,.18)";
        ctx.strokeStyle = "rgba(29,78,216,.75)";
        ctx.lineWidth = 1;

        ctx.beginPath();
        roundRect(ctx, x0, padT + (innerH - ha), barW, ha, 8);
        ctx.fill();
        ctx.stroke();

        // Buffer: outline orange, soft fill
        ctx.fillStyle = "rgba(249,115,22,.18)";
        ctx.strokeStyle = "rgba(249,115,22,.78)";

        ctx.beginPath();
        roundRect(ctx, x0 + barW + gap, padT + (innerH - hb), barW, hb, 8);
        ctx.fill();
        ctx.stroke();

        // x labels
        ctx.fillStyle = "rgba(100,116,139,.95)";
        ctx.font = "11px Montserrat, sans-serif";
        const lx = padL + i*groupW + groupW/2;
        ctx.textAlign = "center";
        ctx.fillText(labels[i], lx, H - 12);
        ctx.textAlign = "left";
      }

      // legend
      ctx.textAlign = "left";
      ctx.font = "12px Montserrat, sans-serif";
      ctx.fillStyle = "rgba(15,23,42,.92)";
      const ly = 16;
      // valid legend
      ctx.strokeStyle = "rgba(29,78,216,.75)";
      ctx.fillStyle = "rgba(29,78,216,.18)";
      ctx.lineWidth = 1;
      ctx.beginPath(); roundRect(ctx, W-220, ly-10, 14, 10, 3); ctx.fill(); ctx.stroke();
      ctx.fillStyle = "rgba(15,23,42,.9)";
      ctx.fillText("Valid", W-200, ly);

      // buffer legend
      ctx.strokeStyle = "rgba(249,115,22,.78)";
      ctx.fillStyle = "rgba(249,115,22,.18)";
      ctx.beginPath(); roundRect(ctx, W-150, ly-10, 14, 10, 3); ctx.fill(); ctx.stroke();
      ctx.fillStyle = "rgba(15,23,42,.9)";
      ctx.fillText("Buffer", W-130, ly);
    }

    function roundRect(ctx, x, y, w, h, r){
      const rr = Math.min(r, w/2, h/2);
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
    }

    function escapeHtml(s){
      return String(s??"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /********************
     * INIT
     ********************/
    function initTabs(){
      document.querySelectorAll(".tab").forEach(tab=>{
        tab.addEventListener("click", ()=>{
          document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
          tab.classList.add("active");
          const page = tab.dataset.page;

          $("page-acm").classList.toggle("hide", page!=="acm");
          $("page-sa").classList.toggle("hide", page!=="sa");

          // chart resize redraw
          if(page==="acm") updateACMAll();
          if(page==="sa") updateSourcingAnalyst();
        });
      });
    }

    function initACMFilters(){
      const provVals = uniqueSorted(acmRows.map(r=>r[COL_PROV]));
      const kotaVals = uniqueSorted(acmRows.map(r=>r[COL_KOTA]));
      const areaVals = uniqueSorted(acmRows.map(r=>r[COL_AREA]));
      const perVals  = uniqueSorted(acmRows.map(r=>r[COL_PERIODE]));
      const jpVals   = uniqueSorted(acmRows.map(r=>r[COL_JOBPARENT]));
      const jtVals   = uniqueSorted(acmRows.map(r=>r[COL_JOBTYPE]));

      msProv = createMultiSelect("ms-prov", provVals, "Semua Provinsi", false, updateACMAll);
      msKota = createMultiSelect("ms-kota", kotaVals, "Semua Kota", false, updateACMAll);
      msArea = createMultiSelect("ms-area", areaVals, "Semua Area", false, updateACMAll);
      msPeriode = createMultiSelect("ms-periode", perVals, "Semua Periode", false, updateACMAll);
      msJobParent = createMultiSelect("ms-jobparent", jpVals, "Semua Job Parent", false, updateACMAll);
      msJobType = createMultiSelect("ms-jobtype", jtVals, "Semua Job Type", false, updateACMAll);

      $("btn-clear").addEventListener("click", ()=>{
        msProv.clear();
        msKota.clear();
        msArea.clear();
        msPeriode.clear();
        msJobParent.clear();
        msJobType.clear();
      });

      $("btn-refresh").addEventListener("click", async ()=>{
        // force refresh cache by clearing key
        try{ localStorage.removeItem("acm_csv_cache_v1"); }catch(e){}
        await boot();
      });
    }

    function initSAFilters(){
      const provVals = uniqueSorted(acmRows.map(r=>r[COL_PROV]));
      const kotaVals = uniqueSorted(acmRows.map(r=>r[COL_KOTA]));
      const areaVals = uniqueSorted(acmRows.map(r=>r[COL_AREA]));
      const jpVals   = uniqueSorted(acmRows.map(r=>r[COL_JOBPARENT]));
      const jtVals   = uniqueSorted(acmRows.map(r=>r[COL_JOBTYPE]));

      saProvMS = createMultiSelect("sa-ms-prov", provVals, "Semua Provinsi", false, updateSourcingAnalyst);
      saKotaMS = createMultiSelect("sa-ms-kota", kotaVals, "Semua Kota", false, updateSourcingAnalyst);
      saAreaMS = createMultiSelect("sa-ms-area", areaVals, "Semua Area", false, updateSourcingAnalyst);
      saJobParentMS = createMultiSelect("sa-ms-jobparent", jpVals, "Semua Job Parent", false, updateSourcingAnalyst);
      saJobTypeMS = createMultiSelect("sa-ms-jobtype", jtVals, "Semua Job Type", false, updateSourcingAnalyst);

      $("sa-clear").addEventListener("click", ()=>{
        saProvMS.clear();
        saKotaMS.clear();
        saAreaMS.clear();
        saJobParentMS.clear();
        saJobTypeMS.clear();
      });
    }

    async function boot(){
      // reset UI to skeleton
      $("kpi-skeleton").classList.remove("hide");
      $("kpi-real").classList.add("hide");
      $("tbl-skeleton").classList.remove("hide");
      $("tbl-real").classList.add("hide");
      $("acm-badge").textContent = "Loading…";
      $("chart-summary-text").textContent = "—";

      // Load CSV
      const res = await loadCsvCached(CSV_URL_ACM, "acm_csv_cache_v1", 4*60*1000);
      acmRows = (res.data || []).filter(r=>r && Object.keys(r).length);
      acmFields = res.meta && res.meta.fields ? res.meta.fields : Object.keys(acmRows[0]||{});

      detectACMColumns(acmFields);

      $("acm-source").textContent = `Sumber: CSV ACM • Rows raw: ${fmtInt(acmRows.length)}`;
      $("acm-badge").textContent = `Loaded: ${fmtInt(acmRows.length)} rows`;

      // init filters once
      if(!msProv){
        initACMFilters();
        initSAFilters();
      }else{
        // update items after refresh
        initACMFilters(); // safe: will rebind? Not desired. So we won't reinit.
      }

      // Because initACMFilters creates MS instances; if already exists, reload page is simplest.
      // To keep stable, we only init once; on refresh button we call boot(), so if msProv exists, force reload.
      // We'll detect that here:
      if(msProv){
        // If already initialized, just update items
        const provVals = uniqueSorted(acmRows.map(r=>r[COL_PROV]));
        const kotaVals = uniqueSorted(acmRows.map(r=>r[COL_KOTA]));
        const areaVals = uniqueSorted(acmRows.map(r=>r[COL_AREA]));
        const perVals  = uniqueSorted(acmRows.map(r=>r[COL_PERIODE]));
        const jpVals   = uniqueSorted(acmRows.map(r=>r[COL_JOBPARENT]));
        const jtVals   = uniqueSorted(acmRows.map(r=>r[COL_JOBTYPE]));

        msProv.setItems(provVals);
        msKota.setItems(kotaVals);
        msArea.setItems(areaVals);
        msPeriode.setItems(perVals);
        msJobParent.setItems(jpVals);
        msJobType.setItems(jtVals);

        saProvMS.setItems(provVals);
        saKotaMS.setItems(kotaVals);
        saAreaMS.setItems(areaVals);
        saJobParentMS.setItems(jpVals);
        saJobTypeMS.setItems(jtVals);
      }

      // render
      updateACMAll();
      updateSourcingAnalyst();
    }

    // Prevent double init of MS components on boot()
    function initACMFilters(){
      if(msProv) return;
      const provVals = uniqueSorted(acmRows.map(r=>r[COL_PROV]));
      const kotaVals = uniqueSorted(acmRows.map(r=>r[COL_KOTA]));
      const areaVals = uniqueSorted(acmRows.map(r=>r[COL_AREA]));
      const perVals  = uniqueSorted(acmRows.map(r=>r[COL_PERIODE]));
      const jpVals   = uniqueSorted(acmRows.map(r=>r[COL_JOBPARENT]));
      const jtVals   = uniqueSorted(acmRows.map(r=>r[COL_JOBTYPE]));

      msProv = createMultiSelect("ms-prov", provVals, "Semua Provinsi", false, updateACMAll);
      msKota = createMultiSelect("ms-kota", kotaVals, "Semua Kota", false, updateACMAll);
      msArea = createMultiSelect("ms-area", areaVals, "Semua Area", false, updateACMAll);
      msPeriode = createMultiSelect("ms-periode", perVals, "Semua Periode", false, updateACMAll);
      msJobParent = createMultiSelect("ms-jobparent", jpVals, "Semua Job Parent", false, updateACMAll);
      msJobType = createMultiSelect("ms-jobtype", jtVals, "Semua Job Type", false, updateACMAll);

      $("btn-clear").addEventListener("click", ()=>{
        msProv.clear(); msKota.clear(); msArea.clear(); msPeriode.clear(); msJobParent.clear(); msJobType.clear();
      });

      $("btn-refresh").addEventListener("click", async ()=>{
        try{ localStorage.removeItem("acm_csv_cache_v1"); }catch(e){}
        // simplest stable: hard reload
        location.reload();
      });
    }

    function initSAFilters(){
      if(saProvMS) return;
      const provVals = uniqueSorted(acmRows.map(r=>r[COL_PROV]));
      const kotaVals = uniqueSorted(acmRows.map(r=>r[COL_KOTA]));
      const areaVals = uniqueSorted(acmRows.map(r=>r[COL_AREA]));
      const jpVals   = uniqueSorted(acmRows.map(r=>r[COL_JOBPARENT]));
      const jtVals   = uniqueSorted(acmRows.map(r=>r[COL_JOBTYPE]));

      saProvMS = createMultiSelect("sa-ms-prov", provVals, "Semua Provinsi", false, updateSourcingAnalyst);
      saKotaMS = createMultiSelect("sa-ms-kota", kotaVals, "Semua Kota", false, updateSourcingAnalyst);
      saAreaMS = createMultiSelect("sa-ms-area", areaVals, "Semua Area", false, updateSourcingAnalyst);
      saJobParentMS = createMultiSelect("sa-ms-jobparent", jpVals, "Semua Job Parent", false, updateSourcingAnalyst);
      saJobTypeMS = createMultiSelect("sa-ms-jobtype", jtVals, "Semua Job Type", false, updateSourcingAnalyst);

      $("sa-clear").addEventListener("click", ()=>{
        saProvMS.clear(); saKotaMS.clear(); saAreaMS.clear(); saJobParentMS.clear(); saJobTypeMS.clear();
      });
    }

    // Responsive redraw on resize
    window.addEventListener("resize", ()=>{
      if(!$("page-acm").classList.contains("hide")){
        const rows = getFilteredACMRows();
        renderMonthlyTrend(rows);
      }
    });

    // boot
    initTabs();
    boot().catch(err=>{
      console.error(err);
      $("acm-badge").textContent = "Gagal load data";
      $("chart-summary-text").textContent = "Periksa koneksi / akses CSV / publish sheet.";
    });
  </script>
</body>
</html>
